cscope 15 D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source"               0000186461
	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\comm.c

1 
	~"comm.h
"

7 
CommHódî_T
 
	gcomm_hódî
[ 
MAX_COMM_ID
 ];

10 
CommHódî_T
 
	$GëCommHódî
–
U8
 
id
 )

13  
comm_hódî
[ 
id
 ];

14 
	}
}

16 
	$SëCommHódî
–
U8
 
id
, 
CommHódî_T
 
vÆ
 )

19 
comm_hódî
[ 
id
 ] = 
vÆ
;

20 
	}
}

27 
I16
 
	$CommSídPackë
–
U8
 
id
, U8 *
£nd_pkt
 , 
I16
 
Àn
 )

29 
U8
 
i
;

32 if–
	`HAL_IsFuŒSídBuf„r
–
id
 ) !
TRUE
 )

34  
i
 = 0 ; i < 
Àn
 ; i++ )

36 
	`HAL_SëSídBuf„r
–
id
, 
£nd_pkt
[ 
i
 ] );

39 
	`HAL_SídByã
–
id
 );

40  
Àn
;

44 
	}
}

50 
I8
 
	$CommRecvPackë
–
U8
 
id
 , U8 *
ªcv_pkt
 )

52 
U16
 
i
;

53 
I16
 
Àn
;

55 if–
	`HAL_IsEm±yRecvBuf„r
–
id
 ) !
TRUE
 )

57 
Àn
 = 
	`HAL_GëRecvLígth
–
id
 );

58  
i
 = 0; i < 
Àn
 ; i++ )

60 
ªcv_pkt
[ 
i
 ] = 
	`HAL_GëRecvBuf„r
–
id
, i );

63  
Àn
;

67 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\comm.h

1 #i‚de‡
__COMM_H__


2 
	#__COMM_H__


	)

4 
	~"¥j_ty≥.h
"

5 
	~"hÆ_£rül.h
"

7 
	#COMM_ID_TOF
 
COMM_ID_UART_1


	)

9 
U16
 
	tCommHódî_T
;

11 
CommHódî_T
 
GëCommHódî
–
U8
 
id
 );

12 
SëCommHódî
–
U8
 
id
, 
CommHódî_T
 
vÆ
 );

14 
I16
 
CommSídPackë
–
U8
 
id
, U8 *
£nd_pkt
, I16 
Àn
 );

15 
I8
 
CommRecvPackë
–
U8
 
id
 , U8 *
ªcv_pkt
 );

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\crc16.c

1 
	~"¸c16.h
"

5 
	#MASK
 0xA001

	)

6 
	$CÆCrc16
(
Crc
,
C
)

8 
j
;

9 
CrcSum
;

10 
CrcBuf
;

13 
CrcSum
 = 
Crc
;

14 
CrcBuf
 = 
C
;

16 
j
=0;j < 8;j++) {

17 if(((
CrcSum
 ^ 
CrcBuf
Ë& 0x0001Ë!0ËCrcSum = (CrcSum >> 1Ë^ 
MASK
;

18 
CrcSum
 >>= 1;

20 
CrcBuf
 >>= 1;

23  
CrcSum
;

24 
	}
}

29 c⁄° 
U16
 
	g¸c16èb
[256] =

71 
U16
 
	$¸c16_ˇl
(
U8
 *
uc_d©a
, U8 
uc_numbî
)

73 
U16
 
ui_¸c
 = 0xFFFF;

74 
U16
 
ui_ãmp_¸c
;

76 ; 
uc_numbî
 > 0; uc_number--) {

77 
ui_ãmp_¸c
 = 
ui_¸c
 ^ (*
uc_d©a
);

78 
ui_¸c
=(ui_¸c>>8)^
¸c16èb
[
ui_ãmp_¸c
 & 0x00ff];

80 
uc_d©a
++;

82 (
ui_¸c
);

83 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\crc16.h

1 #i‚de‡
__CRC16_H__


2 
	#__CRC16_H__


	)

4 
	~"¥j_ty≥.h
"

7 
CÆCrc16
(
Crc
,
C
);

10 
U16
 
¸c16_ˇl
(
U8
 *
uc_d©a
, U8 
uc_numbî
);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser.c

4 
	~"hw.h
"

5 
	~"hÆ_£rül.h
"

6 
	~"∑r£r.h
"

7 
	~"comm.h
"

8 
	~"timî.h
"

10 
	~"∑r£r_tof.h
"

13 #i‡
DEBUG_COMM


14 
	s_debug_comm_


16 
U32
 
	mrx_˙t
;

17 
U32
 
	mrx_îr
;

19 
U32
 
	mtx_˙t
;

20 } 
	tdebug_comm_t
;

21 
debug_comm_t
 
	gd_comm
[ 
MAX_COMM_ID
 ];

25 vﬁ©ûê
U8
 
	gpkt_ªcv
[ 
MAX_COMM_RX_BUF_SZ
 ];

26 
I16
 
	gpkt_ªcv_Àn
 = 0;

29 vﬁ©ûê
U8
 
	gpkt_£nd
[ 
MAX_COMM_TX_BUF_SZ
 ];

30 
I16
 
	gpkt_£nd_Àn
 = 0;

35 
	$I16
 (*
	t‚_∑r£r_rx_t
)–
	tU8
 *
	tbuf
, 
	tI16
 
	tÀn
 );

36 
	s_∑r£r_li°_


38 
U8
 
TimîId
;

39 
U8
 
CommId
;

40 
‚_∑r£r_rx_t
 
IsVÆidPkt
;

41 
‚_∑r£r_rx_t
 
P¨£rPkt
;

42 } 
	t∑r£r_rx_li°_t
;

44 c⁄° 
∑r£r_rx_li°_t
 
∑r£r_rx_li°
[] =

46 { 
TIMER_ID_COMM_UART_1_RX
, 
COMM_ID_TOF
, 
IsVÆidPkt_TOF
, 
P¨£rPkt_TOF
 },

47 
	}
};

48 
	#MAX_PARSER_RX_NUM
 ( –
∑r£r_rx_li°
Ë/ –
∑r£r_rx_li°_t
 ) )

	)

50 
	$RecvPackëH™dÀr
( )

52 
∑r£r_rx_li°_t
 *
p_li°
;

53 
U8
 
i
;

55  
i
 = 0 ; i < 
MAX_PARSER_RX_NUM
 ; i++ )

58 
p_li°
 = &
∑r£r_rx_li°
[ 
i
 ];

59 if–
	`IsExpúedTimî
–
p_li°
->
TimîId
 ) =
TIMER_EXPIRE
 )

61 
	`DißbÀTimî
–
p_li°
->
TimîId
 );

63 if––
pkt_ªcv_Àn
 = 
	`CommRecvPackë
–
p_li°
->
CommId
, &
pkt_ªcv
[0] ) ) > 0 )

65 
	`HAL_InôRecvLígth
–
p_li°
->
CommId
 );

67 if–
p_li°
->
	`IsVÆidPkt
–&
pkt_ªcv
[0], 
pkt_ªcv_Àn
 ) =
TRUE
 )

69 
p_li°
->
	`P¨£rPkt
–&
pkt_ªcv
[0], 
pkt_ªcv_Àn
 );

70 #i‡
DEBUG_COMM


71 
d_comm
[ 
p_li°
->
CommId
 ].
rx_˙t
++;

76 #i‡
DEBUG_COMM


77 
d_comm
[ 
p_li°
->
CommId
 ].
rx_îr
++;

83 
	}
}

89 
	$I16
 (*
	t‚_∑r£r_tx_t
)–
	tCommHódî_T
 *
	tp_comm
, 
	tU8
 *
	tbuf
 );

90 
	$I16
 (*
	t‚_¸c16_t
)–
	tU8
 *
	tbuf
, 
	tI16
 
	tÀn
 );

91 
	s_∑r£r_tx_li°_


93 
U8
 
TimîId
;

94 
U8
 
CommId
;

95 
‚_∑r£r_tx_t
 
make_pkt
;

96 
‚_¸c16_t
 
¸c16
;

98 } 
	t∑r£r_tx_li°_t
;

100 c⁄° 
∑r£r_tx_li°_t
 
∑r£r_tx_li°
[] =

102 { 
TIMER_ID_COMM_UART_1_TX
, 
COMM_ID_TOF
, 
MakePkt_TOF
, 
Crc16_TOF
 },

103 
	}
};

104 
	#MAX_PARSER_TX_NUM
 ( –
∑r£r_tx_li°
Ë/ –
∑r£r_tx_li°_t
 ) )

	)

106 
	$SídPackëH™dÀr
( )

108 
∑r£r_tx_li°_t
 *
p_li°
;

109 
U8
 
i
;

110 
CommHódî_T
 
p_comm
;

113  
i
 = 0 ; i < 
MAX_PARSER_TX_NUM
 ; i++ )

115 
p_li°
 = &
∑r£r_tx_li°
[ 
i
 ];

117 if–
	`IsExpúedTimî
–
p_li°
->
TimîId
 ) =
TIMER_EXPIRE
 )

119 
	`DißbÀTimî
–
p_li°
->
TimîId
 );

121 
p_comm
 = 
	`GëCommHódî
–
p_li°
->
CommId
 );

124 
	`MEMSET
–(
__FAR
 *)
pkt_£nd
, 0, 
MAX_COMM_TX_BUF_SZ
 );

125 
pkt_£nd_Àn
 = 
p_li°
->
	`make_pkt
–(
CommHódî_T
 *)
p_comm
, 
pkt_£nd
 );

126 if–
pkt_£nd_Àn
 > 0 )

129 
pkt_£nd_Àn
 = 
p_li°
->
	`¸c16
–
pkt_£nd
,Ökt_send_len );

132 
	`CommSídPackë
–
p_li°
->
CommId
, 
pkt_£nd
, 
pkt_£nd_Àn
 );

134 #i‡
DEBUG_COMM


135 
d_comm
[ 
p_li°
->
CommId
 ].
tx_˙t
++;

140 
	`HAL_InôCommId
–
p_li°
->
CommId
 );

144 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser.h

1 #i‚de‡
__PARSER_H__


2 
	#__PARSER_H__


	)

4 
	~"¥j_ty≥.h
"

6 
RecvPackëH™dÀr
( );

7 
SídPackëH™dÀr
( );

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_debug.c

4 
	~"hw.h
"

5 
	~"Àvñ.h
"

6 
	~"ªœy.h
"

7 
	~"vÆve.h
"

8 
	~"room_w©î.h
"

9 
	~"cﬁd_w©î.h
"

10 
	~"hŸ_w©î.h
"

11 
	~"comp.h
"

12 
	~"ãmp.h
"

13 
	~"hÆ_adc.h
"

14 
	~"powî_ßvög.h
"

15 
	~"îr‹.h
"

16 
	~"„ed_pump.h
"

17 
	~"pump.h
"

19 
	~"∑r£r_debug.h
"

20 
	~"utû.h
"

22 
	~<°dio.h
>

23 
	~<°dlib.h
>

28 
	#MIN_PKT_SZ
 6

	)

31 
U8
 
	$check_¸c
–
U8
 *
buf
, U8 
Àn
 )

34 
U16
 
¸c16
 = 0;

36 
¸c16
 = ( ( (
U16
)
buf
[ 
Àn
 - 1 ] ) << 8 ) & 0xFF00;

37 
¸c16
 |–
buf
[ 
Àn
 - 2 ] );

39 if–
¸c16
 !
	`¸c16_ˇl
–
buf
, (
U8
)–
Àn
 - 2 ) ) )

41  
FALSE
;

45  
TRUE
;

46 
	}
}

48 
I16
 
	$IsVÆidPkt_Debug
–
U8
 *
buf
, 
I16
 
Àn
 )

50 if–
buf
 =
NULL
 )

52  
FALSE
;

56 if–
Àn
 < 
MIN_PKT_SZ
 )

58  
FALSE
;

60 if–
	`check_¸c
–
buf
, 
Àn
 ) =
FALSE
 )

62  
FALSE
;

66  
TRUE
;

67 
	}
}

70 
	$I16
 (*
	ta˘i⁄_t
)–
	tU8
 *
	tbuf
 );

71 
	s_∑r£r_li°_t


73 
a˘i⁄_t
 
∑r£r_pkt
;

74 } 
	t∑r£r_li°_t
;

75 c⁄° 
∑r£r_li°_t
 
∑r£r_li°
[] =

77 { 
NULL
 },

78 
	}
};

80 
	#SZ_PS_TABLE
 ( –
∑r£r_li°
 ) / –
∑r£r_li°_t
 ))

	)

82 
I16
 
	$P¨£rPkt_Debug
–
U8
 *
buf
, 
I16
 
Àn
)

85 if–
buf
[0] == '1' )

87 
	`SëCompPrŸe˘OffTime
(1);

90 if–
buf
[0] == '7' )

92 
	`SëSavögC⁄fTimîSÀï
(1);

93 
	`SëSavögC⁄fTimîWakeUp
(1);

95 if–
buf
[0] == '2' )

97 
	`SëCﬁdW©îExåaMakeTime
( 1 );

99 if–
buf
[0] == '3' )

101 
	`Tu∫OnTempSís‹
–
TEMP_ID_COLD_WATER
, 
DEFAULT_TEMP_READ_TIME
 );

103 if–
buf
[0] == '4' )

105 
	`SëPumpOnCuºítTime
( 100 );

107 if–
buf
[0] == '5' )

109 
	`SëRoomW©îFìdTime
( 1 );

141 
	}
}

143 
I16
 
	$Crc16_Debug
–
U8
 *
buf
, 
I16
 
Àn
 )

145  
Àn
;

146 
	}
}

148 
	s_make_li°_t


150 
U8
 
	mTx
;

151 
a˘i⁄_t
 
	mmake_pkt
;

152 } 
	tmake_li°_t
;

154 
I16
 
MakePktTy≥_1
–
U8
 *
buf
 );

155 
I16
 
MakePktTy≥_2
–
U8
 *
buf
 );

156 
make_li°_t
 
	gmake_li°
[] =

158 { 
TRUE
, 
MakePktTy≥_1
 },

159 { 
TRUE
, 
MakePktTy≥_2
 }

162 
	#SZ_TABLE
 ( –
make_li°
 ) / –
make_li°_t
 ))

	)

164 
I16
 
	$MakePkt_Debug
–
CommHódî_T
 *
p_comm
, 
U8
 *
buf
 )

166 
U8
 
mCou¡
 = 0;

167 
a˘i⁄_t
 
p_make_pkt
;

168 
I16
 
Àn
 = -1;

171 
p_make_pkt
 = 
make_li°
[ 
mCou¡
 ].
make_pkt
;

172 if–
p_make_pkt
 !
NULL
 )

174 if–
make_li°
[ 
mCou¡
 ].
Tx
 =
TRUE
 )

176 
Àn
 = 
	`p_make_pkt
–
buf
 );

180 
mCou¡
 = 0;

182  
Àn
;

186 
mCou¡
++;

187 if–
mCou¡
 >
SZ_TABLE
 )

189 
mCou¡
 = 0;

192  
Àn
;

193 
	}
}

196 
U8
 
gu8F™OnOff
;

197 
I16
 
	$MakePktTy≥_1
–
U8
 *
buf
 )

199 
I16
 
Àn
 = 0;

201 
RoomW©î_T
 
mRoomD©a
;

202 
CﬁdW©î_T
 
mCﬁdD©a
;

203 
HŸW©î_T
 
mHŸD©a
;

204 
Com¥ess‹_T
 
mCompD©a
;

205 
FìdPump_T
 
mFìdPump
;

206 
Pump_T
 
mPump
;

210 
Àn
 = 
	`•rötf
–(*)&
buf
[Üen ], "TYPE_1=");

212 
	`GëRoomW©îD©a
–&
mRoomD©a
 );

213 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d:%d:%d:%d:%d@",

214 
	`GET_ROOM_TANK_LOW
(),

215 
	`GET_ROOM_TANK_HIGH
(),

216 
	`GET_ROOM_TANK_OVERFLOW
(),

217 
mRoomD©a
.
Levñ
,

218 
mRoomD©a
.
InôFuŒ
,

219 –
mRoomD©a
.
FìdTime
 / 10 )

223 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d@",

224 
	`GëT™kLevñ
–
LEVEL_ID_COLD
 ),

225 
	`GëCﬁdW©îInôFuŒ
()

229 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d@",

230 !
	`GET_STATUS_VALVE_NOS
(),

231 
	`GET_STATUS_VALVE_FEED
()

235 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d@",

236 
	`IsTu∫OnRñay
–
RELAY_COMP
 ),

237 
	`IsTu∫OnRñay
–
RELAY_HEATER
 )

241 
	`GëCﬁdW©îD©a
–&
mCﬁdD©a
 );

242 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d:%.1f:%.1f:%.1f:%d:%u@",

243 
mCﬁdD©a
.
C⁄figMake
,

244 
mCﬁdD©a
.
Make
,

245 
mCﬁdD©a
.
TempT¨gëOn
,

246 
mCﬁdD©a
.
TempT¨gëOff
,

247 
mCﬁdD©a
.
TempCuºít
,

248 
mCﬁdD©a
.
ExåaMake
,

249 
mCﬁdD©a
.
ExåaMakeTime


253 
	`GëHŸW©îD©a
–&
mHŸD©a
 );

254 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d:%.1f:%.1f:%.1f:%d:%d:%d:%u@",

255 
mHŸD©a
.
C⁄figMake
,

256 
mHŸD©a
.
Make
,

257 
mHŸD©a
.
TempT¨gëOn
,

258 
mHŸD©a
.
TempT¨gëOff
,

259 
mHŸD©a
.
TempCuºít
,

260 
mHŸD©a
.
Levñ
,

261 
mHŸD©a
.
A…ôude
,

262 
mHŸD©a
.
InôFuŒ
,

263 
mHŸD©a
.
InôWaôTime


267 
	`GëCompD©a
–&
mCompD©a
 );

268 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d:%lu:%lu:%d@",

269 
	`GëCompOnOff
(),

270 
mCompD©a
.
PrŸe˘OffTime
,

271 
mCompD©a
.
OnTime
,

272 
mCompD©a
.
OffTime
,

273 
gu8F™OnOff


278 
	`GëFìdPumpD©a
–&
mFìdPump
 );

279 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d:%d:%d:%d@",

280 
mFìdPump
.
C⁄n
,

281 
mFìdPump
.
OnOff
,

282 
mFìdPump
.
OnSãp
,

283 
mFìdPump
.
OffSãp
,

284 
	`GET_PUMP_ONOFF
()

288 
	`GëPumpD©a
–&
mPump
 );

289 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d:%d:%lu:%lu@",

290 
mPump
.
OnOff
,

291 
mPump
.
OnSãp
,

292 
mPump
.
OnPumpCmd
,

293 (
mPump
.
OnT¨gëTime
 / 10UL) ,

294 (
mPump
.
OnCuºítTime
 / 10UL)

298 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "\r\n" );

300  
Àn
;

301 
	}
}

304 
I16
 
	$MakePktTy≥_2
–
U8
 *
buf
 )

306 
I16
 
Àn
 = 0;

307 
PowîSavög_T
 
mSavögD©a
;

310 
	`GëSavögD©a
–&
mSavögD©a
 );

313 
Àn
 = 
	`•rötf
–(*)&
buf
[Üen ], "TYPE_2=");

316 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%u:%u:%u:",

317 
	`HAL_GëAdcVÆue
–
ANI_TEMP_HOT_WATER
 ),

318 
	`HAL_GëAdcVÆue
–
ANI_TEMP_COLD_WATER
 ),

319 
	`HAL_GëAdcVÆue
–
ANI_SENSOR_PHOTO
 )

323 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%.1f:%.1f@",

324 
	`GëTemp
–
TEMP_ID_HOT_WATER
 ),

325 
	`GëTemp
–
TEMP_ID_COLD_WATER
 )

329 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d@",

330 
	`GëTempSís‹Time
–
TEMP_ID_COLD_WATER
 ),

331 
	`GëTempSís‹Time
–
TEMP_ID_HOT_WATER
 )

335 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d:%d:%d:",

336 
mSavögD©a
.
C⁄fig
,

337 
mSavögD©a
.
Sètus
,

338 
mSavögD©a
.
D¨k2Light
,

339 
mSavögD©a
.
Light2D¨k


343 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d:%d:%d:%d:%d@",

344 
mSavögD©a
.
IsD¨k
,

345 
mSavögD©a
.
PhŸoAdc
,

346 
mSavögD©a
.
AdcLimôSÀï
,

347 
mSavögD©a
.
AdcLimôWakeUp
,

348 
mSavögD©a
.
TimîSÀï
,

349 
mSavögD©a
.
TimîWakeUp


353 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "%d:%d:%d:%d:%d:%d@",

354 
	`IsEº‹
–
ERR_TEMP_COLD_WATER
 ),

355 
	`IsEº‹
–
ERR_TEMP_HOT_WATER
 ),

356 
	`IsEº‹
–
ERR_ROOM_OVF
 ),

357 
	`IsEº‹
–
ERR_ROOM_COMPLEX
 ),

358 
	`IsEº‹
–
ERR_ROOM_LOW_LEVEL
 ),

359 
	`IsEº‹
–
ERR_ROOM_HIGH_LEVEL
 )

364 
Àn
 +
	`•rötf
–(*)&
buf
[Üen ], "\r\n" );

367  
Àn
;

369 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_debug.h

1 #i‚de‡
__PARSER_DEBUG_H__


2 
	#__PARSER_DEBUG_H__


	)

4 
	~"¥j_ty≥.h
"

5 
	~"comm.h
"

7 
I16
 
IsVÆidPkt_Debug
–
U8
 *
buf
, I16 
Àn
 );

8 
I16
 
P¨£rPkt_Debug
–
U8
 *
buf
, I16 
Àn
);

9 
I16
 
Crc16_Debug
–
U8
 *
buf
, I16 
Àn
 );

10 
I16
 
MakePkt_Debug
–
CommHódî_T
 *
p_comm
, 
U8
 *
buf
 );

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_eol.c

5 
	~"hw.h
"

6 
	~"∑r£r_eﬁ.h
"

7 
	~"utû.h
"

8 
	~"eﬁ.h
"

9 
	~"¥o˚ss_eﬁ.h
"

10 
	~"timî.h
"

12 
	~"ãmp.h
"

13 
	~"îr_ãmp.h
"

14 
	~"Àvñ.h
"

15 
	~"ªœy.h
"

16 
	~"vÆve.h
"

17 
	~"room_w©î.h
"

18 
	~"cﬁd_w©î.h
"

19 
	~"comp.h
"

21 
	~"hÆ_adc.h
"

22 
	~"hÆ_Án_mŸ‹.h
"

23 
	~"powî_ßvög.h
"

24 
	~"îr‹.h
"

25 
	~"¥o˚ss_di•œy.h
"

27 
	~<°dio.h
>

28 
	~<°dlib.h
>

33 
	#PKT_STX
 0x01

	)

34 
	#PKT_ETX
 0x04

	)

36 
	#PKT_ACK
 0x06

	)

37 
	#PKT_NAK
 0x15

	)

39 
	#MIN_PKT_SZ
 6

	)

42 
	#MK_DATA
–
_buf
, 
_Àn
, 
_s
, 
_vÆ
 ) \

44 
_Àn
 +
	`•rötf
–(*)&
_buf
[ _À¿], 
_s
, 
_vÆ
 );\

45 }0)

	)

48 
I16
 
	$MkTemp
(
TEMP_T
 
mTemp
, 
U8
 *
pBuf
, 
I16
 
mi16Lí
)

50 
U16
 
mu16Temp
;

52 
mu16Temp
 = (
U16
)–
mTemp
 * 10.0f );

54 
pBuf
[ 
mi16Lí
++ ] = 
	`GET_HIGH_BYTE
–
mu16Temp
 );

55 
pBuf
[ 
mi16Lí
++ ] = 
	`GET_LOW_BYTE
–
mu16Temp
 );

57  
mi16Lí
;

58 
	}
}

60 
U8
 
	$check_¸c
–
U8
 *
buf
, 
I16
 
Àn
 )

62 
U8
 
i
 = 0;

63 
U8
 
mu8Chksum
 = 0;

65  
i
 = 0; i < 
Àn
 - 3 ; i++ )

67 
mu8Chksum
 ^
buf
[ 
i
 ];

70  
mu8Chksum
;

71 
	}
}

73 
U8
 
	$IsTrueChksum
–
U8
 *
buf
, 
I16
 
Àn
 )

75 
U8
 
mu8CÆ
;

76 
U8
 
mu8VÆ
;

79 
mu8CÆ
 = 
	`check_¸c
–
buf
, 
Àn
 );

80 
mu8VÆ
 = 
	`C⁄vAsc2Byã
–
buf
[ 
Àn
 - 3 ], buf[Üen - 2 ] );

81 if–
mu8CÆ
 !
mu8VÆ
 )

83  
FALSE
;

86  
TRUE
;

87 
	}
}

90 
I16
 
	$IsVÆidPkt_EOL
–
U8
 *
buf
, 
I16
 
Àn
 )

92 
U8
 
mu8Chksum
 = 0;

94 if–
buf
 =
NULL
 )

96  
FALSE
;

99 if–
Àn
 < 
MIN_PKT_SZ
 )

101  
FALSE
;

104 if–
buf
[0] !
PKT_STX


105 || 
buf
[ 
Àn
 - 1] !
PKT_ETX
 )

107  
FALSE
;

110 if–
	`IsTrueChksum
–
buf
, 
Àn
 ) =
FALSE
 )

112  
FALSE
;

117 if–
	`GëEﬁMode
(Ë=
EOL_MODE_DONE
 )

119  
FALSE
;

122 if–
	`GëEﬁSètus
(Ë=
FALSE
 )

125 if–
	`IsExpúedEﬁLimôTimî
(Ë=
TRUE
 )

127  
FALSE
;

132 
	`SèπEﬁ
–
EOL_TYPE_LOAD
 );

133 
	`SèπDi•œyInô
();

134 
	`SëVîsi⁄Di•
( 50 );

137  
TRUE
;

138 
	}
}

141 (*
	tA˘i⁄P¨£r_t
)();

142 
	s_∑r£r_li°_t


144 
U8
 
Ty≥
;

145 
A˘i⁄P¨£r_t
 
P¨£rPkt
;

146 } 
	t∑r£r_li°_t
;

149 
	`P¨£rSís‹
();

150 
	`P¨£rNoLﬂd
();

151 
	`P¨£rF™MŸ‹
();

152 
	`P¨£rFìdVÆve
();

153 
	`P¨£rNosVÆve
();

154 
	`P¨£rHóãr
();

155 
	`P¨£rGasFìdVÆve
();

156 
	`P¨£rGasNosVÆveClo£
();

157 
	`P¨£rGasNosVÆveO≥n
();

158 
	`P¨£rComp
();

159 
	`P¨£rCom∂ëe
();

161 c⁄° 
∑r£r_li°_t
 
∑r£r_li°
[] =

163 { 
PKT_EOL_MODEL
, 
NULL
 },

164 { 
PKT_EOL_MODE
, 
NULL
 },

166 { 
PKT_EOL_EEPROM
, 
P¨£rSís‹
 },

167 { 
PKT_EOL_SENSOR_TEMP
, 
NULL
 },

168 { 
PKT_EOL_SENSOR_LEVEL
, 
NULL
 },

170 { 
PKT_EOL_HEATER
, 
P¨£rHóãr
 },

171 { 
PKT_EOL_NO_LOAD
, 
P¨£rNoLﬂd
 },

173 { 
PKT_EOL_FEED_VALVE
, 
P¨£rFìdVÆve
 },

174 { 
PKT_EOL_NOS_VALVE
, 
P¨£rNosVÆve
 },

176 { 
PKT_EOL_GAS_FEED_VALVE
, 
P¨£rGasFìdVÆve
 },

177 { 
PKT_EOL_GAS_NOS_VALVE_CLOSE
, 
P¨£rGasNosVÆveClo£
 },

178 { 
PKT_EOL_GAS_NOS_VALVE_OPEN
, 
P¨£rGasNosVÆveO≥n
 },

180 { 
PKT_EOL_COMP
, 
P¨£rComp
 },

181 { 
PKT_EOL_COMPLETE
, 
P¨£rCom∂ëe
 }

184 
	}
};

185 
	#SZ_PARSER_TABLE
 (–
∑r£r_li°
 ) / –
∑r£r_li°_t
 ))

	)

188 
I16
 
	$P¨£rPkt_EOL
–
U8
 *
buf
, 
I16
 
Àn
)

190 
U8
 
mu8Index
 = 0;

191 
U8
 
mu8PktTy≥
 = 0;

192 
A˘i⁄P¨£r_t
 
pP¨£r
 = 
NULL
;

196 
mu8PktTy≥
 = 
	`C⁄vAsc2Byã
–
buf
[1], buf[2] );

197  
mu8Index
 = 0; mu8Index < 
SZ_PARSER_TABLE
; mu8Index++ )

199 if–
mu8PktTy≥
 =
∑r£r_li°
[ 
mu8Index
 ].
Ty≥
 )

201 
pP¨£r
 = 
∑r£r_li°
[ 
mu8Index
 ].
P¨£rPkt
;

202 if–
pP¨£r
 !
NULL
 )

204 
	`pP¨£r
();

208 
	`SëCommHódî
–
COMM_ID_EOL
, 
mu8PktTy≥
 );

209 
	`SèπTimî
–
TIMER_ID_COMM_EOL_TX
, 0 );

215 
	}
}

217 
	$Tu∫OffAŒLﬂd
()

220 
	`Clo£VÆve
–
VALVE_ALL
 );

221 
	`O≥nVÆve
–
VALVE_NOS
 );

224 
	`Tu∫OffRñayAŒ
();

227 
	`HAL_Tu∫OffF™MŸ‹
();

228 
	}
}

247 
	$P¨£rSís‹
()

249 
	`SëEﬁMode
–
EOL_MODE_CHECK_SENSOR
 );

250 
	}
}

252 
	$P¨£rNoLﬂd
()

254 
	`SëEﬁMode
–
EOL_MODE_CHECK_LOAD
 );

256 
	`Tu∫OffAŒLﬂd
();

257 
	}
}

260 
	$P¨£rF™MŸ‹
()

262 
	`Tu∫OffAŒLﬂd
();

264 
	`HAL_Tu∫OnF™MŸ‹
();

265 
	}
}

268 
	$P¨£rFìdVÆve
()

270 
	`Tu∫OffAŒLﬂd
();

272 
	`O≥nVÆve
–
VALVE_FEED
 );

273 
	}
}

275 
	$P¨£rNosVÆve
()

277 
	`Tu∫OffAŒLﬂd
();

279 
	`Clo£VÆve
–
VALVE_NOS
 );

280 
	}
}

283 
	$P¨£rHóãr
()

285 
U8
 
mu8PrŸe˘HóãrFœg
 = 0;

287 
	`Tu∫OffAŒLﬂd
();

289 if–
mu8PrŸe˘HóãrFœg
 == 0 )

291 
mu8PrŸe˘HóãrFœg
 = 1;

292 
	`Tu∫OnRñay
–
RELAY_HEATER
 );

295 
	}
}

297 
	$P¨£rGasFìdVÆve
()

299 
	`O≥nVÆve
–
VALVE_FEED
 );

300 
	`O≥nVÆve
–
VALVE_NOS
 );

301 
	}
}

303 
	$P¨£rGasNosVÆveClo£
()

305 
	`Clo£VÆve
–
VALVE_NOS
 );

306 
	}
}

308 
	$P¨£rGasNosVÆveO≥n
()

310 
	`O≥nVÆve
–
VALVE_NOS
 );

311 
	}
}

314 
	$P¨£rComp
()

316 
	`Tu∫OffAŒLﬂd
();

319 
	`Tu∫OnRñay
–
RELAY_COMP
 );

320 
	`HAL_Tu∫OnF™MŸ‹
();

322 
	`SèπEﬁI˚Sy°em
();

323 
	}
}

326 
	$P¨£rCom∂ëe
()

328 
	`SëEﬁMode
–
EOL_MODE_DONE
 );

330 
	`Tu∫OffAŒLﬂd
();

331 
	}
}

335 
I16
 
	$Crc16_EOL
–
U8
 *
buf
, 
I16
 
Àn
 )

337 
U8
 
i
 = 0;

338 
U8
 
mu8Chksum
 = 0;

339 
U8
 
¸c_buf
[5];

342 if–
Àn
 < 
MIN_PKT_SZ
 )

347 
mu8Chksum
 = 
	`check_¸c
–
buf
, 
Àn
);

348 
	`•rötf
–(*)
¸c_buf
, "%02X", 
mu8Chksum
 );

350 
buf
[ 
Àn
 - 3 ] = 
¸c_buf
[0];

351 
buf
[ 
Àn
 - 2 ] = 
¸c_buf
[1];

353  
Àn
;

354 
	}
}

356 
	$I16
 (*
	tA˘i⁄_t
)–
	tU8
 *
	tbuf
, U8 
	tmu8PktTy≥
 );

357 
	s_make_li°_t


359 
U8
 
Ty≥
;

360 
A˘i⁄_t
 
MakePkt
;

361 } 
	tmake_li°_t
;

362 
I16
 
	`MakePkt_Modñ
–
U8
 *
buf
, U8 
mu8PktTy≥
 );

363 
I16
 
	`MakePkt_Eïrom
–
U8
 *
buf
, U8 
mu8PktTy≥
 );

364 
I16
 
	`MakePkt_Sís‹Temp
–
U8
 *
buf
, U8 
mu8PktTy≥
 );

365 
I16
 
	`MakePkt_Sís‹Levñ
–
U8
 *
buf
, U8 
mu8PktTy≥
 );

366 
I16
 
	`MakePkt_Comp
–
U8
 *
buf
, U8 
mu8PktTy≥
 );

367 
I16
 
	`MakePkt_NoPayLﬂd
–
U8
 *
buf
, U8 
mu8PktTy≥
 );

369 c⁄° 
make_li°_t
 
make_li°
[] =

371 { 
PKT_EOL_MODEL
, 
MakePkt_Modñ
 },

372 { 
PKT_EOL_MODE
, 
MakePkt_NoPayLﬂd
 },

374 { 
PKT_EOL_EEPROM
, 
MakePkt_Eïrom
 },

375 { 
PKT_EOL_SENSOR_TEMP
, 
MakePkt_Sís‹Temp
 },

376 { 
PKT_EOL_SENSOR_LEVEL
, 
MakePkt_Sís‹Levñ
 },

378 { 
PKT_EOL_HEATER
, 
MakePkt_NoPayLﬂd
 },

379 { 
PKT_EOL_NO_LOAD
, 
MakePkt_NoPayLﬂd
 },

381 { 
PKT_EOL_FEED_VALVE
, 
MakePkt_NoPayLﬂd
 },

382 { 
PKT_EOL_NOS_VALVE
, 
MakePkt_NoPayLﬂd
 },

384 { 
PKT_EOL_GAS_FEED_VALVE
, 
MakePkt_NoPayLﬂd
 },

385 { 
PKT_EOL_GAS_NOS_VALVE_CLOSE
, 
MakePkt_NoPayLﬂd
 },

386 { 
PKT_EOL_GAS_NOS_VALVE_OPEN
, 
MakePkt_NoPayLﬂd
 },

388 { 
PKT_EOL_COMP
, 
MakePkt_Comp
 },

389 { 
PKT_EOL_COMPLETE
, 
MakePkt_NoPayLﬂd
 }

392 
	}
};

394 
	#SZ_MAKE_TABLE
 ( –
make_li°
 ) / –
make_li°_t
 ))

	)

396 
I16
 
	$MakePkt_EOL
–
CommHódî_T
 *
pComm
, 
U8
 *
buf
 )

398 
U8
 
mu8Ty≥
;

399 
A˘i⁄_t
 
p_make_pkt
;

400 
U8
 
i
;

401 
I16
 
Àn
 = -1;

404  
i
 = 0; i < 
SZ_MAKE_TABLE
; i++ )

406 
mu8Ty≥
 = 
make_li°
[ 
i
 ].
Ty≥
;

407 
p_make_pkt
 = 
make_li°
[ 
i
 ].
MakePkt
;

409 if–
mu8Ty≥
 =(
U8
)
pComm
 )

411 if–
p_make_pkt
 !
NULL
 )

413 
Àn
 = 
	`p_make_pkt
–
buf
, 
mu8Ty≥
 );

419  
Àn
;

420 
	}
}

423 
I16
 
	$MakePkt_Modñ
–
U8
 *
buf
, U8 
mu8PktTy≥
 )

425 
I16
 
mi16Lí
 = 0;

428 
buf
[ 
mi16Lí
++ ] = 
PKT_STX
;

429 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
PKT_ACK
 );

430 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
mu8PktTy≥
 );

431 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
MODEL_CODE
 );

432 
buf
[ 
mi16Lí
++ ] = 0;

433 
buf
[ 
mi16Lí
++ ] = 0;

434 
buf
[ 
mi16Lí
++ ] = 
PKT_ETX
;

436  
mi16Lí
;

437 
	}
}

439 
I16
 
	$MakePkt_Eïrom
–
U8
 *
buf
, U8 
mu8PktTy≥
 )

441 
I16
 
mi16Lí
 = 0;

444 
buf
[ 
mi16Lí
++ ] = 
PKT_STX
;

445 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
PKT_ACK
 );

446 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
mu8PktTy≥
 );

447 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GëEﬁCheckSètus
–
EOL_CHK_ID_EEPROM
 ) );

448 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Len ], "%02X", 0x03 );

449 
buf
[ 
mi16Lí
++ ] = 0;

450 
buf
[ 
mi16Lí
++ ] = 0;

451 
buf
[ 
mi16Lí
++ ] = 
PKT_ETX
;

453  
mi16Lí
;

454 
	}
}

456 
	#TEMP_ERROR
 0xFF

457 
	#TEMP_UNDER
 0x00

458 
U8
 
	`C⁄vEﬁTemp
(U8 
mu8AdcId
, 
TEMP_T
 
mTemp
)

	)

460 
U8
 
	gmu8Rë
 = 
TEMP_ERROR
;

462 
U16
 
	gmu16Adc
 = 0;

466 
	gmu16Adc
 = 
HAL_GëAdcVÆue
–
mu8AdcId
 );

467 if–
GëTempEº‹Ty≥
–
mu16Adc
 ) !
STATUS_NORMAL
 )

469 
mu8Rë
 = 
TEMP_ERROR
;

473 if–
	gmTemp
 > 0.0f )

475 
	gmu8Rë
 = (
U8
)
mTemp
;

479 
	gmu8Rë
 = 
TEMP_UNDER
;

483  
	gmu8Rë
;

486 
I16
 
	$MakePkt_Sís‹Temp
–
U8
 *
buf
, U8 
mu8PktTy≥
 )

488 
I16
 
mi16Lí
 = 0;

489 
U16
 
mu16Adc
;

491 
buf
[ 
mi16Lí
++ ] = 
PKT_STX
;

492 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
PKT_ACK
 );

493 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
mu8PktTy≥
 );

496 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`C⁄vEﬁTemp
–
ANI_TEMP_COLD_WATER
, 
	`GëTemp
–
TEMP_ID_COLD_WATER
) ));

497 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`C⁄vEﬁTemp
–
ANI_TEMP_HOT_WATER
, 
	`GëTemp
–
TEMP_ID_HOT_WATER
) ));

499 
mu16Adc
 = 
	`HAL_GëAdcVÆue
–
ANI_TEMP_COLD_WATER
 );

500 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GET_HIGH_BYTE
–
mu16Adc
 ) );

501 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GET_LOW_BYTE
–
mu16Adc
 ));

503 
mu16Adc
 = 
	`HAL_GëAdcVÆue
–
ANI_TEMP_HOT_WATER
 );

504 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GET_HIGH_BYTE
–
mu16Adc
 ) );

505 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GET_LOW_BYTE
–
mu16Adc
 ));

508 
buf
[ 
mi16Lí
++ ] = 0;

509 
buf
[ 
mi16Lí
++ ] = 0;

510 
buf
[ 
mi16Lí
++ ] = 
PKT_ETX
;

512  
mi16Lí
;

513 
	}
}

515 
I16
 
	$MakePkt_Sís‹Levñ
–
U8
 *
buf
, U8 
mu8PktTy≥
 )

517 
I16
 
mi16Lí
 = 0;

520 
buf
[ 
mi16Lí
++ ] = 
PKT_STX
;

521 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
PKT_ACK
 );

522 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
mu8PktTy≥
 );

523 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GET_ROOM_TANK_LOW
() );

524 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GET_ROOM_TANK_HIGH
() );

525 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GET_ROOM_TANK_OVERFLOW
() );

526 
buf
[ 
mi16Lí
++ ] = 0;

527 
buf
[ 
mi16Lí
++ ] = 0;

528 
buf
[ 
mi16Lí
++ ] = 
PKT_ETX
;

530  
mi16Lí
;

531 
	}
}

533 
I16
 
	$MakePkt_Comp
–
U8
 *
buf
, U8 
mu8PktTy≥
 )

535 
I16
 
mi16Lí
 = 0;

536 
U16
 
mu16Adc
;

538 
buf
[ 
mi16Lí
++ ] = 
PKT_STX
;

539 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
PKT_ACK
 );

540 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
mu8PktTy≥
 );

542 
mu16Adc
 = 
	`HAL_GëAdcVÆue
–
ANI_TEMP_COLD_WATER
 );

543 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GET_HIGH_BYTE
–
mu16Adc
 ) );

544 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
	`GET_LOW_BYTE
–
mu16Adc
 ));

546 
buf
[ 
mi16Lí
++ ] = 0;

547 
buf
[ 
mi16Lí
++ ] = 0;

548 
buf
[ 
mi16Lí
++ ] = 
PKT_ETX
;

550  
mi16Lí
;

551 
	}
}

554 
I16
 
	$MakePkt_NoPayLﬂd
–
U8
 *
buf
, U8 
mu8PktTy≥
 )

556 
I16
 
mi16Lí
 = 0;

558 
buf
[ 
mi16Lí
++ ] = 
PKT_STX
;

559 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
PKT_ACK
 );

560 
mi16Lí
 +
	`•rötf
–(*)&
buf
[ mi16Lí ], "%02X", 
mu8PktTy≥
 );

561 
buf
[ 
mi16Lí
++ ] = 0;

562 
buf
[ 
mi16Lí
++ ] = 0;

563 
buf
[ 
mi16Lí
++ ] = 
PKT_ETX
;

565  
mi16Lí
;

566 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_eol.h

1 #i‚de‡
__PARSER_EOL_H__


2 
	#__PARSER_EOL_H__


	)

4 
	~"¥j_ty≥.h
"

5 
	~"comm.h
"

9 
	mPKT_EOL_NONE
 = 0x00,

11 
	mPKT_EOL_MODEL
 = 0x20,

12 
	mPKT_EOL_MODE
 = 0x22,

14 
	mPKT_EOL_EEPROM
 = 0x32,

15 
	mPKT_EOL_SENSOR_TEMP
 = 0x35,

16 
	mPKT_EOL_SENSOR_LEVEL
 = 0x38,

18 
	mPKT_EOL_HEATER
 = 0x50,

19 
	mPKT_EOL_NO_LOAD
 = 0x54,

21 
	mPKT_EOL_FEED_VALVE
 = 0x58,

22 
	mPKT_EOL_NOS_VALVE
 = 0x5C,

24 
	mPKT_EOL_GAS_FEED_VALVE
 = 0x78,

25 
	mPKT_EOL_GAS_NOS_VALVE_CLOSE
 = 0x7D,

26 
	mPKT_EOL_GAS_NOS_VALVE_OPEN
 = 0x83,

28 
	mPKT_EOL_COMP
 = 0x99,

29 
	mPKT_EOL_COMPLETE
 = 0xF1,

33 
I16
 
IsVÆidPkt_EOL
–
U8
 *
buf
, I16 
Àn
 );

34 
I16
 
P¨£rPkt_EOL
–
U8
 *
buf
, I16 
Àn
);

35 
I16
 
Crc16_EOL
–
U8
 *
buf
, I16 
Àn
 );

36 
I16
 
MakePkt_EOL
–
CommHódî_T
 *
p_comm
, 
U8
 *
buf
 );

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_tof.c

4 
	~<°dio.h
>

5 
	~<°dlib.h
>

7 
	~"∑r£r_tof.h
"

8 
	~"utû.h
"

9 
	~"timî.h
"

10 
	~"tof.h
"

16 
	#STX
 0x11

	)

17 
	#ETX
 0x88

	)

20 
	#MIN_PKT_SZ
 4

	)

22 
U16
 
	$Rx_CRC_CCITT
(
U8
 *
puchMsg
, 
U16
 
usD©aLí
)

24 
U8
 
i
 = 0;

25 
U16
 
wCRCö
 = 0x0000;

26 
U16
 
wCPﬁy
 = 0x1021;

27 
U8
 
wCh¨
 = 0;

29 
usD©aLí
--)

31 
wCh¨
 = *(
puchMsg
++);

32 
wCRCö
 ^((
U16
)
wCh¨
 << 8);

33 
i
 = 0; i < 8; i++)

35 i‡(
wCRCö
 & 0x8000)

37 
wCRCö
 = (wCRCö << 1Ë^ 
wCPﬁy
;

41 
wCRCö
 = wCRCin << 1;

46  (
wCRCö
);

47 
	}
}

49 
U8
 
	$check_¸c
–
U8
 *
buf
, 
I16
 
Àn
 )

51 
U16
 
¸c16
 = 0;

53 
¸c16
 = 
	`GET_UINT_WORD
–
buf
[
Àn
-2], buf[len-3] );

54 if–
¸c16
 !
	`Rx_CRC_CCITT
–
buf
, (
U16
)–
Àn
 - 3 ) ) )

56  
FALSE
;

59  
TRUE
;

60 
	}
}

62 
I16
 
	$IsVÆidPkt_TOF
–
U8
 *
buf
, 
I16
 
Àn
 )

64 if–
buf
 =
NULL
 )

66  
FALSE
;

69 if–
Àn
 < 
MIN_PKT_SZ
 )

71  
FALSE
;

74 if–
	`check_¸c
–
buf
, 
Àn
 ) =
FALSE
 )

76  
FALSE
;

79  
TRUE
;

80 
	}
}

83 
I16
 
P¨£rReq
(
U8
 *
buf
);

84 
I16
 
P¨£rReqCÆi
(
U8
 *
buf
);

86 
	$I16
 (*
	ta˘i⁄_t
)–
	tU8
 *
	tbuf
 );

87 
	s_∑r£r_li°_t


89 
U8
 
Ty≥
;

90 
a˘i⁄_t
 
P¨£r
;

91 } 
	t∑r£r_li°_t
;

92 c⁄° 
∑r£r_li°_t
 
∑r£r_li°
[] =

94 { 
PKT_TOF_REQ
, 
P¨£rReq
 },

95 { 
PKT_TOF_REQ_CALI
, 
P¨£rReqCÆi
 },

96 
	}
};

98 
	#SZ_PS_TABLE
 ( –
∑r£r_li°
 ) / –
∑r£r_li°_t
 ))

	)

100 
I16
 
	$P¨£rPkt_TOF
–
U8
 *
buf
, 
I16
 
Àn
)

102 
U8
 
mu8Ty≥
;

103 
a˘i⁄_t
 
pP¨£r
;

104 
U8
 
i
;

107  
i
 = 0; i < 
SZ_PS_TABLE
; i++ )

109 
mu8Ty≥
 = 
∑r£r_li°
[ 
i
 ].
Ty≥
;

110 
pP¨£r
 = 
∑r£r_li°
[ 
i
 ].
P¨£r
;

112 if–
mu8Ty≥
 =
buf
[1] )

114 if–
pP¨£r
 !
NULL
 )

116 
Àn
 = 
	`pP¨£r
–&
buf
[2] );

122  
Àn
;

123 
	}
}

125 
I16
 
	$Crc16_TOF
–
U8
 *
buf
, 
I16
 
Àn
 )

127 
U16
 
mu16Chksum
 = 0;

130 if–
Àn
 < 
MIN_PKT_SZ
 )

135 
mu16Chksum
 = 
	`Rx_CRC_CCITT
–
buf
, (
U16
)(
Àn
 - 3));

136 
buf
[ 
Àn
 - 3 ] = 
	`GET_HIGH_BYTE
(
mu16Chksum
);

137 
buf
[ 
Àn
 - 2 ] = 
	`GET_LOW_BYTE
(
mu16Chksum
);

139  
Àn
;

140 
	}
}

143 
U8
 
dbg_°¨t
;

144 
I16
 
	$P¨£rReq
(
U8
 *
buf
)

146 
dbg_°¨t
 = 
buf
[0];

149 
	`SëCommHódî
–
COMM_ID_TOF
, 
PKT_TOF_ACK
 );

150 
	`SèπTimî
–
TIMER_ID_COMM_UART_1_TX
, 0 );

152  
TRUE
;

153 
	}
}

155 
U8
 
dbg_off£t
;

156 
U8
 
dbg_xèlk
;

157 
U8
 
dbg_Êo‹
;

158 
I16
 
	$P¨£rReqCÆi
(
U8
 *
buf
)

160 if–
	`GëSètusOff£tCÆibøti⁄
(Ë=
FALSE
 )

162 
dbg_off£t
 = 
TRUE
;

163  
FALSE
;

166 if–
	`GëSètusXèlkCÆibøti⁄
(Ë=
FALSE
 )

168 
dbg_xèlk
 = 
TRUE
;

169  
FALSE
;

173 
dbg_xèlk
 = 
FALSE
;

174 
dbg_xèlk
 = 
FALSE
;

177 
	`SëCommHódî
–
COMM_ID_TOF
, 
PKT_TOF_ACK_CALI
 );

178 
	`SèπTimî
–
TIMER_ID_COMM_UART_1_TX
, 0 );

179  
TRUE
;

180 
	}
}

183 
	s_make_li°_t


185 
U8
 
	mTy≥
;

186 
a˘i⁄_t
 
	mMakePkt
;

187 } 
	tmake_li°_t
;

189 
I16
 
MakePktAck
–
U8
 *
buf
 );

190 
I16
 
MakePktAckCÆi
–
U8
 *
buf
 );

191 c⁄° 
make_li°_t
 
	gmake_li°
[] =

193 { 
PKT_TOF_ACK
, 
MakePktAck
 },

194 { 
PKT_TOF_ACK_CALI
, 
MakePktAckCÆi
 },

196 
	#SZ_TABLE
 ( –
make_li°
 ) / –
make_li°_t
 ))

	)

198 
I16
 
	$MakePkt_TOF
–
CommHódî_T
 *
p_comm
, 
U8
 *
buf
 )

200 
U8
 
mu8Ty≥
;

201 
a˘i⁄_t
 
p_make_pkt
;

202 
U8
 
i
;

203 
I16
 
Àn
 = -1;

206  
i
 = 0; i < 
SZ_TABLE
; i++ )

208 
mu8Ty≥
 = 
make_li°
[ 
i
 ].
Ty≥
;

209 
p_make_pkt
 = 
make_li°
[ 
i
 ].
MakePkt
;

211 if–
mu8Ty≥
 =(
U8
)
p_comm
 )

213 if–
p_make_pkt
 !
NULL
 )

215 
Àn
 = 
	`p_make_pkt
–
buf
 );

221  
Àn
;

222 
	}
}

227 
I16
 
	$MakePktAck
–
U8
 *
buf
 )

229 
I16
 
mi16Lí
 = 0;

230 
U16
 
ønge
 = 0;

233 
buf
[ 
mi16Lí
++ ] = 
STX
;

236 
buf
[ 
mi16Lí
++ ] = 
PKT_TOF_ACK
;

239 
buf
[ 
mi16Lí
++ ] = 
	`GëSètusOff£tCÆibøti⁄
();

240 
buf
[ 
mi16Lí
++ ] = 
	`GëSètusXèlkCÆibøti⁄
();

241 
buf
[ 
mi16Lí
++ ] = 
dbg_°¨t
;

243 
ønge
 = (
U16
Ë
	`GëR™ge
( 0 );

244 
buf
[ 
mi16Lí
++ ] = 
	`GET_HIGH_BYTE
–
ønge
 );

245 
buf
[ 
mi16Lí
++ ] = 
	`GET_LOW_BYTE
–
ønge
 );

248 
ønge
 = (
U16
Ë
	`GëR™ge
( 1 );

249 
buf
[ 
mi16Lí
++ ] = 
	`GET_HIGH_BYTE
–
ønge
 );

250 
buf
[ 
mi16Lí
++ ] = 
	`GET_LOW_BYTE
–
ønge
 );

252 
ønge
 = (
U16
Ë
	`GëR™ge
( 2 );

253 
buf
[ 
mi16Lí
++ ] = 
	`GET_HIGH_BYTE
–
ønge
 );

254 
buf
[ 
mi16Lí
++ ] = 
	`GET_LOW_BYTE
–
ønge
 );

256 
ønge
 = (
U16
Ë
	`GëR™ge
( 3 );

257 
buf
[ 
mi16Lí
++ ] = 
	`GET_HIGH_BYTE
–
ønge
 );

258 
buf
[ 
mi16Lí
++ ] = 
	`GET_LOW_BYTE
–
ønge
 );

260 
ønge
 = (
U16
Ë
	`GëR™ge
( 4 );

261 
buf
[ 
mi16Lí
++ ] = 
	`GET_HIGH_BYTE
–
ønge
 );

262 
buf
[ 
mi16Lí
++ ] = 
	`GET_LOW_BYTE
–
ønge
 );

264 
ønge
 = (
U16
Ë
	`GëR™ge
( 5 );

265 
buf
[ 
mi16Lí
++ ] = 
	`GET_HIGH_BYTE
–
ønge
 );

266 
buf
[ 
mi16Lí
++ ] = 
	`GET_LOW_BYTE
–
ønge
 );

268 
ønge
 = (
U16
Ë
	`GëR™ge
( 6 );

269 
buf
[ 
mi16Lí
++ ] = 
	`GET_HIGH_BYTE
–
ønge
 );

270 
buf
[ 
mi16Lí
++ ] = 
	`GET_LOW_BYTE
–
ønge
 );

274 
buf
[ 
mi16Lí
++ ] = 0;

275 
buf
[ 
mi16Lí
++ ] = 0;

277 
buf
[ 
mi16Lí
++ ] = 
ETX
;

279  
mi16Lí
;

280 
	}
}

282 
I16
 
	$MakePktAckCÆi
–
U8
 *
buf
 )

284 
I16
 
mi16Lí
 = 0;

287 
buf
[ 
mi16Lí
++ ] = 
STX
;

290 
buf
[ 
mi16Lí
++ ] = 
PKT_TOF_ACK_CALI
;

294 
buf
[ 
mi16Lí
++ ] = 0;

295 
buf
[ 
mi16Lí
++ ] = 0;

297 
buf
[ 
mi16Lí
++ ] = 
ETX
;

299  
mi16Lí
;

300 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_tof.h

1 #i‚de‡
__PARSER_TOF_H__


2 
	#__PARSER_TOF_H__


	)

4 
	~"¥j_ty≥.h
"

5 
	~"comm.h
"

8 
	#PKT_TOF_REQ
 0x01

	)

9 
	#PKT_TOF_ACK
 0x81

	)

11 
	#PKT_TOF_REQ_CALI
 0x02

	)

12 
	#PKT_TOF_ACK_CALI
 0x82

	)

14 
I16
 
IsVÆidPkt_TOF
–
U8
 *
buf
, I16 
Àn
 );

15 
I16
 
P¨£rPkt_TOF
–
U8
 *
buf
, I16 
Àn
);

16 
I16
 
Crc16_TOF
–
U8
 *
buf
, I16 
Àn
 );

17 
I16
 
MakePkt_TOF
–
CommHódî_T
 *
p_comm
, 
U8
 *
buf
 );

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\config.h

1 #i‚de‡
__CONFIG_H__


2 
	#__CONFIG_H__


	)

9 
	#CONFIG_TEST
 0

10 
	#CONFIG_MMI
 0

11 
	#CONFIG_TEST_LED
 0

12 
	#CONFIG_TEST_SAVING
 0

13 
	#CONFIG_TEST_TEMP_READ
 0

14 
	#CONFIG_TEST_FILTER
 0

15 

	)

17 
	#CONFIG_TEST_FLOW_METER
 1

	)

20 
	#CONFIG_ERR_ALL
 1

	)

23 
	#DEBUG_COMM
 1

	)

26 
	#VERSION
 1

	)

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\eeprom\eeprom.c

1 
	~"hÆ_ì¥om.h
"

2 
	~"ì¥om.h
"

3 
	~"utû.h
"

4 
	~"¸c16.h
"

6 
	~"îr‹.h
"

10 
	#EEP_ADDR_OFFSET
 0x0010

	)

16 
	mEEP_BLOCK_NONE
,

17 
	mEEP_BLOCK_0
,

18 
	mEEP_BLOCK_1
,

23 
	mNUM_EEP_BLOCK


24 } 
	tEïromBlock_T
;

26 
	s_ì¥om_c⁄åﬁ_


29 
U8
 
	mInô
;

30 
U8
 
	mWrôe
;

31 
U8
 
	mEø£
;

32 
U8
 
	mFa˘‹yRe£t
;

34 
U16
 
	mDñayTime
;

35 
U8
 
	mRódD©a
[ 
EEP_PAGE_SIZE
 ];

36 
U8
 
	mWrôeD©a
[ 
EEP_PAGE_SIZE
 ];

37 } 
	tEEP_C⁄åﬁ_T
;

40 
EEP_C⁄åﬁ_T
 
	gEï
;

43 
U8
 
RódD©aBlocks
();

44 
U8
 
WrôeD©aBlocks
();

45 
InôBlockTabÀAŒSë
();

47 
	$InôEïrom
()

49 
Eï
.
Inô
 = 
FALSE
;

50 
Eï
.
Eø£
 = 
FALSE
;

51 
Eï
.
Fa˘‹yRe£t
 = 
FALSE
;

53 if–
	`RódD©aBlocks
(Ë=
TRUE
 )

56 
Eï
.
Inô
 = 
TRUE
;

61 
Eï
.
Fa˘‹yRe£t
 = 
TRUE
;

63 
	`InôBlockTabÀAŒSë
();

64 
	`WrôeD©aBlocks
();

70 
Eï
.
Wrôe
 = 
FALSE
;

71 
Eï
.
DñayTime
 = 0;

72 
	}
}

74 
	s_ì¥om_block_m≠_


76 
EïromId_T
 
	mid
;

77 
EïromBlock_T
 
	mblockId
;

78 } 
	tEïromM≠_T
;

80 c⁄° 
EïromM≠_T
 
	gEïromM≠pögTabÀ
[] =

82 { 
EEP_ID_CONF_MAKE_COLD
, 
EEP_BLOCK_0
 },

83 { 
EEP_ID_CONF_MAKE_HOT
, 
EEP_BLOCK_0
 },

84 { 
EEP_ID_CONF_POWER_SAVING
, 
EEP_BLOCK_0
 },

85 { 
EEP_ID_CONF_UNUSED_SAVE
, 
EEP_BLOCK_0
 },

86 { 
EEP_ID_HOT_ALTITUDE
, 
EEP_BLOCK_0
 },

88 { 
EEP_ID_MEMENTO_1
, 
EEP_BLOCK_1
 },

89 { 
EEP_ID_MEMENTO_2
, 
EEP_BLOCK_1
 },

90 { 
EEP_ID_MEMENTO_3
, 
EEP_BLOCK_1
 },

91 { 
EEP_ID_MEMENTO_4
, 
EEP_BLOCK_1
 },

92 { 
EEP_ID_MEMENTO_5
, 
EEP_BLOCK_1
 },

95 
	#SZ_EEPROM_MAPPING_TABLE
 ((
EïromM≠pögTabÀ
)/(
EïromM≠_T
))

	)

98 
EïromBlock_T
 
	$GëBlockId
(
EïromId_T
 
mu8Id
 )

100 
U8
 
i
;

102  
i
 = 0; i < 
SZ_EEPROM_MAPPING_TABLE
; i++ )

104 if–
mu8Id
 =
EïromM≠pögTabÀ
[ 
i
 ].
id
 )

106  
EïromM≠pögTabÀ
[ 
i
 ].
blockId
;

110  
EEP_BLOCK_NONE
;

111 
	}
}

114 
	$U8
 (*
	tA˘i⁄_T
)(
	tEïromBlock_T
);

115 
	s_ì¥om_block_èbÀ_


117 
EïromBlock_T
 
blockId
;

118 
U8
 
wrôe
;

119 
A˘i⁄_T
 
pWrôeA˘i⁄
;

120 
A˘i⁄_T
 
pRódA˘i⁄
;

121 }
	tEïBlockTabÀ_T
;

123 
U8
 
	`WrôeBlock0
(
EïromBlock_T
 
mBlockId
);

124 
U8
 
	`RódBlock0
(
EïromBlock_T
 
mBlockId
);

125 
U8
 
	`WrôeBlock1
(
EïromBlock_T
 
mBlockId
);

126 
U8
 
	`RódBlock1
(
EïromBlock_T
 
mBlockId
);

128 
U8
 
	`WrôeBlock2
(
EïromBlock_T
 
mBlockId
);

129 
U8
 
	`RódBlock2
(
EïromBlock_T
 
mBlockId
);

130 
U8
 
	`WrôeBlock3
(
EïromBlock_T
 
mBlockId
);

131 
U8
 
	`RódBlock3
(
EïromBlock_T
 
mBlockId
);

132 
U8
 
	`WrôeBlock4
(
EïromBlock_T
 
mBlockId
);

133 
U8
 
	`RódBlock4
(
EïromBlock_T
 
mBlockId
);

136 
EïBlockTabÀ_T
 
EïromBlockTabÀLi°
[] =

138 { 
EEP_BLOCK_0
, 
FALSE
, 
WrôeBlock0
, 
RódBlock0
 },

139 { 
EEP_BLOCK_1
, 
FALSE
, 
WrôeBlock1
, 
RódBlock1
 },

140 
	}
};

141 
	#SZ_BLOCK_TABLE
 ((
EïromBlockTabÀLi°
)/(
EïBlockTabÀ_T
))

	)

143 
	$InôBlockTabÀAŒSë
()

145 
U8
 
i
;

147  
i
 = 0; i < 
SZ_BLOCK_TABLE
; i++ )

149 
EïromBlockTabÀLi°
[ 
i
 ].
wrôe
 = 
TRUE
;

151 
	}
}

153 
	$SëBlockWrôe
–
EïromBlock_T
 
muBlockId
 )

155 
U8
 
i
;

157  
i
 = 0; i < 
SZ_BLOCK_TABLE
; i++ )

159 if–
muBlockId
 =
EïromBlockTabÀLi°
[ 
i
 ].
blockId
 )

161 
EïromBlockTabÀLi°
[ 
i
 ].
wrôe
 = 
TRUE
;

164 
	}
}

167 
	$SaveEïromId
–
EïromId_T
 
mu8Id
 )

169 
EïromBlock_T
 
muBlockId
;

171 if–
mu8Id
 > 
EEP_ID_NUM
 )

176 
Eï
.
DñayTime
 = 1;

177 
Eï
.
Wrôe
 = 
TRUE
;

179 
muBlockId
 = 
	`GëBlockId
–
mu8Id
 );

180 if–
muBlockId
 !
EEP_BLOCK_NONE
 )

182 
	`SëBlockWrôe
–
muBlockId
 );

184 
	}
}

186 
	$Eø£Eïrom
()

188 
Eï
.
Wrôe
 = 
TRUE
;

189 
Eï
.
Eø£
 = 
TRUE
;

190 
	}
}

193 
U8
 
	$EïromPageWrôe
–
U16
 
mu16Addr
, 
U8
 *
pD©a
 )

200 
mu16Addr
 +
EEP_ADDR_OFFSET
;

201  
	`HAL_RTC_PageWrôe
–
DEV_ADDR_EEP
, 
mu16Addr
, 
pD©a
, 
EEP_PAGE_SIZE
);

202 
	}
}

204 
U8
 
	$EïromSeqRód
–
U16
 
mu16Addr
, 
U8
 *
pD©a
, U8 
mu16Lígth
 )

211 
mu16Addr
 +
EEP_ADDR_OFFSET
;

212  
	`HAL_RTC_SeqRód
–
DEV_ADDR_EEP
, 
mu16Addr
, 
pD©a
, 
mu16Lígth
 );

213 
	}
}

216 
U8
 
	$WrôeBlock0
(
EïromBlock_T
 
mBlockId
)

218 
U16
 
mu16CheckSum
 = 0U;

220 
Eï
.
WrôeD©a
[ 0 ] = 0;

221 
Eï
.
WrôeD©a
[ 1 ] = 0;

222 
Eï
.
WrôeD©a
[ 2 ] = 0;

223 
Eï
.
WrôeD©a
[ 3 ] = 0;

224 
Eï
.
WrôeD©a
[ 4 ] = 0;

225 
Eï
.
WrôeD©a
[ 5 ] = 0;

226 
Eï
.
WrôeD©a
[ 6 ] = 0;

227 
Eï
.
WrôeD©a
[ 7 ] = 0;

228 
mu16CheckSum
 = 
	`¸c16_ˇl
–&
Eï
.
WrôeD©a
[0], (
EEP_PAGE_SIZE
 - 2) );

230 
Eï
.
WrôeD©a
[
EEP_PAGE_SIZE
 - 2] = 
	`GET_HIGH_BYTE
–
mu16CheckSum
 );

231 
Eï
.
WrôeD©a
[
EEP_PAGE_SIZE
 - 1] = 
	`GET_LOW_BYTE
–
mu16CheckSum
 );

235  
	`EïromPageWrôe
–((
U16
)
mBlockId
 * 
EEP_PAGE_SIZE
Ë, &
Eï
.
WrôeD©a
[0] );

236 
	}
}

238 
U8
 
	$RódBlockId
(
U8
 
mu8BlockId
, U8 *
pBuf
)

240 
U8
 
mu8Rë
;

241 
U16
 
mu16SrcChksum
 = 0U;

242 
U16
 
mu16CÆcChksum
 = 0U;

246 
mu8Rë
 = 
	`EïromSeqRód
–((
U16
)
mu8BlockId
 * 
EEP_PAGE_SIZE
 ), 
pBuf
, EEP_PAGE_SIZE );

247 if–
mu8Rë
 =
FALSE
 )

249  
FALSE
;

253 
mu16SrcChksum
 = 
	`GET_UINT_WORD
–
pBuf
[
EEP_PAGE_SIZE
 - 1],ÖBuf[EEP_PAGE_SIZE - 2] );

254 
mu16CÆcChksum
 = 
	`¸c16_ˇl
–
pBuf
, (
EEP_PAGE_SIZE
 - 2) );

255 if–
mu16SrcChksum
 !
mu16CÆcChksum
 )

257  
FALSE
;

260  
TRUE
;

261 
	}
}

263 
U8
 
	$RódBlock0
(
EïromBlock_T
 
mBlockId
)

265 
U8
 
mu8Rë
;

267 
mu8Rë
 = 
	`RódBlockId
–
mBlockId
, &
Eï
.
RódD©a
[0] );

268 if–
mu8Rë
 =
FALSE
 )

270  
FALSE
;

279  
TRUE
;

280 
	}
}

282 
U8
 
	$WrôeBlock1
(
EïromBlock_T
 
mBlockId
)

284 
U16
 
mu16CheckSum
 = 0U;

287 
Memíto_T
 
mMemíto
;

290 
	`GëMemítoEº‹
–0, &
mMemíto
 );

291 
Eï
.
WrôeD©a
[ 0 ] = 
mMemíto
.
Eº‹
;

294 
	`GëMemítoEº‹
–1, &
mMemíto
 );

295 
Eï
.
WrôeD©a
[ 1 ] = 
mMemíto
.
Eº‹
;

298 
	`GëMemítoEº‹
–2, &
mMemíto
 );

299 
Eï
.
WrôeD©a
[ 2 ] = 
mMemíto
.
Eº‹
;

302 
	`GëMemítoEº‹
–3, &
mMemíto
 );

303 
Eï
.
WrôeD©a
[ 3 ] = 
mMemíto
.
Eº‹
;

306 
	`GëMemítoEº‹
–4, &
mMemíto
 );

307 
Eï
.
WrôeD©a
[ 4 ] = 
mMemíto
.
Eº‹
;

310 
mu16CheckSum
 = 
	`¸c16_ˇl
–&
Eï
.
WrôeD©a
[0], (
EEP_PAGE_SIZE
 - 2) );

312 
Eï
.
WrôeD©a
[
EEP_PAGE_SIZE
 - 2] = 
	`GET_HIGH_BYTE
–
mu16CheckSum
 );

313 
Eï
.
WrôeD©a
[
EEP_PAGE_SIZE
 - 1] = 
	`GET_LOW_BYTE
–
mu16CheckSum
 );

317  
	`EïromPageWrôe
–((
U16
)
mBlockId
 * 
EEP_PAGE_SIZE
Ë, &
Eï
.
WrôeD©a
[0] );

318 
	}
}

320 
U8
 
	$RódBlock1
(
EïromBlock_T
 
mBlockId
)

322 
U8
 
mu8Rë
;

323 
Memíto_T
 
mMemíto
;

326 
mu8Rë
 = 
	`RódBlockId
–
mBlockId
, &
Eï
.
RódD©a
[0] );

327 if–
mu8Rë
 =
FALSE
 )

329  
FALSE
;

333 
mMemíto
.
D©e
.
u16Yór
 = 0;

334 
mMemíto
.
D©e
.
u8M⁄th
 = 0;

335 
mMemíto
.
D©e
.
u8D©e
 = 0;

338 
mMemíto
.
Eº‹
 = 
Eï
.
RódD©a
[0];

339 
	`SëMemítoEº‹
–0, 
mMemíto
.
Eº‹
, &mMemíto.
D©e
 );

341 
mMemíto
.
Eº‹
 = 
Eï
.
RódD©a
[1];

342 
	`SëMemítoEº‹
–1, 
mMemíto
.
Eº‹
, &mMemíto.
D©e
 );

344 
mMemíto
.
Eº‹
 = 
Eï
.
RódD©a
[2];

345 
	`SëMemítoEº‹
–2, 
mMemíto
.
Eº‹
, &mMemíto.
D©e
 );

347 
mMemíto
.
Eº‹
 = 
Eï
.
RódD©a
[3];

348 
	`SëMemítoEº‹
–3, 
mMemíto
.
Eº‹
, &mMemíto.
D©e
 );

350 
mMemíto
.
Eº‹
 = 
Eï
.
RódD©a
[4];

351 
	`SëMemítoEº‹
–4, 
mMemíto
.
Eº‹
, &mMemíto.
D©e
 );

354  
TRUE
;

355 
	}
}

358 
U8
 
	$WrôeD©aBlocks
()

360 
U8
 
i
 = 0;

361 vﬁ©ûê
U8
 
mu8Rë
 = 
TRUE
;

362 
EïromBlock_T
 
mBlockId
;

364  
i
 = 0; i < 
SZ_BLOCK_TABLE
 ; i++ )

366 if–
EïromBlockTabÀLi°
[ 
i
 ].
wrôe
 =
TRUE
 )

368 if–
EïromBlockTabÀLi°
[ 
i
 ].
pWrôeA˘i⁄
 !
NULL
 )

370 
mBlockId
 = 
EïromBlockTabÀLi°
[ 
i
 ].
blockId
;

371 
mu8Rë
 = 
EïromBlockTabÀLi°
[ 
i
 ].
	`pWrôeA˘i⁄
–
mBlockId
 );

372 if–
mu8Rë
 =
TRUE
 )

374 
EïromBlockTabÀLi°
[ 
i
 ].
wrôe
 = 
FALSE
;

379 
EïromBlockTabÀLi°
[ 
i
 ].
wrôe
 = 
FALSE
;

384  
TRUE
;

385 
	}
}

388 
U8
 
	$RódD©aBlocks
()

390 
U8
 
i
 = 0;

391 vﬁ©ûê
U8
 
mu8Rë
 = 
TRUE
;

392 
EïromBlock_T
 
mBlockId
;

395  
i
 = 0; i < 
SZ_BLOCK_TABLE
 ; i++ )

397 if–
EïromBlockTabÀLi°
[ 
i
 ].
pRódA˘i⁄
 !
NULL
 )

399 
mBlockId
 = 
EïromBlockTabÀLi°
[ 
i
 ].
blockId
;

400 
mu8Rë
 = 
EïromBlockTabÀLi°
[ 
i
 ].
	`pRódA˘i⁄
–
mBlockId
 );

401 if–
mu8Rë
 =
FALSE
 )

403  
FALSE
;

408  
TRUE
;

409 
	}
}

412 
	$Pro˚ssEïrom
()

429 if–
Eï
.
Wrôe
 =
FALSE
 )

435 if–
Eï
.
DñayTime
 != 0 )

437 
Eï
.
DñayTime
--;

444 if–
Eï
.
Eø£
 =
TRUE
 )

447 if–
	`HAL_RTC_EEPROM_AŒEø£
(Ë=
TRUE
 )

449 
Eï
.
Wrôe
 = 
FALSE
;

450 
Eï
.
Eø£
 = 
FALSE
;

451 
	`Re£t
();

456 
	`WrôeD©aBlocks
();

457 
Eï
.
Wrôe
 = 
FALSE
;

461 
	}
}

463 
U8
 
	$Te°Eïrom
()

465 vﬁ©ûê
U8
 
mu8Rë
 = 0;

466 vﬁ©ûê
U8
 
mu8Ród
 = 0;

467 
U16
 
mu16Addr
;

473 
mu16Addr
 = (
EEP_BLOCK_0
 * 
EEP_PAGE_SIZE
Ë+ 
EEP_ADDR_OFFSET
;

474 
	`HAL_RTC_ByãWrôe
–
DEV_ADDR_EEP
, 
mu16Addr
, 0x12 );

475 
	`HAL_RTC_ByãRód
–
DEV_ADDR_EEP
, 
mu16Addr
, &
mu8Ród
 );

478 if–
mu8Ród
 == 0x12 )

480  
TRUE
;

483  
FALSE
;

484 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\eeprom\eeprom.h

1 #i‚de‡
__EEPROM_H__


2 
	#__EEPROM_H__


	)

4 
	~"¥j_ty≥.h
"

9 
	mEEP_ID_LOCK_ALL
,

10 
	mEEP_ID_LOCK_HOT
,

11 
	mEEP_ID_CONF_DECO_LED
,

12 
	mEEP_ID_FACTORY_SETUP
,

14 
	mEEP_ID_CONF_MAKE_COLD
,

15 
	mEEP_ID_CONF_MAKE_HOT
,

16 
	mEEP_ID_CONF_POWER_SAVING
,

17 
	mEEP_ID_CONF_UNUSED_SAVE
,

18 
	mEEP_ID_HOT_ALTITUDE
,

20 
	mEEP_ID_MEMENTO_1
,

21 
	mEEP_ID_MEMENTO_2
,

22 
	mEEP_ID_MEMENTO_3
,

23 
	mEEP_ID_MEMENTO_4
,

24 
	mEEP_ID_MEMENTO_5
,

26 
	mEEP_ID_NUM


27 } 
	tEïromId_T
;

29 
InôEïrom
();

31 
SaveEïromId
–
EïromId_T
 
mu8Id
 );

33 
Eø£Eïrom
();

35 
Pro˚ssEïrom
();

37 
U8
 
Te°Eïrom
();

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_room_level.c

1 
	~"îr_room_Àvñ.h
"

2 
	~"Àvñ.h
"

5 
U8
 
	ggu8EºCou¡Limô
 = 
DEFAULT_ROOM_ERR_COUNT
;

7 
	$SëRoomEºCou¡Limô
(
U8
 
mu8Cou¡
)

9 
gu8EºCou¡Limô
 = 
mu8Cou¡
;

10 
	}
}

12 
U8
 
	$GëRoomEºCou¡Limô
()

14  
gu8EºCou¡Limô
;

15 
	}
}

19 
U8
 
	$CheckEºRoomOvf
(
U8
 
mu8Eº‹
)

21 
U8
 
mu8Cou¡
;

24 
mu8Cou¡
 = 
	`GëT™kLevñEº‹Cou¡
–
LEVEL_ID_ROOM
, 
ERR_TYPE_OVF
 );

25 if–
mu8Cou¡
 >
gu8EºCou¡Limô
 )

27  
TRUE
;

29  
mu8Eº‹
;

30 
	}
}

32 
U8
 
	$Rñó£EºRoomOvf
(
U8
 
mu8Eº‹
)

34 
U8
 
mu8Cou¡
;

37 
mu8Cou¡
 = 
	`GëT™kLevñEº‹Cou¡
–
LEVEL_ID_ROOM
, 
ERR_TYPE_OVF
 );

38 if–
mu8Cou¡
 == 0 )

40  
FALSE
;

42  
mu8Eº‹
;

43 
	}
}

47 
U8
 
	$CheckEºRoomCom∂ex
(
U8
 
mu8Eº‹
)

49 
U8
 
mu8Cou¡
;

52 
mu8Cou¡
 = 
	`GëT™kLevñEº‹Cou¡
–
LEVEL_ID_ROOM
, 
ERR_TYPE_COMPLEX
 );

53 if–
mu8Cou¡
 >
gu8EºCou¡Limô
 )

55  
TRUE
;

57  
mu8Eº‹
;

58 
	}
}

60 
U8
 
	$Rñó£EºRoomCom∂ex
(
U8
 
mu8Eº‹
)

62 
U8
 
mu8Cou¡
;

65 
mu8Cou¡
 = 
	`GëT™kLevñEº‹Cou¡
–
LEVEL_ID_ROOM
, 
ERR_TYPE_COMPLEX
 );

66 if–
mu8Cou¡
 == 0 )

68  
FALSE
;

70  
mu8Eº‹
;

71 
	}
}

74 
U8
 
	$CheckEºRoomHigh
(
U8
 
mu8Eº‹
)

76 
U8
 
mu8Cou¡
;

79 
mu8Cou¡
 = 
	`GëT™kLevñEº‹Cou¡
–
LEVEL_ID_ROOM
, 
ERR_TYPE_HIGH
 );

80 if–
mu8Cou¡
 >
gu8EºCou¡Limô
 )

82  
TRUE
;

84  
mu8Eº‹
;

85 
	}
}

87 
U8
 
	$Rñó£EºRoomHigh
(
U8
 
mu8Eº‹
)

89 
U8
 
mu8Cou¡
;

92 
mu8Cou¡
 = 
	`GëT™kLevñEº‹Cou¡
–
LEVEL_ID_ROOM
, 
ERR_TYPE_HIGH
 );

93 if–
mu8Cou¡
 == 0 )

95  
FALSE
;

97  
mu8Eº‹
;

98 
	}
}

101 
U8
 
	$CheckEºRoomLow
(
U8
 
mu8Eº‹
)

103 
U8
 
mu8Cou¡
;

106 
mu8Cou¡
 = 
	`GëT™kLevñEº‹Cou¡
–
LEVEL_ID_ROOM
, 
ERR_TYPE_LOW
 );

107 if–
mu8Cou¡
 >= 1 )

109  
TRUE
;

111  
mu8Eº‹
;

112 
	}
}

114 
U8
 
	$Rñó£EºRoomLow
(
U8
 
mu8Eº‹
)

116 
U8
 
mu8Cou¡
;

119 
mu8Cou¡
 = 
	`GëT™kLevñEº‹Cou¡
–
LEVEL_ID_ROOM
, 
ERR_TYPE_LOW
 );

120 if–
mu8Cou¡
 == 0 )

122  
FALSE
;

124  
mu8Eº‹
;

125 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_room_level.h

1 #i‚de‡
__ERR_ROOM_LEVEL_H__


2 
	#__ERR_ROOM_LEVEL_H__


	)

4 
	~"¥j_ty≥.h
"

7 
	#DEFAULT_ROOM_ERR_COUNT
 3

	)

8 
SëRoomEºCou¡Limô
(
U8
 
mu8Cou¡
);

9 
U8
 
GëRoomEºCou¡Limô
();

12 
U8
 
CheckEºRoomOvf
(U8 
mu8Eº‹
);

13 
U8
 
Rñó£EºRoomOvf
(U8 
mu8Eº‹
);

15 
U8
 
CheckEºRoomCom∂ex
(U8 
mu8Eº‹
);

16 
U8
 
Rñó£EºRoomCom∂ex
(U8 
mu8Eº‹
);

18 
U8
 
CheckEºRoomLow
(U8 
mu8Eº‹
);

19 
U8
 
Rñó£EºRoomLow
(U8 
mu8Eº‹
);

21 
U8
 
CheckEºRoomHigh
(U8 
mu8Eº‹
);

22 
U8
 
Rñó£EºRoomHigh
(U8 
mu8Eº‹
);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp.c

1 
	~"îr_ãmp.h
"

9 
	#ADC_10BIT_TOP
 985

	)

10 
	#ADC_10BIT_BOTTOM
 41

	)

12 
U8
 
	$GëTempEº‹Ty≥
(
U16
 
mu16Adc
)

14 if–
mu16Adc
 > 
ADC_10BIT_TOP
 )

16  
STATUS_SHORT
;

18 if–
mu16Adc
 < 
ADC_10BIT_BOTTOM
 )

20  
STATUS_OPEN
;

23  
STATUS_NORMAL
;

24 
	}
}

27 
U8
 
	$CheckEº‹Temp
(
U8
 
mu8Eº‹
, 
U16
 
mu16Adc
, U8 *
pBuf
)

29 
U8
 
mu8Index
;

32 
mu8Index
 = 
	`GëTempEº‹Ty≥
–
mu16Adc
 );

33 if–
mu8Index
 !
pBuf
[0] )

35 
pBuf
[0] = 
mu8Index
;

37 
pBuf
[1] = 
COUNT_NUM
;

38 
pBuf
[2] = 
COUNT_NUM
;

39 
pBuf
[3] = 
COUNT_NUM
;

40  
mu8Eº‹
;

43 if–
pBuf
[ 
mu8Index
 ] != 0 )

45 
pBuf
[ 
mu8Index
 ]--;

48 if–
pBuf
[ 
mu8Index
 ] == 0 )

50 if–
mu8Index
 =
STATUS_NORMAL
 )

52 
mu8Eº‹
 = 
FALSE
;

56 
mu8Eº‹
 = 
TRUE
;

60  
mu8Eº‹
;

61 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp.h

1 #i‚de‡
__ERR_TEMP_H__


2 
	#__ERR_TEMP_H__


	)

4 
	~"¥j_ty≥.h
"

7 
	#STATUS_NORMAL
 1

	)

8 
	#STATUS_OPEN
 2

	)

9 
	#STATUS_SHORT
 3

	)

10 
U8
 
GëTempEº‹Ty≥
(
U16
 
mu16Adc
);

12 
	#COUNT_NUM
 30

	)

13 
U8
 
CheckEº‹Temp
(U8 
mu8Eº‹
, 
U16
 
mu16Adc
, U8 *
pTimîBuf
);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp_cold_water.c

1 
	~"îr_ãmp_cﬁd_w©î.h
"

2 
	~"îr_ãmp.h
"

3 
	~"hÆ_adc.h
"

4 
	~"cﬁd_w©î.h
"

5 
	~"ãmp.h
"

7 
U8
 
	gmu8Cou¡Li°
[4] =

10 
COUNT_NUM
,

11 
COUNT_NUM
,

12 
COUNT_NUM


15 
U8
 
	$CheckEºTempCﬁdW©î
(
U8
 
mu8Eº‹
)

17 
U16
 
mu16Adc
;

19 if–
	`GëCﬁdW©îC⁄figMake
(Ë=
FALSE
 )

21  
FALSE
;

23 
mu16Adc
 = 
	`HAL_GëAdcVÆue
–
ANI_TEMP_COLD_WATER
 );

24  
	`CheckEº‹Temp
–
mu8Eº‹
, 
mu16Adc
, 
mu8Cou¡Li°
 );

25 
	}
}

27 
U8
 
	$Rñó£EºTempCﬁdW©î
(
U8
 
mu8Eº‹
 )

29 if–
	`GëCﬁdW©îC⁄figMake
(Ë=
FALSE
 )

31  
FALSE
;

35 
	`Tu∫OnTempSís‹
–
TEMP_ID_COLD_WATER
, 10 );

37  
	`CheckEºTempCﬁdW©î
–
mu8Eº‹
 );

38 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp_cold_water.h

1 #i‚de‡
__ERR_TEMP_COLD_WATER_H__


2 
	#__ERR_TEMP_COLD_WATER_H__


	)

4 
	~"¥j_ty≥.h
"

6 
U8
 
CheckEºTempCﬁdW©î
(U8 
mu8Eº‹
);

8 
U8
 
Rñó£EºTempCﬁdW©î
(U8 
mu8Eº‹
);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp_hot_water.c

1 
	~"îr_ãmp_hŸ_w©î.h
"

2 
	~"îr_ãmp.h
"

3 
	~"hÆ_adc.h
"

4 
	~"hŸ_w©î.h
"

6 
U8
 
	gmu8Cou¡Li°
[4] =

9 
COUNT_NUM
,

10 
COUNT_NUM
,

11 
COUNT_NUM


14 
U8
 
	$CheckEºTempHŸW©î
(
U8
 
mu8Eº‹
)

16 
U16
 
mu16Adc
;

18 if–
	`GëHŸW©îC⁄figMake
(Ë=
FALSE
 )

20  
FALSE
;

22 
mu16Adc
 = 
	`HAL_GëAdcVÆue
–
ANI_TEMP_HOT_WATER
 );

23  
	`CheckEº‹Temp
–
mu8Eº‹
, 
mu16Adc
, 
mu8Cou¡Li°
 );

24 
	}
}

26 
U8
 
	$Rñó£EºTempHŸW©î
(
U8
 
mu8Eº‹
)

29 if–
	`GëHŸW©îC⁄figMake
(Ë=
FALSE
 )

31  
FALSE
;

34  
	`CheckEºTempHŸW©î
(
mu8Eº‹
);

35 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp_hot_water.h

1 #i‚de‡
__ERR_TEMP_HOT_WATER_H__


2 
	#__ERR_TEMP_HOT_WATER_H__


	)

4 
	~"¥j_ty≥.h
"

6 
U8
 
CheckEºTempHŸW©î
(U8 
mu8Eº‹
);

8 
U8
 
Rñó£EºTempHŸW©î
(U8 
mu8Eº‹
);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\error.c

1 
	~"îr‹.h
"

2 
	~"ì¥om.h
"

3 
	~"time_sh‹t.h
"

6 
Eº‹_T
 
	gEº
;

8 
	$InôEº‹
()

10 
	`mem£t
–&
Eº
, 0, –
Eº‹_T
 ));

11 
	}
}

13 
	$GëEº‹D©a
(
Eº‹_T
 *
pD©a
)

15 
	`mem˝y
–
pD©a
, &
Eº
, –
Eº‹_T
));

16 
	}
}

18 
	$SëEº‹Sètus
(
Eº‹Id_T
 
mId
, 
U8
 
mu8Sètus
)

20 if–
mId
 < 
ERR_NUM
 )

22 
Eº
.
Sètus
[ 
mId
 ] = 
mu8Sètus
;

24 
	}
}

26 
	$SëEº‹SètusD©e
(
Eº‹Id_T
 
mId
, 
U8
 
mu8Sètus
, 
Eº‹D©e_T
 *
pD©e
)

28 if–
mId
 < 
ERR_NUM
 )

30 
Eº
.
Sètus
[ 
mId
 ] = 
mu8Sètus
;

31 
	`mem˝y
–&
Eº
.
SètusD©e
[ 
mId
 ], 
pD©e
, –
Eº‹D©e_T
 ));

33 
	}
}

35 
U8
 
	$GëEº‹Sètus
(
Eº‹Id_T
 
mId
)

37  
Eº
.
Sètus
[ 
mId
 ];

38 
	}
}

40 
	$GëEº‹SètusD©e
(
Eº‹Id_T
 
mId
, 
Eº‹D©e_T
 *
pD©e
)

42 if–
mId
 < 
ERR_NUM
 )

44 
	`mem˝y
–
pD©e
, &
Eº
.
SètusD©e
[ 
mId
 ], –
Eº‹D©e_T
 ));

46 
	}
}

48 
U8
 
	$IsEº‹
(
Eº‹Id_T
 
mId
 )

50  
Eº
.
Sètus
[ 
mId
 ];

51 
	}
}

53 
Eº‹Id_T
 
	$GëEº‹Id
()

55  
Eº
.
Eº‹Id
;

56 
	}
}

58 
	$SëEº‹Id
(
Eº‹Id_T
 
mEºId
)

60 
Eº
.
Eº‹Id
 = 
mEºId
;

61 
	}
}

63 
U8
 
	$GëEº‹Di•œyId
(
Eº‹Id_T
 
mEºId
)

65 
U8
 
mu8Eº‹Code
 = 0;

68  
mEºId
 )

70 
ERR_ROOM_LOW_LEVEL
: 
mu8Eº‹Code
 = 11; ;

71 
ERR_ROOM_HIGH_LEVEL
: 
mu8Eº‹Code
 = 13; ;

72 
ERR_ROOM_COMPLEX
: 
mu8Eº‹Code
 = 14; ;

73 
ERR_ROOM_OVF
: 
mu8Eº‹Code
 = 10; ;

74 
ERR_LEAK
: 
mu8Eº‹Code
 = 1; ;

75 
ERR_TEMP_COLD_WATER
: 
mu8Eº‹Code
 = 44; ;

76 
ERR_TEMP_ROOM_WATER
: 
mu8Eº‹Code
 = 42; ;

77 
ERR_TEMP_AMBIENT
: 
mu8Eº‹Code
 = 43; ;

79 
ERR_DRAIN_PUMP
: 
mu8Eº‹Code
 = 60; ;

80 
ERR_TEMP_EVA_2
: 
mu8Eº‹Code
 = 63; ;

81 
ERR_TEMP_EVA_1
: 
mu8Eº‹Code
 = 63; ;

82 
ERR_COLD_LOW_LEVEL
: 
mu8Eº‹Code
 = 20; ;

83 
ERR_SODA_PUMP
: 
mu8Eº‹Code
 = 94; ;

84 
ERR_MICRO_SW_DETECT
: 
mu8Eº‹Code
 = 61; ;

85 
ERR_MICRO_SW_MOVE
: 
mu8Eº‹Code
 = 62; ;

89 : 
mu8Eº‹Code
 = 0; ;

94  
mu8Eº‹Code
;

95 
	}
}

97 
	$GëEº‹D©e
(
Eº‹D©e_T
 *
pD©e
)

100 
TimeD©a_T
 
mTime
;

102 if–
pD©e
 !
NULL
 )

104 
	`GëRtcTime
–&
mTime
 );

106 
pD©e
->
u16Yór
 = 
mTime
.
Yór
 + 2000;

107 
pD©e
->
u8M⁄th
 = 
mTime
.
M⁄th
;

108 
pD©e
->
u8D©e
 = 
mTime
.
D©e
;

111 
	}
}

113 
U8
 
	$IsEm±yMemítoEº‹
()

115 
U8
 
mu8Num
;

116 
Memíto_T
 
mMemíto
;

118 
mu8Num
 = 
MEMENTO_LIST_NUM
 - 1;

119 
	`GëMemítoEº‹
–
mu8Num
, &
mMemíto
 );

120 if–
mMemíto
.
Eº‹
 =
ERR_NONE
 )

122  
TRUE
;

125  
FALSE
;

126 
	}
}

128 
U8
 
	$GëMemítoEº‹
(
U8
 
mu8Index
, 
Memíto_T
 *
pMemíto
)

130 if–
mu8Index
 < 
MEMENTO_LIST_NUM
 )

132 
	`mem˝y
–
pMemíto
, &
Eº
.
MemítoLi°
[ 
mu8Index
 ], –
Memíto_T
 ));

133  
TRUE
;

136  
FALSE
;

137 
	}
}

139 
	$SëMemítoEº‹
(
U8
 
mu8Index
, 
Eº‹Id_T
 
mEº‹
, 
Eº‹D©e_T
 *
pD©e
 )

141 if–
mu8Index
 >
MEMENTO_LIST_NUM
 )

146 if–
mEº‹
 >
ERR_NUM
 )

151 
Eº
.
MemítoLi°
[ 
mu8Index
 ].
Eº‹
 = 
mEº‹
;

152 
	`mem˝y
–&
Eº
.
MemítoLi°
[ 
mu8Index
 ].
D©e
, 
pD©e
, –
Eº‹D©e_T
 ));

153 
	}
}

155 
	$CÀ¨MemítoEº‹
()

157 
U8
 
i
;

158 
Eº‹D©e_T
 
mD©e
;

160 
	`mem£t
–&
mD©e
, 0, –
Eº‹D©e_T
 ));

161  
i
 = 0; i < 
MEMENTO_LIST_NUM
 ; i++ )

163 
	`SëMemítoEº‹
–
i
, 
ERR_NONE
, &
mD©e
 );

164 
	`SaveEïromId
–
EEP_ID_MEMENTO_1
 );

165 
	`SaveEïromId
–
EEP_ID_MEMENTO_2
 );

166 
	`SaveEïromId
–
EEP_ID_MEMENTO_3
 );

167 
	`SaveEïromId
–
EEP_ID_MEMENTO_4
 );

168 
	`SaveEïromId
–
EEP_ID_MEMENTO_5
 );

170 
	}
}

172 
	$Upd©eMemítoEº‹
–
Memíto_T
 *
pMemíto
 )

174 if–
pMemíto
->
Eº‹
 !
ERR_NONE
 )

178 if–
Eº
.
MemítoLi°
[ 
MEMENTO_LIST_NUM
 - 1 ].
Eº‹
 !
pMemíto
->Error )

182 
	`mem˝y
–&
Eº
.
MemítoLi°
[ 0 ], &Eº.MemítoLi°[1], –
Memíto_T
 ) * (
MEMENTO_LIST_NUM
 - 1) );

183 
	`mem˝y
–&
Eº
.
MemítoLi°
[ 
MEMENTO_LIST_NUM
 - 1 ], 
pMemíto
, –
Memíto_T
 ) );

185 
	`SaveEïromId
–
EEP_ID_MEMENTO_1
 );

186 
	`SaveEïromId
–
EEP_ID_MEMENTO_2
 );

187 
	`SaveEïromId
–
EEP_ID_MEMENTO_3
 );

188 
	`SaveEïromId
–
EEP_ID_MEMENTO_4
 );

189 
	`SaveEïromId
–
EEP_ID_MEMENTO_5
 );

192 
	}
}

196 
U8
 
	$IsEº‹Ty≥NosFìd
()

199 if–
	`IsEº‹
–
ERR_ROOM_OVF
 ) =
TRUE


200 || 
	`IsEº‹
–
ERR_ROOM_COMPLEX
 ) =
TRUE


201 || 
	`IsEº‹
–
ERR_ROOM_HIGH_LEVEL
 ) =
TRUE


202 || 
	`IsEº‹
–
ERR_ROOM_LOW_LEVEL
 ) =
TRUE


206  
TRUE
;

209  
FALSE
;

210 
	}
}

215 
U8
 
	$IsEº‹Ty≥CﬁdW©î
()

217 if–
	`IsEº‹
–
ERR_TEMP_COLD_WATER
 ) =
TRUE


218 || 
	`IsEº‹
–
ERR_ROOM_COMPLEX
 ) =
TRUE


219 || 
	`IsEº‹
–
ERR_ROOM_HIGH_LEVEL
 ) =
TRUE


220 || 
	`IsEº‹
–
ERR_ROOM_OVF
 ) =
TRUE


221 || 
	`IsEº‹
–
ERR_ROOM_LOW_LEVEL
 ) =
TRUE


224  
TRUE
;

227  
FALSE
;

228 
	}
}

231 
U8
 
	$IsEº‹Ty≥HŸW©î
()

233 if–
	`IsEº‹
–
ERR_TEMP_HOT_WATER
 ) =
TRUE


234 || 
	`IsEº‹
–
ERR_ROOM_COMPLEX
 ) =
TRUE


235 || 
	`IsEº‹
–
ERR_ROOM_HIGH_LEVEL
 ) =
TRUE


236 || 
	`IsEº‹
–
ERR_ROOM_OVF
 ) =
TRUE


237 || 
	`IsEº‹
–
ERR_ROOM_LOW_LEVEL
 ) =
TRUE


240  
TRUE
;

244  
FALSE
;

245 
	}
}

248 
U8
 
	$IsEº‹Ty≥CﬁdW©î
()

251 if–
	`GëTimeSh‹tSètus
(Ë=
FALSE
 )

253 if–
	`IsEº‹
–
ERR_ROOM_COMPLEX
 ) =
TRUE


254 || 
	`IsEº‹
–
ERR_ROOM_HIGH_LEVEL
 ) =
TRUE


255 || 
	`IsEº‹
–
ERR_ROOM_OVF
 ) =
TRUE


256 || 
	`IsEº‹
–
ERR_ROOM_LOW_LEVEL
 ) =
TRUE
 )

258  
TRUE
;

262 if–
	`IsEº‹
–
ERR_TEMP_COLD_WATER
 ) =
TRUE
 )

264  
TRUE
;

267  
FALSE
;

268 
	}
}

271 
U8
 
	$IsEº‹Ty≥HŸW©î
()

274 if–
	`GëTimeSh‹tSètus
(Ë=
FALSE
 )

276 if–
	`IsEº‹
–
ERR_ROOM_COMPLEX
 ) =
TRUE


277 || 
	`IsEº‹
–
ERR_ROOM_HIGH_LEVEL
 ) =
TRUE


278 || 
	`IsEº‹
–
ERR_ROOM_OVF
 ) =
TRUE


279 || 
	`IsEº‹
–
ERR_ROOM_LOW_LEVEL
 ) =
TRUE
 )

281  
TRUE
;

285 if–
	`IsEº‹
–
ERR_TEMP_HOT_WATER
 ) =
TRUE
 )

287  
TRUE
;

291  
FALSE
;

292 
	}
}

295 
U8
 
	$IsEº‹Ty≥I˚
()

298 if–
	`IsEº‹
–
ERR_TEMP_ROOM_WATER
 ) =
TRUE


299 || 
	`IsEº‹
–
ERR_TEMP_AMBIENT
 ) =
TRUE


300 || 
	`IsEº‹
–
ERR_ROOM_COMPLEX
 ) =
TRUE


301 || 
	`IsEº‹
–
ERR_ROOM_HIGH_LEVEL
 ) =
TRUE


302 || 
	`IsEº‹
–
ERR_ROOM_OVF
 ) =
TRUE


303 || 
	`IsEº‹
–
ERR_ROOM_LOW_LEVEL
 ) =
TRUE


304 || 
	`IsEº‹
–
ERR_DRAIN_PUMP
 ) =
TRUE


305 || 
	`IsEº‹
–
ERR_MICRO_SW_DETECT
 ) =
TRUE


306 || 
	`IsEº‹
–
ERR_MICRO_SW_MOVE
 ) =
TRUE


307 || 
	`IsEº‹
–
ERR_LEAK
 ) =
TRUE


310  
TRUE
;

314  
FALSE
;

315 
	}
}

317 
U8
 
	$IsEº‹Ty≥Soda
()

320 if–
	`IsEº‹
–
ERR_COLD_LOW_LEVEL
 ) =
TRUE
 )

322  
TRUE
;

326  
FALSE
;

327 
	}
}

329 
U8
 
	$IsEº‹Ty≥DøöW©î
()

332 if–
	`IsEº‹
–
ERR_ROOM_COMPLEX
 ) =
TRUE


333 || 
	`IsEº‹
–
ERR_ROOM_HIGH_LEVEL
 ) =
TRUE


334 || 
	`IsEº‹
–
ERR_ROOM_OVF
 ) =
TRUE


335 || 
	`IsEº‹
–
ERR_ROOM_LOW_LEVEL
 ) =
TRUE


336 || 
	`IsEº‹
–
ERR_COLD_LOW_LEVEL
 ) =
TRUE


337 || 
	`IsEº‹
–
ERR_DRAIN_PUMP
 ) =
TRUE


338 || 
	`IsEº‹
–
ERR_LEAK
 ) =
TRUE


341  
TRUE
;

345  
FALSE
;

346 
	}
}

348 
U8
 
	$IsEº‹Ty≥Sãr
()

351 if–
	`IsEº‹Ty≥DøöW©î
(Ë=
TRUE
 )

353  
TRUE
;

356 if–
	`IsEº‹
–
ERR_NFC_COMM
 ) =
TRUE
 )

358  
TRUE
;

362  
FALSE
;

363 
	}
}

367 
	$Upd©eNewEº‹
(
U8
 
mu8Eº‹
)

369 
Memíto_T
 
mMemíto
;

373 if–
mu8Eº‹
 =
ERR_TEMP_EVA_1


374 || 
mu8Eº‹
 =
ERR_TEMP_EVA_2
 )

380 if–
Eº
.
Eº‹Id
 !
mu8Eº‹
 )

382 
Eº
.
PªvEº‹Id
 = Eº.
Eº‹Id
;

384 
mMemíto
.
Eº‹
 = 
mu8Eº‹
;

385 
	`GëEº‹SètusD©e
–
mMemíto
.
Eº‹
, &mMemíto.
D©e
 );

390 
Eº
.
Eº‹Id
 = 
mu8Eº‹
;

391 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\error.h

1 #i‚de‡
__ERROR_H__


2 
	#__ERROR_H__


	)

4 
	~"¥j_ty≥.h
"

12 
	e_îr‹_id_


14 
	mERR_NONE
,

16 
	mERR_TEMP_COLD_WATER
,

17 
	mERR_TEMP_HOT_WATER
,

21 
	mERR_ROOM_COMPLEX
,

22 
	mERR_ROOM_HIGH_LEVEL
,

23 
	mERR_ROOM_LOW_LEVEL
,

24 
	mERR_ROOM_OVF
,

26 
	mERR_NUM


27 } 
	tEº‹Id_T
;

30 
	s_îr‹_d©e_


32 
U16
 
	mu16Yór
;

33 
U8
 
	mu8M⁄th
;

34 
U8
 
	mu8D©e
;

35 } 
	tEº‹D©e_T
;

37 
	s_memíto_


39 
Eº‹Id_T
 
	mEº‹
;

40 
Eº‹D©e_T
 
	mD©e
;

41 } 
	tMemíto_T
;

44 
	#MEMENTO_LIST_NUM
 5

	)

45 
	s_îr‹_


47 
Eº‹Id_T
 
	mPªvEº‹Id
;

48 
Eº‹Id_T
 
	mEº‹Id
;

49 
Eº‹D©e_T
 
	mEº‹D©e
;

51 
U8
 
	mSètus
[ 
ERR_NUM
 ];

52 
Eº‹D©e_T
 
	mSètusD©e
[ 
ERR_NUM
 ];

56 
Memíto_T
 
	mMemítoLi°
[ 
MEMENTO_LIST_NUM
 ];

57 }
	tEº‹_T
;

60 
InôEº‹
();

62 
GëEº‹D©a
(
Eº‹_T
 *
pD©a
);

64 
SëEº‹Sètus
(
Eº‹Id_T
 
mId
, 
U8
 
mu8Sètus
);

65 
SëEº‹SètusD©e
(
Eº‹Id_T
 
mId
, 
U8
 
mu8Sètus
, 
Eº‹D©e_T
 *
pD©e
);

67 
U8
 
GëEº‹Sètus
(
Eº‹Id_T
 
mId
);

68 
GëEº‹SètusD©e
(
Eº‹Id_T
 
mId
, 
Eº‹D©e_T
 *
pD©e
);

70 
Eº‹Id_T
 
GëEº‹Id
();

71 
SëEº‹Id
(
Eº‹Id_T
 
mEºId
);

72 
U8
 
GëEº‹Di•œyId
(
Eº‹Id_T
 
mEºId
);

73 
GëEº‹D©e
(
Eº‹D©e_T
 *
pD©e
);

77 
U8
 
IsEm±yMemítoEº‹
();

78 
U8
 
GëMemítoEº‹
(U8 
mu8Index
, 
Memíto_T
 *
pMemíto
);

79 
SëMemítoEº‹
(
U8
 
mu8Index
, 
Eº‹Id_T
 
mEº‹
, 
Eº‹D©e_T
 *
pD©e
 );

80 
CÀ¨MemítoEº‹
();

82 
U8
 
IsEº‹
(
Eº‹Id_T
 
mId
 );

83 
U8
 
IsEº‹Ty≥NosFìd
();

84 
U8
 
IsEº‹Ty≥CﬁdW©î
();

85 
U8
 
IsEº‹Ty≥HŸW©î
();

86 
U8
 
IsEº‹Ty≥I˚
();

87 
U8
 
IsEº‹Ty≥Soda
();

88 
U8
 
IsEº‹Ty≥DøöW©î
();

89 
U8
 
IsEº‹Ty≥Sãr
();

91 
Upd©eNewEº‹
(
U8
 
mu8Eº‹
);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\process_error.c

1 
	~"¥o˚ss_îr‹.h
"

2 
	~"îr‹.h
"

4 
	~"ì¥om.h
"

5 
	~"Àvñ.h
"

6 
	~"time_sh‹t.h
"

8 
	~"îr_ãmp_cﬁd_w©î.h
"

9 
	~"îr_ãmp_hŸ_w©î.h
"

10 
	~"îr_room_Àvñ.h
"

14 
	$U8
 (*
	tEºFun_T
)(
	tU8
 
	tmu8Eº‹
);

15 
	s_îr‹_li°_


17 
Eº‹Id_T
 
Id
;

18 
U8
 
PªvEº‹
;

19 
U8
 
Eº‹
;

20 
U8
 
SãrA˘ive
;

21 
U8
 
Di•A˘ive
;

23 
EºFun_T
 
Check
;

24 
EºFun_T
 
Rñó£
;

25 } 
	tEº‹Li°_T
;

27 
	$InôEº‹Li°
()

29 
	`InôEº‹
();

30 
	}
}

32 
U8
 
Rñó£EºRoomOvfEx
(U8 
mu8Eº‹
);

33 
U8
 
Rñó£EºRoomCom∂exEx
(U8 
mu8Eº‹
);

34 
U8
 
Rñó£EºRoomHighEx
(U8 
mu8Eº‹
);

35 
U8
 
Rñó£EºRoomLowEx
(U8 
mu8Eº‹
);

38 
Eº‹Li°_T
 
	gEºLi°
[] =

41 { 
ERR_ROOM_COMPLEX
, 
FALSE
, FALSE, 
TRUE
, TRUE, 
CheckEºRoomCom∂ex
, 
Rñó£EºRoomCom∂exEx
 },

42 { 
ERR_ROOM_HIGH_LEVEL
, 
FALSE
, FALSE, 
TRUE
, TRUE, 
CheckEºRoomHigh
, 
Rñó£EºRoomHighEx
 },

43 { 
ERR_ROOM_LOW_LEVEL
, 
FALSE
, FALSE, 
TRUE
, TRUE, 
CheckEºRoomLow
, 
Rñó£EºRoomLowEx
 },

44 { 
ERR_ROOM_OVF
, 
FALSE
, FALSE, 
TRUE
, TRUE, 
CheckEºRoomOvf
, 
Rñó£EºRoomOvfEx
 },

45 { 
ERR_TEMP_COLD_WATER
, 
FALSE
, FALSE, 
TRUE
, TRUE, 
CheckEºTempCﬁdW©î
, 
Rñó£EºTempCﬁdW©î
 },

46 { 
ERR_TEMP_HOT_WATER
, 
FALSE
, FALSE, 
TRUE
, TRUE, 
CheckEºTempHŸW©î
, 
Rñó£EºTempHŸW©î
 }

48 
	#SZ_ERR_LIST
 ((
EºLi°
)/(
Eº‹Li°_T
))

	)

51 
Eº‹Id_T
 
	$FödCheckEº‹
–
Eº‹Li°_T
 *
pEºLi°
, 
U16
 
mu16Size
 )

53 
U8
 
i
;

54 
EºFun_T
 
pCheck
;

55 
EºFun_T
 
pRñó£
;

56 
Eº‹Id_T
 
mId
 = 
ERR_NONE
;

57 
Eº‹Id_T
 
mNewId
 = 
ERR_NONE
;

58 
U8
 
mu8Eº‹
 = 
FALSE
;

60 
Eº‹Li°_T
 *
pLi°
 = 
NULL
;

64  
i
 = 0; i < 
mu16Size
; i++ )

66 
pLi°
 = (
pEºLi°
 + 
i
 );

69 
mId
 = 
pLi°
->
Id
;

70 
mu8Eº‹
 = 
pLi°
->
Eº‹
;

71 
pCheck
 = 
pLi°
->
Check
;

72 
pRñó£
 = 
pLi°
->
Rñó£
;

74 #i‡
CONFIG_STER


75 if–
	`IsSèπSãr
(Ë=
TRUE
 )

77 if–
pLi°
->
SãrA˘ive
 =
FALSE
 )

84 if–
mu8Eº‹
 =
TRUE
 )

86 #i‡
CONFIG_STER


87 if–
	`GëSãrEºW©îOut
(Ë=
FALSE
 )

90 if–
pRñó£
 !
NULL
 )

92 
mu8Eº‹
 = 
	`pRñó£
( mu8Error );

98 if–
pCheck
 !
NULL
 )

100 
mu8Eº‹
 = 
	`pCheck
( mu8Error );

105 if–
pLi°
->
PªvEº‹
 !
mu8Eº‹
 )

107 
pLi°
->
PªvEº‹
 =ÖLi°->
Eº‹
;

108 
pLi°
->
Eº‹
 = 
mu8Eº‹
;

110 
	`SëEº‹Sètus
–
mId
, 
pLi°
->
Eº‹
 );

114 if–
pLi°
->
Di•A˘ive
 =
TRUE
 )

117 if–
	`GëEº‹Sètus
–
mId
 ) =
TRUE
 )

119 
mNewId
 = 
mId
;

125  
mNewId
;

126 
	}
}

129 
	$Pro˚ssEº‹
()

131 #i‡
CONFIG_ERR_ALL


132 
Eº‹Id_T
 
mNewId
 = 
ERR_NONE
;

135 
mNewId
 = 
	`FödCheckEº‹
–&
EºLi°
[0], 
SZ_ERR_LIST
 );

138 
	`Upd©eNewEº‹
–
mNewId
 );

140 
	}
}

143 
U8
 
	$Rñó£EºRoomOvfEx
(
U8
 
mu8Eº‹
)

145 if–
	`GëTimeSh‹tSètus
(Ë=
FALSE
 )

147  
mu8Eº‹
;

150  
	`Rñó£EºRoomOvf
–
mu8Eº‹
 );

151 
	}
}

153 
U8
 
	$Rñó£EºRoomCom∂exEx
(
U8
 
mu8Eº‹
)

155 if–
	`GëTimeSh‹tSètus
(Ë=
FALSE
 )

157  
mu8Eº‹
;

160  
	`Rñó£EºRoomCom∂ex
–
mu8Eº‹
 );

161 
	}
}

163 
U8
 
	$Rñó£EºRoomHighEx
(
U8
 
mu8Eº‹
)

165 if–
	`GëTimeSh‹tSètus
(Ë=
FALSE
 )

167  
mu8Eº‹
;

170  
	`Rñó£EºRoomHigh
–
mu8Eº‹
 );

171 
	}
}

173 
U8
 
	$Rñó£EºRoomLowEx
(
U8
 
mu8Eº‹
)

175 if–
	`GëTimeSh‹tSètus
(Ë=
FALSE
 )

177  
mu8Eº‹
;

180  
	`Rñó£EºRoomLow
–
mu8Eº‹
 );

181 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\process_error.h

1 #i‚de‡
__PROCESS_ERROR_H__


2 
	#__PROCESS_ERROR_H__


	)

4 
	~"¥j_ty≥.h
"

7 
InôEº‹Li°
();

8 
Pro˚ssEº‹
();

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\fct.c

1 
	~"f˘.h
"

4 
	#DEFAULT_LIMIT_TIME_VALUE
 30U

	)

5 
	#DEFAULT_TEST_TIME_VALUE
 1800U

	)

8 
	s_f˘_


10 
U8
 
	mSètus
;

11 
U16
 
	mLimôTimî
;

12 
U16
 
	mTe°Timî
;

15 
U32
 
	mI≈utTe°
;

16 } 
	tF˘_T
;

18 
F˘_T
 
	gf˘
;

21 
	$InôF˘
()

23 
f˘
.
Sètus
 = 
FALSE
;

24 
f˘
.
LimôTimî
 = 
DEFAULT_LIMIT_TIME_VALUE
;

25 
f˘
.
Te°Timî
 = 
DEFAULT_TEST_TIME_VALUE
;

26 
f˘
.
I≈utTe°
 = 0UL;

27 
	}
}

29 
	$SèπF˘
()

31 if–
f˘
.
LimôTimî
 == 0 )

36 
f˘
.
Sètus
 = 
TRUE
;

37 
	}
}

39 
	$St›F˘
()

41 
f˘
.
Sètus
 = 
FALSE
;

42 
	}
}

44 
U8
 
	$IsExpúedF˘LimôTimî
()

46 if–
f˘
.
LimôTimî
 != 0 )

48  
FALSE
;

50  
TRUE
;

51 
	}
}

53 
U8
 
	$GëF˘Sètus
()

55  
f˘
.
Sètus
;

56 
	}
}

58 
	$SëF˘Te°Timî
(
U16
 
mu16Time
)

60 
f˘
.
Te°Timî
 = 
mu16Time
;

61 
	}
}

63 
U16
 
	$GëF˘Te°Timî
()

65  
f˘
.
Te°Timî
;

66 
	}
}

70 
	$SëF˘Te°I≈utBô
(
U32
 
mu32MaskBô
)

72 
f˘
.
I≈utTe°
 |
mu32MaskBô
;

73 
	}
}

75 
	$CÀ¨F˘Te°I≈utBô
(
U32
 
mu32MaskBô
)

77 
f˘
.
I≈utTe°
 &~
mu32MaskBô
;

78 
	}
}

80 
	$SëF˘Te°I≈utVÆ
(
U32
 
mu32MaskBô
)

82 
f˘
.
I≈utTe°
 = 
mu32MaskBô
;

83 
	}
}

85 
U8
 
	$IsSëF˘Te°I≈utVÆ
–
U32
 
mu32MaskBô
 )

87 if–(
f˘
.
I≈utTe°
 & 
mu32MaskBô
) != 0 )

89  
TRUE
;

92  
FALSE
;

93 
	}
}

95 
U32
 
	$GëF˘Te°I≈utVÆ
()

97  
f˘
.
I≈utTe°
;

98 
	}
}

101 
	$Upd©eF˘Timî
()

103 if–
f˘
.
LimôTimî
 != 0 )

105 
f˘
.
LimôTimî
--;

107 if–
f˘
.
Te°Timî
 != 0 )

109 
f˘
.
Te°Timî
--;

111 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\fct.h

1 #i‚de‡
__FCT_H__


2 
	#__FCT_H__


	)

4 
	~"¥j_ty≥.h
"

6 
InôF˘
();

8 
SèπF˘
();

9 
St›F˘
();

10 
U8
 
IsExpúedF˘LimôTimî
();

11 
U8
 
GëF˘Sètus
();

13 
SëF˘Te°Timî
(
U16
 
mu16Time
);

14 
U16
 
GëF˘Te°Timî
();

18 
	#MK_FCT_KEY_BACK
 0x00000001UL

	)

19 
	#MK_FCT_KEY_SETTING
 0x00000002UL

	)

20 
	#MK_FCT_KEY_LEFT
 0x00000004UL

	)

21 
	#MK_FCT_KEY_RIGHT
 0x00000008UL

	)

23 
	#MK_FCT_KEY_ROOM
 0x00000010UL

	)

24 
	#MK_FCT_KEY_COLD
 0x00000020UL

	)

25 
	#MK_FCT_KEY_CONTY
 0x00000040UL

	)

26 
	#MK_FCT_KEY_SODA
 0x00000080UL

	)

28 
	#MK_FCT_KEY_USER
 0x00000100UL

	)

29 
	#MK_FCT_LEVER_WATER
 0x00000200UL

	)

30 
	#MK_FCT_LEVER_ICE
 0x00000400UL

	)

31 
	#MK_FCT_TANK_OPEN
 0x00000800UL

	)

33 
	#MK_FCT_EEPROM
 0x00001000UL

	)

34 
	#MK_FCT_LCD_MUTE
 0x00002000UL

	)

35 
	#MK_FCT_LCD_COLD
 0x00004000UL

	)

36 
	#MK_FCT_LCD_SAVING
 0x00008000UL

	)

38 
	#MK_FCT_LCD_ERROR
 0x00010000UL

	)

39 
	#MK_FCT_LCD_ICE
 0x00020000UL

	)

40 
	#MK_FCT_LCD_LOW
 0x00040000UL

	)

42 
	#MK_FCT_ALL
 0x0007FFFFUL

	)

43 
SëF˘Te°I≈utBô
(
U32
 
mu32MaskBô
);

44 
CÀ¨F˘Te°I≈utBô
(
U32
 
mu32MaskBô
);

45 
SëF˘Te°I≈utVÆ
(
U32
 
mu32MaksBô
);

46 
U8
 
IsSëF˘Te°I≈utVÆ
–
U32
 
mu32MaskBô
 );

47 
U32
 
GëF˘Te°I≈utVÆ
();

50 
Upd©eF˘Timî
();

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\key_fct_handler.c

1 
	~"key_f˘_h™dÀr.h
"

2 
	~"key.h
"

3 
	~"key_comm⁄_h™dÀr.h
"

4 
	~"di•œy.h
"

5 
	~"sound.h
"

6 
	~"¥o˚ss_f˘.h
"

8 
SëKeyBô
(
U32
 
mu32MaskBô
 );

9 
U8
 
FCT_Room
();

10 
U8
 
FCT_Cﬁd
();

11 
U8
 
FCT_C⁄ty
();

13 
U8
 
FCT_Soda
();

14 
U8
 
FCT_U£r
();

15 
U8
 
FCT_Back
();

16 
U8
 
FCT_Sëtög
();

17 
U8
 
FCT_Le·
();

18 
U8
 
FCT_Right
();

21 c⁄° 
KeyEvítLi°_T
 
	gFCT_KeyEvítLi°
[] =

27 { 
K_COLD
, 
FCT_Cﬁd
, 
NULL
, NULL, NULL, NULL, NULL }

31 
U8
 
	$IsVÆidF˘KeyC⁄dôi⁄
(
U16
 
mu16Key
)

34  
TRUE
;

35 
	}
}

37 * 
	$GëF˘KeyEvítLi°
()

39  (*)
FCT_KeyEvítLi°
;

40 
	}
}

42 
U8
 
	$GëF˘KeyEvítLi°Size
()

44  ( (
FCT_KeyEvítLi°
Ë/ (
KeyEvítLi°_T
) );

45 
	}
}

47 
	$SëKeyBô
(
U32
 
mu32MaskBô
 )

49 
U32
 
mu32I≈utVÆ
;

52 
mu32I≈utVÆ
 = 
	`GëF˘Te°I≈utVÆ
();

53 if–(
mu32I≈utVÆ
 & 
mu32MaskBô
 ) != 0 )

55 
	`CÀ¨F˘Te°I≈utBô
–
mu32MaskBô
 );

59 
	`SëF˘Te°I≈utBô
–
mu32MaskBô
 );

61 
	}
}

63 
U8
 
	$FCT_Room
()

65 
	`SëKeyBô
–
MK_FCT_KEY_ROOM
 );

68 
	`CÀ¨F˘Te°I≈utBô
–
MK_FCT_KEY_COLD
 );

69 
	`CÀ¨F˘Te°I≈utBô
–
MK_FCT_KEY_SODA
 );

70  
SOUND_SELECT
;

71 
	}
}

73 
U8
 
	$FCT_Cﬁd
()

75 
	`SëKeyBô
–
MK_FCT_KEY_COLD
 );

77 
	`CÀ¨F˘Te°I≈utBô
–
MK_FCT_KEY_ROOM
 );

78 
	`CÀ¨F˘Te°I≈utBô
–
MK_FCT_KEY_SODA
 );

80  
SOUND_SELECT
;

81 
	}
}

83 
U8
 
	$FCT_C⁄ty
()

85 
	`SëKeyBô
–
MK_FCT_KEY_CONTY
 );

87  
SOUND_SELECT
;

88 
	}
}

90 
U8
 
	$FCT_Soda
()

92 
	`SëKeyBô
–
MK_FCT_KEY_SODA
 );

94 
	`CÀ¨F˘Te°I≈utBô
–
MK_FCT_KEY_ROOM
 );

95 
	`CÀ¨F˘Te°I≈utBô
–
MK_FCT_KEY_COLD
 );

97  
SOUND_SELECT
;

98 
	}
}

100 
U8
 
	$FCT_U£r
()

102 
	`SëKeyBô
–
MK_FCT_KEY_USER
 );

104  
SOUND_SELECT
;

105 
	}
}

107 
U8
 
	$FCT_Back
()

109 
	`SëKeyBô
–
MK_FCT_KEY_BACK
 );

111  
SOUND_SELECT
;

112 
	}
}

114 
U8
 
	$FCT_Sëtög
()

116 
	`SëKeyBô
–
MK_FCT_KEY_SETTING
 );

118  
SOUND_SELECT
;

119 
	}
}

121 
U8
 
	$FCT_Le·
()

123 
	`SëKeyBô
–
MK_FCT_KEY_LEFT
 );

125  
SOUND_SELECT
;

126 
	}
}

128 
U8
 
	$FCT_Right
()

130 
	`SëKeyBô
–
MK_FCT_KEY_RIGHT
 );

132  
SOUND_SELECT
;

133 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\key_fct_handler.h

1 #i‚de‡
__KEY_FCT_HANDLER_H__


2 
	#__KEY_FCT_HANDLER_H__


	)

4 
	~"¥j_ty≥.h
"

5 
	~"f˘.h
"

8 
U8
 
IsVÆidF˘KeyC⁄dôi⁄
(
U16
 
mu16Key
);

10 * 
GëF˘KeyEvítLi°
();

12 
U8
 
GëF˘KeyEvítLi°Size
();

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\process_fct.c

1 
	~"hw.h
"

2 
	~"¥o˚ss_f˘.h
"

3 
	~"f˘.h
"

5 
	~"hÆ_adc.h
"

7 
	~"key.h
"

8 
	~"ì¥om.h
"

9 
	~"utû.h
"

10 
	~"comm.h
"

11 
	~"timî.h
"

12 
	~"di•œy.h
"

13 
	~"ãmp.h
"

15 
	~"vÆve.h
"

16 
	~"ªœy.h
"

19 
U8
 
	$IsExpúedTe°Time
()

21 if–
	`GëF˘Te°Timî
() != 0 )

23  
FALSE
;

26  
TRUE
;

27 
	}
}

30 
	$InôLﬂd
()

33 
U8
 
mu8Rë
;

36 /
	`R_UART1_St›
();

39 
	`Clo£VÆve
–
VALVE_ALL
 );

40 
	`O≥nVÆve
–
VALVE_NOS
 );

43 
	`Tu∫OffRñayAŒ
();

46 
mu8Rë
 = 
	`Te°Eïrom
();

47 if–
mu8Rë
 =
TRUE
 )

49 
	`SëF˘Te°I≈utBô
–
MK_FCT_EEPROM
 );

53 
	`CÀ¨F˘Te°I≈utBô
–
MK_FCT_EEPROM
 );

56 
	}
}

60 
	$Pro˚ssF˘LﬂdTe°
()

64 
	`Tu∫OffAŒLED
();

73 if–
	`IsSëF˘Te°I≈utVÆ
–
MK_FCT_EEPROM
 ) =
TRUE
 )

83 if–
	`HAL_GëAdcVÆue
–
ANI_SENSOR_PHOTO
 ) < 650 )

94 if–
	`IsSëF˘Te°I≈utVÆ
–
MK_FCT_KEY_COLD
 ) =
TRUE
 )

106 if–
	`GET_ROOM_TANK_HIGH
(Ë=
HIGH
 )

111 if–
	`GET_ROOM_TANK_LOW
(Ë=
HIGH
 )

123 if–
	`GET_ROOM_TANK_OVERFLOW
(Ë=
HIGH
 )

135 if–
	`GëTemp
–
TEMP_ID_COLD_WATER
 ) >= 8.0f

136 && 
	`GëTemp
–
TEMP_ID_COLD_WATER
 ) <= 12.0f )

145 
	}
}

148 
	$Pro˚ssF˘
()

150 
U8
 
mu8Inô
 = 0;

153 if–
	`IsExpúedTe°Time
(Ë=
TRUE
 )

155 
	`Re£t
();

159 if–
mu8Inô
 == 0 )

161 
mu8Inô
 = 1;

162 
	`InôLﬂd
();

164 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\process_fct.h

1 #i‚de‡
__PROCESS_FCT_H__


2 
	#__PROCESS_FCT_H__


	)

4 
	~"¥j_ty≥.h
"

6 
Pro˚ssF˘LﬂdTe°
();

8 
Pro˚ssF˘
();

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap04vt_api.c

7 
	~"gp2≠04vt_≠i.h
"

8 
	~"gp2≠04vt_fúmw¨e.h
"

14 
	$gp2≠04vt_öô_∑øms
(
gp2≠04vt_£ns‹
 *
pdev
)

16 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

18 i‡(
pd©a
->
mode
 =
MODE_OFFSET_CALIBRATION
) {

19 
pd©a
->
£ns‹_°©us
 = 
NOT_CALIBRATED
;

20 
pd©a
->
off£t_u£r
 = 0;

21 
pd©a
->
off£t_0p1mm
 = 0;

22 
pd©a
->
xèlk_u£r
 = 0;

25 i‡(
pd©a
->
mode
 =
MODE_XTALK_CALIBRATION
) {

26 
pd©a
->
xèlk_u£r
 = 0;

28 
	}
}

34 
	$gp2≠04vt_öô_£ns‹
(
gp2≠04vt_£ns‹
 *
pdev
)

36 
uöt8_t
 
wd©a
;

37 
uöt8_t
 
wd©a_mu…i
[4] = {0x00, 0x00, 0x00, 0x00};

39 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

41 
	`gp2≠04vt_öô_∑øms
(
pdev
);

45 
wd©a
 = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

46 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

47 
	`DELAY_FUNCTION
(1);

50 
wd©a
 = 0x38; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

51 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

54 
wd©a_mu…i
[0] = 0x00;

55 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

58 
wd©a
 = 0x40; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

61 
wd©a_mu…i
[0] = 0x00;

62 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

65 
wd©a_mu…i
[0] = 
SET_CONV1
;

66 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

68 
wd©a_mu…i
[0] = 
SET_CONV2
;

69 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

72 
wd©a
 = 0x40; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

73 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

76 
wd©a_mu…i
[0] = 0x07;

77 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

80 
wd©a
 = 0x2C; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

81 
wd©a
 = 0x02; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

83 
wd©a_mu…i
[0] = 
SET_TH_PROX
;

84 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

86 
wd©a_mu…i
[0] = 
SET_TH_RANGE_L
;

87 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

89 
wd©a_mu…i
[0] = 
SET_TH_RANGE_H
;

90 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

92 
wd©a_mu…i
[0] = 
SET_TH_HYS
;

93 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

97 
wd©a
 = 0x1C; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

98 
wd©a
 = 0x03; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

100 i‡(
pd©a
->
mode
 =
MODE_OFFSET_CALIBRATION
) {

101 
wd©a_mu…i
[0] = 
OFFSET_CALIBRAION_DISTANCE_MM
;

103 
wd©a_mu…i
[0] = 0x00;

105 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

108 
wd©a
 = 0xA4; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

109 
wd©a
 = 0x02; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

111 i‡(
pd©a
->
mode
 =
MODE_XTALK_CALIBRATION
) {

112 
wd©a_mu…i
[0] = 0x01;

114 
wd©a_mu…i
[0] = 0x00;

116 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

118 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

119 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

120 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

121 
wd©a
 = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

122 
	`DELAY_FUNCTION
(1);

125 
	`gp2≠04vt_£t_off£t_d©a
(
pdev
);

126 
	`gp2≠04vt_£t_xèlk_d©a
(
pdev
);

129 
wd©a
 = 
SET_INTERRUPT
;

130 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

131 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x02, &wdata, 1);

132 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x03, &wdata, 1);

133 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

134 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x05, &wdata, 1);

135 
wd©a
 = 
SET_INTERVAL
 & 0xFF;

136 
	`gp2≠_i2c_wrôe
(
pdev
, 0x06, &
wd©a
, 1);

137 
wd©a
 = (((
uöt16_t
)
SET_INTERVAL
 & 0xFF00) >> 8);

138 
	`gp2≠_i2c_wrôe
(
pdev
, 0x07, &
wd©a
, 1);

139 
wd©a
 = 0x10; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x08, &wdata, 1);

140 
wd©a
 = 0x68; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x09, &wdata, 1);

141 
wd©a
 = 0x0F; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0A, &wdata, 1);

142 
wd©a
 = 0xBE; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0B, &wdata, 1);

143 
wd©a
 = 0x04; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0C, &wdata, 1);

144 
wd©a
 = 0x08; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0D, &wdata, 1);

145 
wd©a
 = 
SET_VCSEL
;

146 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0E, &
wd©a
, 1);

147 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0F, &wdata, 1);

148 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x10, &wdata, 1);

149 
wd©a
 = 0x70; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x11, &wdata, 1);

150 
wd©a
 = 
SET_VCSEL
;

151 
	`gp2≠_i2c_wrôe
(
pdev
, 0x12, &
wd©a
, 1);

152 
wd©a
 = 0x05; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x13, &wdata, 1);

153 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x14, &wdata, 1);

154 
wd©a
 = 0x02; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x15, &wdata, 1);

155 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x16, &wdata, 1);

156 
wd©a
 = 0x11; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x17, &wdata, 1);

157 
wd©a
 = 0xBF; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x18, &wdata, 1);

158 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x19, &wdata, 1);

159 
wd©a
 = 0x70; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1A, &wdata, 1);

160 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1B, &wdata, 1);

161 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1C, &wdata, 1);

162 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1D, &wdata, 1);

163 
wd©a
 = 0x04; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1E, &wdata, 1);

165 #ifde‡
__KERNEL__


166 
wd©a
 = 0x04; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x46, &wdata, 1);

169 
	`gp2≠04vt_£t_vs1
(
pdev
);

170 
	}
}

172 
	$gp2≠04vt_£t_vs1
(
gp2≠04vt_£ns‹
 *
pdev
)

174 
uöt8_t
 
rd©a
;

175 
uöt8_t
 
wd©a
;

176 
uöt8_t
 
mode
;

177 
uöt8_t
 
i
;

178 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

180 
mode
 = 
pd©a
->mode;

182 
i
 = 0; i < 3; i++) {

183 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_ON
);

185 
	`DELAY_FUNCTION
(20);

187 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_OFF
);

189 
	`gp2≠04vt_ªad_öã∫Æ_ˇlibøti⁄
(
pdev
);

191 i‡(
pd©a
->
vs1
 != 0) {

196 
	`gp2≠_i2c_ªad
(
pdev
, 0x0C, &
rd©a
, (rdata));

197 
wd©a
 = (0x01 | (0xFE & 
rd©a
));

198 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0C, &
wd©a
, 1);

199 
wd©a
 = 
pd©a
->
vs1
;

200 
	`gp2≠_i2c_wrôe
(
pdev
, 0x10, &
wd©a
, 1);

202 
pd©a
->
mode
 = mode;

203 
	}
}

211 
	$gp2≠04vt_˛ór_ˇlibøti⁄_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

213 
pdev
->
d©a
.
£ns‹_°©us
 = 0;

214 
pdev
->
d©a
.
off£t_u£r
 = 0;

215 
pdev
->
d©a
.
off£t_0p1mm
 = 0;

216 
pdev
->
d©a
.
xèlk_u£r
 = 0;

217 
	`gp2≠04vt_öô_£ns‹
(
pdev
);

218 
	}
}

226 
	$gp2≠04vt_so·w¨e_ª£t
(
gp2≠04vt_£ns‹
 *
pdev
)

228 
uöt8_t
 
wd©a
;

230 
wd©a
 = 0x01;

231 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

232 
	}
}

240 
	$gp2≠04vt_íabÀ_£ns‹
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
íabÀ
)

242 
uöt8_t
 
wd©a
;

244 i‡(
íabÀ
) {

245 
wd©a
(
OP_RUN
 | 
OP_CONTINUOUS
);

247 
wd©a
(
OP_SHUTDOWN
);

250 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &
wd©a
, 1);

251 
	}
}

253 
	$gp2≠04vt_°¨t_øngög
(
gp2≠04vt_£ns‹
 *
pdev
)

255 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

257 
pd©a
->
mode
 = 
MODE_RANGING
;

261 
	`gp2≠04vt_£t_vs1
(
pdev
);

263 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_ON
);

264 
	}
}

266 
	$gp2≠04vt_°›_øngög
(
gp2≠04vt_£ns‹
 *
pdev
)

268 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

270 
pd©a
->
mode
 = 
MODE_SENSOR_OFF
;

272 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_OFF
);

273 
	}
}

280 
	$gp2≠04vt_ªad_ønge_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

282 
uöt8_t
 
rd©a
[2];

283 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

285 
	`gp2≠_i2c_ªad
(
pdev
, 0x29, 
rd©a
, (rdata));

287 
pd©a
->
ønge
 = (
öt16_t
)(((
uöt16_t
)
rd©a
[1] << 8) |Ñdata[0]);

288 
	}
}

295 
	$gp2≠04vt_ªad_°©us_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

297 
uöt8_t
 
rd©a0
;

298 
uöt8_t
 
rd©a1
[2];

299 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

301 
	`gp2≠_i2c_ªad
(
pdev
, 0x28, &
rd©a0
, (rdata0));

302 
	`gp2≠_i2c_ªad
(
pdev
, 0x2B, 
rd©a1
, (rdata1));

304 
pd©a
->
öt_°©us
 = 
rd©a0
;

305 
pd©a
->
ønge_°©us
 = (((
uöt16_t
)
rd©a1
[1] & 0xF0) << 8) |Ñdata1[0];

306 
pd©a
->
c⁄fidí˚
 = 
rd©a1
[1] & 0x07;

307 
	}
}

309 
	$gp2≠04vt_ªad_ãm≥øtuª
(
gp2≠04vt_£ns‹
 *
pdev
)

311 
uöt8_t
 
rd©a
[2];

312 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

314 
	`gp2≠_i2c_ªad
(
pdev
, 0x3A, 
rd©a
, (rdata));

316 
pd©a
->
ãm≥øtuª
 = 
rd©a
[0];

317 
pd©a
->
ãmp_dëe˘
 = 
rd©a
[1];

318 
	}
}

320 
	$gp2≠04vt_ªad_sys_˛ock
(
gp2≠04vt_£ns‹
 *
pdev
)

322 
uöt8_t
 
rd©a
[4];

323 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

325 
	`gp2≠_i2c_ªad
(
pdev
, 0x3C, 
rd©a
, (rdata));

327 
pd©a
->
sys_˛ock
 = ((
uöt32_t
)
rd©a
[3] << 24) | ((uint32_t)rdata[2] << 16) | ((uint32_t)rdata[1] << 8) |Ñdata[0];

328 
	}
}

330 
uöt16_t
 
	$gp2≠04vt_ªad_checksum
(
gp2≠04vt_£ns‹
 *
pdev
)

332 
uöt8_t
 
rd©a
[2];

334 
	`gp2≠_i2c_ªad
(
pdev
, 0x24, 
rd©a
, (rdata));

336  ((
uöt16_t
)
rd©a
[1] << 8) |Ñdata[0];

337 
	}
}

339 
uöt8_t
 
	$gp2≠04vt_gë_devi˚_id
(
gp2≠04vt_£ns‹
 *
pdev
)

341 
uöt8_t
 
rd©a
;

342 
uöt8_t
 
devi˚_id
;

344 
	`gp2≠_i2c_ªad
(
pdev
, 0x44, &
rd©a
, (rdata));

346 
devi˚_id
 = 
rd©a
;

348  
devi˚_id
;

349 
	}
}

356 
	$gp2≠04vt_gë_ønge_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

358 
uöt8_t
 
rd©a
[7];

359 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

361 
	`gp2≠_i2c_ªad
(
pdev
, 0x28, 
rd©a
, (rdata));

363 
pd©a
->
öt_°©us
 = 
rd©a
[0];

364 
pd©a
->
ønge
 = (
öt16_t
)(((
uöt16_t
)
rd©a
[2] << 8) |Ñdata[1]);

365 
pd©a
->
ønge_°©us
 = (((
uöt16_t
)
rd©a
[4] & 0xF8) << 8) |Ñdata[3];

366 
pd©a
->
c⁄fidí˚
 = 
rd©a
[4] & 0x07;

367 
pd©a
->
xèlk
 = ((
uöt16_t
)
rd©a
[6] << 8) |Ñdata[5];

368 
	}
}

370 
	$gp2≠04vt_gë_ønge_d©a2
(
gp2≠04vt_£ns‹
 *
pdev
)

372 
uöt8_t
 
rd©a
[6];

373 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

375 
	`gp2≠_i2c_ªad
(
pdev
, 0x29, 
rd©a
, (rdata));

377 
pd©a
->
ønge
 = (
öt16_t
)(((
uöt16_t
)
rd©a
[1] << 8) |Ñdata[0]);

378 
pd©a
->
ønge_°©us
 = (((
uöt16_t
)
rd©a
[3] & 0xF0) << 8) |Ñdata[2];

379 
pd©a
->
c⁄fidí˚
 = 
rd©a
[3] & 0x07;

380 
pd©a
->
xèlk
 = ((
uöt16_t
)
rd©a
[5] << 8) |Ñdata[4];

381 
	}
}

388 
	$gp2≠04vt_gë_sig«l_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

390 
uöt8_t
 
rd©a
[10];

391 
öt32_t
 
sig«l
;

392 
öt32_t
 
sig«l_ªf
;

393 
öt32_t
 
amb
;

394 
öt32_t
 
amb_ªf
;

395 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

397 
	`gp2≠_i2c_ªad
(
pdev
, 0x2F, 
rd©a
, (rdata));

399 
sig«l
 = (
öt32_t
)((
uöt32_t
)
rd©a
[2] << 16) | ((uint32_t)rdata[1] << 8) |Ñdata[0];

400 i‡(
sig«l
 & 0x800000) {

401 
sig«l
 = signal - 0x1000000;

403 
sig«l_ªf
 = (
öt32_t
)((
uöt32_t
)
rd©a
[5] << 16) | ((uint32_t)rdata[4] << 8) |Ñdata[3];

404 i‡(
sig«l_ªf
 & 0x800000) {

405 
sig«l_ªf
 = signal_ref - 0x1000000;

407 
amb
 = (
öt32_t
)((
uöt32_t
)
rd©a
[7] << 8) |Ñdata[6];

408 i‡(
amb
 & 0x8000) {

409 
amb
 =ámb - 0x10000;

411 
amb_ªf
 = (
öt32_t
)((
uöt32_t
)
rd©a
[9] << 8) |Ñdata[8];

412 i‡(
amb_ªf
 & 0x8000) {

413 
amb_ªf
 =ámb_ref - 0x10000;

415 
pd©a
->
sig«l
 = signal;

416 
pd©a
->
sig«l_ªf
 = signal_ref;

417 
pd©a
->
amb
 =ámb;

418 
pd©a
->
amb_ªf
 =ámb_ref;

419 
	}
}

426 
uöt8_t
 
	$gp2≠04vt_ªad_Êag
(
gp2≠04vt_£ns‹
 *
pdev
)

428 
uöt8_t
 
rd©a
;

430 
	`gp2≠_i2c_ªad
(
pdev
, 0x28, &
rd©a
, (rdata));

432  (
rd©a
 & 0x10) >> 4;

433 
	}
}

440 
	$gp2≠04vt_˛ór_Êag
(
gp2≠04vt_£ns‹
 *
pdev
)

442 
uöt8_t
 
wd©a
;

444 
wd©a
 = 0xE7;

445 
	`gp2≠_i2c_wrôe
(
pdev
, 0x28, &
wd©a
, 1);

446 
	}
}

448 
	$gp2≠04vt_≥rf‹m_off£t_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

450 
uöt8_t
 
wd©a
;

451 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

453 
pd©a
->
mode
 = 
MODE_OFFSET_CALIBRATION
;

455 
	`gp2≠04vt_öô_£ns‹
(
pdev
);

456 
wd©a
 = 
PIN_MEASUREMENT_END
 | 
INTTYPE_LEVEL
;

457 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

459 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_ON
);

460 
	}
}

462 
	$gp2≠04vt_≥rf‹m_xèlk_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

464 
uöt8_t
 
wd©a
;

465 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

467 
pd©a
->
mode
 = 
MODE_XTALK_CALIBRATION
;

469 
	`gp2≠04vt_öô_£ns‹
(
pdev
);

470 
wd©a
 = 
PIN_MEASUREMENT_END
 | 
INTTYPE_LEVEL
;

471 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

473 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_ON
);

474 
	}
}

476 
	$gp2≠04vt_gë_off£t_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

478 
uöt8_t
 
wd©a
;

479 
uöt8_t
 
rd©a
[4];

480 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

482 
	`gp2≠04vt_°›_øngög
(
pdev
);

483 
	`gp2≠04vt_˛ór_Êag
(
pdev
);

484 
wd©a
 = 
SET_INTERRUPT
;

485 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

487 
pd©a
->
£ns‹_°©us
 = 0x01;

489 
wd©a
 = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

490 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

492 
wd©a
 = 0x40; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

493 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

495 
	`gp2≠_i2c_ªad
(
pdev
, 0x23, 
rd©a
, (rdata));

497 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

498 
wd©a
 = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

500 
pd©a
->
off£t_u£r
 = (
öt32_t
)(((
uöt32_t
)
rd©a
[3] << 24) | ((uint32_t)rdata[2] << 16) | ((uint32_t)rdata[1] << 8) |Ñdata[0]);

501 
pd©a
->
off£t_0p1mm
 =Öd©a->
off£t_u£r
 * 15 / 10;

502 
	}
}

504 
	$gp2≠04vt_gë_xèlk_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

506 
uöt8_t
 
wd©a
;

507 
uöt8_t
 
rd©a
[4];

508 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

510 
	`gp2≠04vt_°›_øngög
(
pdev
);

511 
	`gp2≠04vt_˛ór_Êag
(
pdev
);

512 
wd©a
 = 
SET_INTERRUPT
;

513 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

515 
pd©a
->
£ns‹_°©us
 = 0x03;

517 
wd©a
 = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

518 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

520 
wd©a
 = 0x38; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

521 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

523 
	`gp2≠_i2c_ªad
(
pdev
, 0x23, 
rd©a
, (rdata));

525 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

526 
wd©a
 = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

528 
pd©a
->
xèlk_u£r
 = ((
uöt32_t
)
rd©a
[3] << 24) | ((uint32_t)rdata[2] << 16) | ((uint32_t)rdata[1] << 8) |Ñdata[0];

529 
	}
}

531 
	$gp2≠04vt_£t_off£t_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

533 
uöt8_t
 
wd©a
[4] = {0, 0, 0, 0};

534 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

536 
wd©a
[0] = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

537 
wd©a
[0] = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

538 
wd©a
[0] = 0x40; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

539 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

540 
	`DELAY_FUNCTION
(1);

542 
wd©a
[0] = (
uöt8_t
)–
pd©a
->
off£t_u£r
 & 0x000000FF);

543 
wd©a
[1] = (
uöt8_t
)((
pd©a
->
off£t_u£r
 & 0x0000FF00) >> 8);

544 
wd©a
[2] = (
uöt8_t
)((
pd©a
->
off£t_u£r
 & 0x00FF0000) >> 16);

545 
wd©a
[3] = (
uöt8_t
)((
pd©a
->
off£t_u£r
 & 0xFF000000) >> 24);

547 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 4);

549 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

550 
wd©a
[0] = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

551 
	`DELAY_FUNCTION
(1);

552 
	}
}

554 
	$gp2≠04vt_£t_xèlk_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

556 
uöt8_t
 
wd©a
[4] = {0, 0, 0, 0};

557 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

559 
wd©a
[0] = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

560 
wd©a
[0] = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

561 
wd©a
[0] = 0x38; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

562 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

563 
	`DELAY_FUNCTION
(1);

565 
wd©a
[0] = (
uöt8_t
)–
pd©a
->
xèlk_u£r
 & 0x000000FF);

566 
wd©a
[1] = (
uöt8_t
)((
pd©a
->
xèlk_u£r
 & 0x0000FF00) >> 8);

567 
wd©a
[2] = (
uöt8_t
)((
pd©a
->
xèlk_u£r
 & 0x00FF0000) >> 16);

568 
wd©a
[3] = (
uöt8_t
)((
pd©a
->
xèlk_u£r
 & 0xFF000000) >> 24);

570 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 4);

572 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

573 
wd©a
[0] = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

574 
	`DELAY_FUNCTION
(1);

575 
	}
}

577 
	$gp2≠04vt_ªad_öã∫Æ_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

579 
uöt8_t
 
rd©a
;

580 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

582 
	`gp2≠_i2c_ªad
(
pdev
, 0x42, &
rd©a
, (rdata));

584 
pd©a
->
vs1
 = 
rd©a
;

585 
	}
}

593 
	$gp2≠04vt_£t_mu…ùÀ_£ns‹s
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
dy«mic_addr
)

595 
uöt8_t
 
wd©a
;

597 
pdev
->
¶ave_addr
 = 0x00;

598 
wd©a
 = 0x40; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

599 
wd©a
 = 
dy«mic_addr
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x05, &wdata, 1);

600 
pdev
->
¶ave_addr
 = 
dy«mic_addr
;

601 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

603 
	`gp2≠04vt_wrôe_fúmw¨e
(
pdev
);

605 
pdev
->
d©a
.
£ns‹_°©us
 = 
NOT_CALIBRATED
;

606 
pdev
->
d©a
.
off£t_u£r
 = 0;

607 
pdev
->
d©a
.
xèlk_u£r
 = 0;

609 
pdev
->
d©a
.
mode
 = 
MODE_SENSOR_OFF
;

610 
	`gp2≠04vt_öô_£ns‹
(
pdev
);

612 
	}
}

620 
	$gp2≠04vt_£t_mu…ùÀ_£ns‹s_˚
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
mode
)

622 
uöt8_t
 
wd©a
;

623 
uöt8_t
 
dy«mic_addr
;

625 
dy«mic_addr
 = 
pdev
->
¶ave_addr
;

626 
pdev
->
¶ave_addr
 = 0x29;

627 i‡(
mode
) {

628 
wd©a
 = 0x41; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

630 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

632 
pdev
->
¶ave_addr
 = 
dy«mic_addr
;

633 
	}
}

641 
	$gp2≠04vt_£t_mu…ùÀ_£ns‹s_dc
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
mode
)

643 
uöt8_t
 
wd©a
;

644 
uöt8_t
 
dy«mic_addr
;

646 
dy«mic_addr
 = 
pdev
->
¶ave_addr
;

647 
pdev
->
¶ave_addr
 = 0x29;

648 i‡(
mode
) {

649 
wd©a
 = 0x82; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

651 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

653 
pdev
->
¶ave_addr
 = 
dy«mic_addr
;

654 
	}
}

662 
	$gp2≠04vt_£t_gpio1
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
ouçut
)

664 
uöt8_t
 
wd©a
;

665 i‡(
ouçut
) {

666 
wd©a
 = 0x92; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

668 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

670 
	}
}

678 
	$gp2≠04vt_£t_dy«mic_addªss
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
dy«mic_addr
)

680 
uöt8_t
 
wd©a
;

682 
wd©a
 = 
dy«mic_addr
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x05, &wdata, 1);

683 
pdev
->
¶ave_addr
 = 
dy«mic_addr
;

684 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap04vt_api.h

5 #i‚de‡
__GP2AP04VT_API_H__


6 
	#__GP2AP04VT_API_H__


	)

8 #ifde‡
__KERNEL__


9 
	~<löux/ty≥s.h
>

10 
	~<löux/dñay.h
>

11 
	~<löux/of_gpio.h
>

12 
	~<löux/miscdevi˚.h
>

15 #i‚de‡
__KERNEL__


16 
	~"¥j_ty≥.h
"

19 
	#API_REVISION
 "gp2≠04vt_≠i_v037"

	)

22 
	#RL78


	)

24 #ifde‡
ARDUINO_UNO


25 
	#DELAY_FUNCTION
(
vÆue
Ë
	`dñay
(vÆue)

	)

28 #ifde‡
STM32


29 
HAL_Dñay
(
uöt32_t
);

30 
	#DELAY_FUNCTION
(
≥riod
Ë
	`HAL_Dñay
’îiod)

	)

33 #ifde‡
RL78


34 
	~"utû.h
"

35 
Dñay_MS
(
U16
 
ms
);

36 
	#DELAY_FUNCTION
(
≥riod
Ë
	`Dñay_MS
’îiod)

	)

39 #ifde‡
__KERNEL__


40 
	#DELAY_FUNCTION
(
≥riod
Ë
	`mdñay
’îiod)

	)

43 
	#DEVICE_ID
 0x3F

	)

45 
	#MODE_SENSOR_OFF
 0

	)

46 
	#MODE_RANGING
 1

	)

47 
	#MODE_HISTOGRAM
 2

	)

48 
	#MODE_OFFSET_CALIBRATION
 3

	)

49 
	#MODE_XTALK_CALIBRATION
 4

	)

51 
	#NO_ACCESS
 0x00

	)

52 
	#ROM
 0x01

	)

53 
	#RAM
 0x02

	)

55 
	#INIT_NO_ERROR
 0x00

	)

56 
	#INIT_ERROR
 0x01

	)

58 
	#NOT_CALIBRATED
 0x00

	)

59 
	#USER_OFFSET_CALIBRATION_DONE
 0x01

	)

60 
	#USER_XTALK_CALIBRATION_DONE
 0x02

	)

61 
	#USER_CALIBRATION_DONE
 0x03

	)

62 
	#USER_OFFSET_CALIBRATION_FAILED
 0xFF

	)

63 
	#USER_XTALK_CALIBRATION_FAILED
 0xFE

	)

65 
	#OP_SHUTDOWN
 0x00

	)

66 
	#OP_RUN
 0x80

	)

67 
	#OP_ONCE
 0x00

	)

68 
	#OP_CONTINUOUS
 0x40

	)

70 
	#SENSOR_ON
 1

	)

71 
	#SENSOR_OFF
 0

	)

73 
	#DYNAMIC_ADDRESS_SETTING_MODE
 1

	)

74 
	#NORMAL_MODE
 0

	)

76 
	#BIN_NUMBER
 128

	)

77 
	#MM_PER_BIN
 15

	)

78 
	#NUMBER_OF_CALIBRATIONS
 20

	)

80 
	#OFFSET_CALIBRAION_DISTANCE_MM
 20

81 

	)

82 
	#INT_DISENABLE
 0x00

	)

83 
	#INT_ENABLE
 0x20

	)

84 
	#PIN_PROX
 0x00

	)

85 
	#PIN_MEASUREMENT_END
 0x04

	)

86 
	#PIN_ERROR
 0x08

	)

87 
	#PIN_WINDOW
 0x0C

	)

88 
	#PIN_NO_ERROR_MEASUREMENT_END
 0x10

	)

89 
	#INTTYPE_LEVEL
 0x00

	)

90 
	#INTTYPE_PULSE
 0x02

	)

91 
	#SET_CONV1_100HZ
 6

	)

92 
	#SET_CONV1_60HZ
 13

	)

93 
	#SET_CONV1_60HZ_LP
 6

	)

94 
	#SET_CONV1_30HZ
 28

	)

95 
	#SET_CONV1_30HZ_LP
 6

	)

96 
	#SET_CONV2_100HZ
 6

	)

97 
	#SET_CONV2_60HZ
 12

	)

98 
	#SET_CONV2_60HZ_LP
 6

	)

99 
	#SET_CONV2_30HZ
 28

	)

100 
	#SET_CONV2_30HZ_LP
 6

	)

101 
	#SET_INTERVAL_100HZ
 0

	)

102 
	#SET_INTERVAL_60HZ
 12

	)

103 
	#SET_INTERVAL_60HZ_LP
 6

	)

104 
	#SET_INTERVAL_30HZ
 28

	)

105 
	#SET_INTERVAL_30HZ_LP
 6

	)

107 
	#SET_VCSEL
 0x0A

	)

108 
	#SET_CONV1
 
SET_CONV1_100HZ


	)

109 
	#SET_CONV2
 
SET_CONV2_100HZ


	)

110 
	#SET_INTERVAL
 
SET_INTERVAL_100HZ


	)

111 
	#SET_TH_PROX
 30

112 
	#SET_TH_RANGE_L
 20

113 
	#SET_TH_RANGE_H
 100

114 
	#SET_TH_HYS
 5

115 
	#SET_INTERRUPT
 
PIN_MEASUREMENT_END
 | 
INT_ENABLE
 | 
INTTYPE_PULSE


	)

120 
	sgp2≠04vt_d©a
 {

121 
uöt8_t
 
	mmode
;

122 
uöt8_t
 
	m£ns‹_°©us
;

125 
uöt8_t
 
	möt_°©us
;

126 
öt16_t
 
	mønge
;

127 
uöt16_t
 
	mønge_°©us
;

128 
uöt8_t
 
	mc⁄fidí˚
;

129 
uöt16_t
 
	mxèlk
;

132 
öt32_t
 
	msig«l
;

133 
öt32_t
 
	mamb
;

134 
öt32_t
 
	msig«l_ªf
;

135 
öt32_t
 
	mamb_ªf
;

136 
uöt8_t
 
	mãm≥øtuª
;

137 
uöt8_t
 
	mãmp_dëe˘
;

138 
uöt32_t
 
	msys_˛ock
;

139 
uöt32_t
 
	mvs1
;

142 
öt32_t
 
	moff£t_0p1mm
;

143 
öt32_t
 
	moff£t_u£r
;

144 
uöt32_t
 
	mxèlk_u£r
;

148 
	sgp2≠04vt_£ns‹
 {

149 
uöt8_t
 
	m¶ave_addr
;

151 #ifde‡
__KERNEL__


152 
muãx
 
	mmuãx
;

153 
i2c_˛õ¡
 *
	m˛õ¡
;

154 
miscdevi˚
 
	mgp2≠04vt_misc
;

155 
öput_dev
 *
	mønge_öput_dev
;

156 
dñayed_w‹k
 
	mw‹k_queue_timî
;

157 
w‹k_°ru˘
 
	mw‹k_queue_ext_öt
;

158 
uöt8_t
 
	mønge_íabÀd
;

159 
	mønge_dñay
;

160 
	mønge_úq
;

162 
	mgp2≠04vt_›íed
;

164 
of_gpio_Êags
 
	múq_gpio_Êags
;

168 
gp2≠04vt_d©a
 
	md©a
;

171 #ifde‡
__KERNEL__


172 
gp2≠_wrôe_d©a_fûe
(
öt8_t
 *, 
öt32_t
);

173 
gp2≠_ªad_d©a_‰om_fûe
(
öt8_t
 *);

174 
gp2≠_i2c_wrôe
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

175 
gp2≠_i2c_ªad
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

178 #i‚de‡
__KERNEL__


179 
gp2≠_i2c_wrôe
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

180 
gp2≠_i2c_ªad
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

183 
gp2≠04vt_öô_∑ømas
(
gp2≠04vt_£ns‹
 *);

184 
gp2≠04vt_öô_£ns‹
(
gp2≠04vt_£ns‹
 *);

185 
gp2≠04vt_˛ór_ˇlibøti⁄_d©a
(
gp2≠04vt_£ns‹
 *);

186 
gp2≠04vt_£t_vs1
(
gp2≠04vt_£ns‹
 *);

187 
gp2≠04vt_so·w¨e_ª£t
(
gp2≠04vt_£ns‹
 *);

188 
gp2≠04vt_íabÀ_£ns‹
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

189 
gp2≠04vt_°¨t_øngög
(
gp2≠04vt_£ns‹
 *);

190 
gp2≠04vt_°›_øngög
(
gp2≠04vt_£ns‹
 *);

191 
gp2≠04vt_ªad_ønge_d©a
(
gp2≠04vt_£ns‹
 *);

192 
gp2≠04vt_ªad_°©us_d©a
(
gp2≠04vt_£ns‹
 *);

193 
gp2≠04vt_ªad_ãm≥øtuª
(
gp2≠04vt_£ns‹
 *);

194 
gp2≠04vt_ªad_sys_˛ock
(
gp2≠04vt_£ns‹
 *);

195 
uöt16_t
 
gp2≠04vt_ªad_checksum
(
gp2≠04vt_£ns‹
 *);

196 
uöt8_t
 
gp2≠04vt_gë_devi˚_id
(
gp2≠04vt_£ns‹
 *);

197 
gp2≠04vt_gë_ønge_d©a
(
gp2≠04vt_£ns‹
 *);

198 
gp2≠04vt_gë_sig«l_d©a
(
gp2≠04vt_£ns‹
 *);

199 
uöt8_t
 
gp2≠04vt_ªad_Êag
(
gp2≠04vt_£ns‹
 *);

200 
gp2≠04vt_˛ór_Êag
(
gp2≠04vt_£ns‹
 *);

201 
gp2≠04vt_≥rf‹m_off£t_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

202 
gp2≠04vt_≥rf‹m_xèlk_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

203 
gp2≠04vt_gë_off£t_d©a
(
gp2≠04vt_£ns‹
 *);

204 
gp2≠04vt_gë_xèlk_d©a
(
gp2≠04vt_£ns‹
 *);

205 
gp2≠04vt_off£t_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

206 
gp2≠04vt_xèlk_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

207 
gp2≠04vt_ˇlcuœã_off£t
(
gp2≠04vt_d©a
 *);

208 
gp2≠04vt_ˇlcuœã_xèlk
(
gp2≠04vt_d©a
 *);

209 
gp2≠04vt_£t_off£t_d©a
(
gp2≠04vt_£ns‹
 *);

210 
gp2≠04vt_£t_xèlk_d©a
(
gp2≠04vt_£ns‹
 *);

211 
gp2≠04vt_ªad_öã∫Æ_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

212 
gp2≠04vt_£t_mu…ùÀ_£ns‹s
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

213 
gp2≠04vt_£t_mu…ùÀ_£ns‹s_˚
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

214 
gp2≠04vt_£t_mu…ùÀ_£ns‹s_dc
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

215 
gp2≠04vt_£t_gpio1
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

216 
gp2≠04vt_£t_dy«mic_addªss
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap04vt_firmware.c

1 
	~"gp2≠04vt_fúmw¨e.h
"

4 c⁄° 
uöt8_t
 
	ggp2≠04vt_fúmw¨e
[] =

646 
	$gp2≠04vt_wrôe_fúmw¨e
(
gp2≠04vt_£ns‹
 *
pdev
)

648 
uöt16_t
 
size
;

649 
uöt16_t
 
∑ge
 = 0;

650 
uöt8_t
 
wd©a
[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

651 
uöt8_t
 
i
;

653 
size
 = (
gp2≠04vt_fúmw¨e
);

657 
wd©a
[0] = 
ROM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

658 
wd©a
[0] = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

659 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

660 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

661 
	`DELAY_FUNCTION
(1);

663 
size
 >= 16)

665 
i
 = 0; i < 16; i++) {

666 
wd©a
[
i
] = 
gp2≠04vt_fúmw¨e
[
∑ge
 * 16 + i];

669 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 16);

671 
size
 -= 16;

672 
∑ge
++;

675 if(
size
 > 0)

677 
i
 = 0; i < 
size
; i++) {

678 
wd©a
[
i
] = 
gp2≠04vt_fúmw¨e
[
∑ge
 * 16 + i];

681 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 
size
);

684 
	`gp2≠04vt_ªad_checksum
(
pdev
);

686 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

687 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

688 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

689 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

690 
	`DELAY_FUNCTION
(2);

691 
	}
}

693 
	$gp2≠04vt_wrôe_fúmw¨e_löux
(
gp2≠04vt_£ns‹
 *
pdev
, *
fw_d©a
, 
size
)

695 
uöt16_t
 
∑ge
 = 0;

696 
uöt8_t
 
wd©a
[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

697 
uöt8_t
 
i
;

701 
wd©a
[0] = 
ROM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

702 
wd©a
[0] = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

703 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

704 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

705 
	`DELAY_FUNCTION
(1);

707 
size
 >= 16)

709 
i
 = 0; i < 16; i++) {

710 
wd©a
[
i
] = 
fw_d©a
[
∑ge
 * 16 + i];

713 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 16);

715 
size
 -= 16;

716 
∑ge
++;

719 if(
size
 > 0)

721 
i
 = 0; i < 
size
; i++) {

722 
wd©a
[
i
] = 
fw_d©a
[
∑ge
 * 16 + i];

725 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 
size
);

728 
	`gp2≠04vt_ªad_checksum
(
pdev
);

730 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

731 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

732 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

733 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

734 
	`DELAY_FUNCTION
(2);

735 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap04vt_firmware.h

1 #i‚de‡
_GP2AP04VT_FIRMWARE_H_


2 
	#_GP2AP04VT_FIRMWARE_H_


	)

4 
	~"gp2≠04vt_≠i.h
"

6 
gp2≠04vt_wrôe_fúmw¨e
(
gp2≠04vt_£ns‹
 *);

7 
gp2≠04vt_wrôe_fúmw¨e_löux
(
gp2≠04vt_£ns‹
 *, *, );

9 #i‚de‡
__KERNEL__


10 
	#FIRMWARE_CHECKSUM
 0x85C1

	)

13 #ifde‡
__KERNEL__


14 
	#FIRMWARE_CHECKSUM
 0xA877

	)

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap_i2c.c

6 
	~"hÆ_i2c.h
"

8 
	~<gp2≠_i2c.h
>

9 
	~<°dlib.h
>

10 
	~<°rög.h
>

12 
	~"gp2≠04vt_≠i.h
"

13 
	~"hÆ_ì¥om.h
"

14 
	~"r_cg_£rül.h
"

17 
	#WRITE_DELAY
 1500

	)

18 
	#READ_DELAY
 1000

	)

21 
	s_tof_


24 
U8
 
	mWrôeProc
;

25 
U8
 
	mRódProc
;

27 
U32
 
	mRódFaû
;

28 
U32
 
	mRódOk
;

30 
U32
 
	mWrôeFaû
;

31 
U32
 
	mWrôeOk
;

32 } 
	tTOF_T
;

34 
TOF_T
 
	gtof
;

37 
	$HAL_TOF_Inô
()

39 
	`mem£t
–&
tof
, 0, –
TOF_T
 ));

40 
	}
}

42 
	$HAL_TOF_SëWrôeProc
–
U8
 
_¥oc
 )

44 
tof
.
WrôeProc
 = 
_¥oc
;

45 
	}
}

47 
U8
 
	$HAL_TOF_GëWrôeProc
( )

49  
tof
.
WrôeProc
;

50 
	}
}

52 
BOOL_T
 
	$HAL_TOF_WrôeProcCom∂ëe
( )

54 
U16
 
waô
 = 10000;

58 if–
waô
 > 0 )

59 
waô
--;

61  
FALSE
;

63  !–
	`HAL_TOF_GëWrôeProc
(Ë=
TOF_PROC_DONE
 ) );

65  
TRUE
;

66 
	}
}

68 
	$HAL_TOF_SëRódProc
–
U8
 
_¥oc
 )

70 
tof
.
RódProc
 = 
_¥oc
;

71 
	}
}

73 
U8
 
	$HAL_TOF_GëRódProc
( )

75  
tof
.
RódProc
;

76 
	}
}

78 
BOOL_T
 
	$HAL_TOF_RódProcCom∂ëe
( )

80 
U16
 
waô
 = 10000;

84 if–
waô
 > 0 )

85 
waô
--;

87  
FALSE
;

89  !–
	`HAL_TOF_GëRódProc
(Ë=
TOF_PROC_DONE
 ) );

91  
TRUE
;

92 
	}
}

94 
	$Cou¡RódEº‹
()

96 
tof
.
RódFaû
++;

97 
	}
}

99 
	$Cou¡WrôeEº‹
()

101 
tof
.
WrôeFaû
++;

102 
	}
}

104 
	$i2ˇ0_St›C⁄dôi⁄
()

106 
	`R_IICA0_St›C⁄dôi⁄
();

107 
	}
}

116 
	$gp2≠_i2c_wrôe
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
w‹d_addªss
, uöt8_à*
wd©a
, uöt8_à
Àn
)

118 
uöt16_t
 
ªt
 = 0;

119 
uöt8_t
 
buf
[20];

122 
buf
[0] = 
w‹d_addªss
;

123 
	`mem˝y
(
buf
 + 1, 
wd©a
, 
Àn
);

125 
	`HAL_TOF_SëWrôeProc
–
TOF_PROC_START
 );

126 
ªt
 = 
	`i2ˇ0_ma°î_£nd
(
pdev
->
¶ave_addr
 << 1, 
buf
, 
Àn
 + 1, 200);

127 i‡(
ªt
 != 0) {

128 
	`Cou¡WrôeEº‹
();

129 
	`i2ˇ0_St›C⁄dôi⁄
();

133 if–!
	`HAL_TOF_WrôeProcCom∂ëe
() )

135 
	`Cou¡WrôeEº‹
();

136 
	`i2ˇ0_St›C⁄dôi⁄
();

140 
	`i2ˇ0_St›C⁄dôi⁄
();

142 
	`Dñay_US
–
WRITE_DELAY
 );

143 
tof
.
WrôeOk
++;

146 
	}
}

155 
	$gp2≠_i2c_ªad
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
w‹d_addªss
, uöt8_à*
rd©a
, uöt8_à
Àn
)

157 
uöt16_t
 
ªt
 = 0;

160 
	`HAL_TOF_SëWrôeProc
–
TOF_PROC_START
 );

161 
ªt
 = 
	`i2ˇ0_ma°î_£nd
((
pdev
->
¶ave_addr
 << 1), &
w‹d_addªss
, 1, 200);

162 i‡(
MD_OK
 != 0)

164 
	`Cou¡RódEº‹
();

165 
	`i2ˇ0_St›C⁄dôi⁄
();

166 *
rd©a
 = 0xFF;

170 if–!
	`HAL_TOF_WrôeProcCom∂ëe
() )

172 
	`Cou¡RódEº‹
();

173 
	`i2ˇ0_St›C⁄dôi⁄
();

177 
	`HAL_TOF_SëRódProc
–
TOF_PROC_START
 );

179 
ªt
 = 
	`i2ˇ0_ma°î_ªcv
((
pdev
->
¶ave_addr
 << 1), 
rd©a
, 
Àn
, 200);

180 i‡(
ªt
 != 0)

182 *
rd©a
 = 0xFF;

183 
	`Cou¡RódEº‹
();

184 
	`i2ˇ0_St›C⁄dôi⁄
();

188 if–!
	`HAL_TOF_RódProcCom∂ëe
() )

190 
	`Cou¡RódEº‹
();

191 
	`i2ˇ0_St›C⁄dôi⁄
();

195 
	`i2ˇ0_St›C⁄dôi⁄
();

196 
	`Dñay_US
–
READ_DELAY
 );

197 
tof
.
RódOk
++;

199 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap_i2c.h

5 #i‚de‡
GP2AP_I2C_H_


6 
	#GP2AP_I2C_H_


	)

10 
	~"¥j_ty≥.h
"

11 
	~"gp2≠04vt_≠i.h
"

14 
	#TIMEI2C1
 200

	)

15 
	#TIMEI2C2
 1

	)

16 
	#CLOCKDEFI2C
 400

	)

17 
	#CLOCKMAXI2C
 1000

	)

18 
	#CLOCKMINI2C
 10

	)

20 
	#TOF_PROC_START
 0

	)

21 
	#TOF_PROC_DONE
 1

	)

25 
HAL_TOF_Inô
();

32 
HAL_TOF_SëWrôeProc
–
U8
 
_¥oc
 );

39 
U8
 
HAL_TOF_GëWrôeProc
( );

46 
HAL_TOF_SëRódProc
–
U8
 
_¥oc
 );

54 
U8
 
HAL_TOF_GëRódProc
( );

57 
gp2≠_i2c_ªad
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

58 
gp2≠_i2c_ªad_§am
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

59 
gp2≠_i2c_wrôe
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

60 
£tI2CClock
(
uöt32_t
);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\tof.c

1 #¥agm®
öãºu±
 
INTP3
 
r_ötc3_öãºu±


3 
	~"hw.h
"

4 
	~"tof.h
"

5 
	~"gp2≠04vt_≠i.h
"

6 
	~"gp2≠04vt_fúmw¨e.h
"

7 
	~"r_cg_ötc.h
"

11 
gp2≠04vt_£ns‹
 
	gdev
[ 
MAX_TOF_ID
 ];

13 
	#ERROR_NO_DEVICE
 0x0001

	)

14 
	#ERROR_FIRMWARE_CHECKSUM
 0x0002

	)

15 
	#ERROR_CALIBRATION_OFFSET
 0x0004

	)

16 
	#ERROR_CALIBRATION_CROSSTALK
 0x0008

	)

17 
U16
 
	gtof_îr‹
[ 
MAX_TOF_ID
 ] = {0,};

19 
U8
 
	gtof_ªcv
[ 
MAX_TOF_ID
 ] = {0,};

20 
U32
 
	gtof_ªcv_i§_˙t
[ 
MAX_TOF_ID
 ] = {0,};

21 
U32
 
	gtof_ªcv_ªad_˙t
[ 
MAX_TOF_ID
 ] = {0,};

24 
	$gp2≠04vt_£t_îr‹
–
U8
 
id
, 
U16
 
îr‹
 )

26 
tof_îr‹
[ 
MAX_TOF_ID
 ] |
îr‹
;

27 
	}
}

30 
	$InôToF
()

32 
	`TURN_ON_TOF_1
();

34 
dev
[
TOF_ID_1
].
¶ave_addr
 = 0x29;

36 
	`gp2≠04vt_wrôe_fúmw¨e
(&
dev
[
TOF_ID_1
]);

39 
dev
[
TOF_ID_1
].
d©a
.
£ns‹_°©us
 = 
NOT_CALIBRATED
;

40 
dev
[
TOF_ID_1
].
d©a
.
off£t_u£r
 = 0;

41 
dev
[
TOF_ID_1
].
d©a
.
xèlk_u£r
 = 0;

43 
dev
[
TOF_ID_1
].
d©a
.
mode
 = 
MODE_SENSOR_OFF
;

45 
	`gp2≠04vt_öô_£ns‹
(&
dev
[
TOF_ID_1
]);

54 
	`R_INTC3_Sèπ
();

55 
	}
}

59 
	$DoCÆibøti⁄_ID
(
U8
 
id
)

61 
gp2≠04vt_£ns‹
 *
pdev
 = &
dev
[
id
];

62 
gp2≠04vt_d©a
 *
pd©a
 = &
dev
[
id
].
d©a
;

64 i‡(
pd©a
->
mode
 =
MODE_OFFSET_CALIBRATION
)

66 
	`gp2≠04vt_ªad_Êag
(
pdev
) == 0)

69 
	`Dñay_MS
(90);

72 
	`gp2≠04vt_gë_off£t_d©a
(
pdev
);

74 i‡(
pd©a
->
off£t_u£r
 == 22222)

76 
	`gp2≠04vt_£t_îr‹
–
id
, 
ERROR_CALIBRATION_OFFSET
 );

80 i‡(
pd©a
->
mode
 =
MODE_XTALK_CALIBRATION
)

82 
	`gp2≠04vt_ªad_Êag
(
pdev
) == 0)

85 
	`Dñay_MS
(99);

88 
	`gp2≠04vt_gë_xèlk_d©a
(
pdev
);

90 i‡(
pd©a
->
xèlk_u£r
 >= 200)

92 
	`gp2≠04vt_£t_îr‹
–
id
, 
ERROR_CALIBRATION_CROSSTALK
 );

95 
	}
}

98 
	$DoCÆibøti⁄
()

100 
	`DoCÆibøti⁄_ID
–
TOF_ID_1
 );

101 
	}
}

104 
	$SèπR™ge
(
U8
 
id
)

108 
	`gp2≠04vt_°¨t_øngög
–&
dev
[
id
] );

109 
	`gp2≠04vt_ªad_Êag
(&
dev
[
id
]) == 0) {

110 
	`Dñay_MS
( 5 );

113 
	`gp2≠04vt_°›_øngög
(&
dev
[ 
id
 ]);

114 
	`gp2≠04vt_gë_ønge_d©a
(&
dev
[ 
id
 ]);

115 
	`gp2≠04vt_˛ór_Êag
(&
dev
[ 
id
 ]);

119 
	`gp2≠04vt_íabÀ_£ns‹
(&
dev
[ 
id
 ], 
SENSOR_OFF
);

121 
	`gp2≠04vt_gë_ønge_d©a
(&
dev
[ 
id
 ]);

122 
	`gp2≠04vt_ªad_cup_d©a
(&
dev
[ 
id
 ]);

123 
	`gp2≠04vt_check_cup_edge
(&
dev
[ 
id
 ]);

125 
	`gp2≠04vt_˛ór_Êag
(&
dev
[ 
id
 ]);

126 
	`gp2≠04vt_íabÀ_£ns‹
(&
dev
[ 
id
 ], 
SENSOR_ON
);

127 
	}
}

129 
U8
 
	$CheckSèπR™ge
(
U8
 
id
 )

131 if(
	`gp2≠04vt_ªad_Êag
(&
dev
[
id
]) == 0) {

133  
FALSE
;

136  
TRUE
;

137 
	}
}

139 
	$St›R™ge
(
U8
 
id
)

141 
	`gp2≠04vt_°›_øngög
–&
dev
[
id
] );

142 
	}
}

144 
I16
 
	$GëR™ge
(
U8
 
id
)

146  
dev
[ 
id
 ].
d©a
.
ønge
;

147 
	}
}

149 
U8
 
	$xèlk_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

151 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

153 
	`gp2≠04vt_≥rf‹m_xèlk_ˇlibøti⁄
(
pdev
);

155 
	`gp2≠04vt_ªad_Êag
(
pdev
) == 0) {

156 
	`Dñay_MS
(33);

159 
	`gp2≠04vt_gë_xèlk_d©a
(
pdev
);

161 i‡(
pd©a
->
xèlk_u£r
 < 200) {

162  
TRUE
;

172  
FALSE
;

175 
	`¥ötf
("£ns‹_°©us: 0x%X\r\n", 
pd©a
->
£ns‹_°©us
);

176 
	`¥ötf
("xèlk_u£r: %ld\r\n", 
pd©a
->
xèlk_u£r
);

178 
	}
}

180 
U8
 
	$off£t_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

182 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

184 
	`gp2≠04vt_≥rf‹m_off£t_ˇlibøti⁄
(
pdev
);

186 
	`gp2≠04vt_ªad_Êag
(
pdev
) == 0) {

187 
	`Dñay_MS
(33);

190 
	`gp2≠04vt_gë_off£t_d©a
(
pdev
);

192 i‡(
pd©a
->
off£t_u£r
 != 22222) {

193  
TRUE
;

196  
FALSE
;

201 
	`¥ötf
("Off£àˇlibøti⁄ di°™˚[mm]: %d \r\n", 
OFFSET_CALIBRAION_DISTANCE_MM
);

202 
	`¥ötf
("£ns‹_°©us: 0x%X \r\n", 
pd©a
->
£ns‹_°©us
);

203 
	`¥ötf
("off£t[0.1mm]: %ld\r\n", 
pd©a
->
off£t_0p1mm
);

204 
	`¥ötf
("off£t_u£r[bö]: %ld\r\n", 
pd©a
->
off£t_u£r
);

206 
	}
}

208 
U8
 
	gdbg_off£t
 = 0;

209 
U8
 
	gdbg_xèlk
 = 0;

210 
U8
 
	gdbg_Êo‹
 = 0;

211 
U8
 
	goff£t_°©us
[ 
MAX_TOF_ID
 ];

212 
U8
 
	gxèlk_°©us
[ 
MAX_TOF_ID
 ];

214 
U8
 
	$GëSètusOff£tCÆibøti⁄
()

216 if–
off£t_°©us
[ 0 ] =
FALSE
 )

218  
FALSE
;

221  
TRUE
;

222 
	}
}

224 
U8
 
	$GëSètusXèlkCÆibøti⁄
()

226 if–
xèlk_°©us
[ 0 ] =
FALSE
 )

228  
FALSE
;

231  
TRUE
;

232 
	}
}

234 
	$Pro˚ssToF
()

236 
U8
 
i
;

238  
i
 = 0; i < 
MAX_TOF_ID
 ; i++ )

240 if–
tof_ªcv
[
i
] =
TRUE
 )

242 
tof_ªcv
[
i
] = 
FALSE
;

243 
tof_ªcv_ªad_˙t
[
i
]++;

247 if–
dbg_off£t
 )

249 
dbg_off£t
 = 0;

251 
off£t_°©us
[ 0 ] = 
	`off£t_ˇlibøti⁄
–&
dev
[ 
TOF_ID_1
 ]);

254 if–
dbg_xèlk
 )

256 
dbg_xèlk
 = 0;

258 
xèlk_°©us
[ 0 ] = 
	`xèlk_ˇlibøti⁄
–&
dev
[ 
TOF_ID_1
 ]);

264 if–
dbg_Êo‹
 )

266 
dbg_Êo‹
 = 0;

268 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_1
 ]);

269 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_2
 ]);

270 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_3
 ]);

271 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_4
 ]);

272 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_5
 ]);

273 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_6
 ]);

274 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_7
 ]);

278 
	}
}

281 
__öãºu±
 
	$r_ötc3_öãºu±
()

283 
tof_ªcv
[ 
TOF_ID_1
 ] = 
TRUE
;

284 
tof_ªcv_i§_˙t
[ 
TOF_ID_1
 ]++;

285 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\tof.h

1 #i‚de‡
__TOF__


2 
	#__TOF__


	)

4 
	~"¥j_ty≥.h
"

7 
	#TOF_ID_1
 0

	)

8 
	#MAX_TOF_ID
 1

	)

10 
InôToF
();

12 
DoCÆibøti⁄
();

14 
SèπR™ge
(
U8
 
id
);

16 
U8
 
CheckSèπR™ge
(U8 
id
 );

18 
St›R™ge
(
U8
 
id
);

20 
I16
 
GëR™ge
(
U8
 
id
);

22 
U8
 
GëSètusOff£tCÆibøti⁄
();

24 
U8
 
GëSètusXèlkCÆibøti⁄
();

26 
Pro˚ssToF
();

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap04vt_api.c

7 
	~"gp2≠04vt_≠i.h
"

8 
	~"gp2≠04vt_fúmw¨e.h
"

14 
	$gp2≠04vt_öô_∑øms
(
gp2≠04vt_£ns‹
 *
pdev
)

16 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

18 i‡(
pd©a
->
mode
 =
MODE_OFFSET_CALIBRATION
) {

19 
pd©a
->
£ns‹_°©us
 = 
NOT_CALIBRATED
;

20 
pd©a
->
off£t_u£r
 = 0;

21 
pd©a
->
off£t_0p1mm
 = 0;

22 
pd©a
->
xèlk_u£r
 = 0;

25 i‡(
pd©a
->
mode
 =
MODE_XTALK_CALIBRATION
) {

26 
pd©a
->
xèlk_u£r
 = 0;

28 
	}
}

34 
	$gp2≠04vt_öô_£ns‹
(
gp2≠04vt_£ns‹
 *
pdev
)

36 
uöt8_t
 
wd©a
;

37 
uöt8_t
 
wd©a_mu…i
[4] = {0x00, 0x00, 0x00, 0x00};

39 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

41 
	`gp2≠04vt_öô_∑øms
(
pdev
);

45 
wd©a
 = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

46 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

47 
	`DELAY_FUNCTION
(1);

49 
wd©a
 = 0x44; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

50 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

53 
wd©a_mu…i
[0] = 
SET_CONV1
;

54 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

57 
wd©a
 = 0x40; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

58 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

59 
wd©a_mu…i
[0] = 
SET_SPAD_SL
;

60 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

63 
wd©a
 = 0xAC; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

64 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

65 
wd©a_mu…i
[0] = 
SET_DIS_SPAD_AUTO
;

66 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

69 
wd©a
 = 0xF4; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

70 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

71 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_XTALK_AMB
 & 0x00FF);

72 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_TH_XTALK_AMB
 & 0xFF00) >> 8);

73 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

76 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_MAXCOUNT_XTALK
 & 0x00FF);

77 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_MAXCOUNT_XTALK
 & 0xFF00) >> 8);

78 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

81 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_HXTALK
 & 0x00FF);

82 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_TH_HXTALK
 & 0xFF00) >> 8);

83 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

86 
wd©a
 = 0x04; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

87 
wd©a
 = 0x02; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

88 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_LOWSIG
 & 0x00FF);

89 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_TH_LOWSIG
 & 0xFF00) >> 8);

90 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

93 
wd©a
 = 0x0C; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

94 
wd©a
 = 0x02; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

95 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_LOWSN
 & 0x00FF);

96 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_TH_LOWSN
 & 0xFF00) >> 8);

97 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

100 
wd©a
 = 0x14; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

101 
wd©a
 = 0x02; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

102 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_HSIG
 & 0x0000FF);

103 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_TH_HSIG
 & 0x00FF00) >> 8);

104 
wd©a_mu…i
[2] = (
uöt8_t
)((
SET_TH_HSIG
 & 0xFF0000) >> 16);

105 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

108 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_CONFI_LV
);

109 
wd©a_mu…i
[1] = 0;

110 
wd©a_mu…i
[2] = 0;

111 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

114 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_PARAM_CONFI1
 & 0x00FF);

115 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_PARAM_CONFI1
 & 0xFF00) >> 8);

116 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

119 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_PARAM_CONFI2
 & 0x00FF);

120 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_PARAM_CONFI2
 & 0xFF00) >> 8);

121 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

124 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_SQ_3SIGMA
 & 0x00FF);

125 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_TH_SQ_3SIGMA
 & 0xFF00) >> 8);

126 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

129 
wd©a_mu…i
[0] = 
SET_EN_RAWRANGE
;

130 
wd©a_mu…i
[1] = 0;

131 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

134 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_PROX
 & 0x00FF);

135 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_TH_PROX
 & 0xFF00) >> 8);

136 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

139 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_RANGE_L
 & 0x00FF);

140 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_TH_RANGE_L
 & 0xFF00) >> 8);

141 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

144 
wd©a_mu…i
[0] = (
uöt8_t
)(
SET_TH_RANGE_H
 & 0x00FF);

145 
wd©a_mu…i
[1] = (
uöt8_t
)((
SET_TH_RANGE_H
 & 0xFF00) >> 8);

146 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

149 
wd©a_mu…i
[0] = 
SET_TH_HYS
;

150 
wd©a_mu…i
[1] = 0;

151 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

154 
wd©a
 = 0x1C; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

155 
wd©a
 = 0x03; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

157 i‡(
pd©a
->
mode
 =
MODE_OFFSET_CALIBRATION
) {

158 
wd©a_mu…i
[0] = 
OFFSET_CALIBRAION_DISTANCE_MM
;

160 
wd©a_mu…i
[0] = 0x00;

162 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

165 
wd©a
 = 0xA4; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

166 
wd©a
 = 0x02; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

168 i‡(
pd©a
->
mode
 =
MODE_XTALK_CALIBRATION
) {

169 
wd©a_mu…i
[0] = 0x01;

171 
wd©a_mu…i
[0] = 0x00;

173 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a_mu…i
, 4);

175 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

176 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

177 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

178 
wd©a
 = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

179 
	`DELAY_FUNCTION
(2);

182 
	`gp2≠04vt_£t_off£t_d©a
(
pdev
);

183 
	`gp2≠04vt_£t_xèlk_d©a
(
pdev
);

186 
wd©a
 = 
SET_INTERRUPT
;

187 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

188 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x02, &wdata, 1);

189 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x03, &wdata, 1);

190 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

191 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x05, &wdata, 1);

192 
wd©a
 = 
SET_INTERVAL
 & 0xFF;

193 
	`gp2≠_i2c_wrôe
(
pdev
, 0x06, &
wd©a
, 1);

194 
wd©a
 = (((
uöt16_t
)
SET_INTERVAL
 & 0xFF00) >> 8);

195 
	`gp2≠_i2c_wrôe
(
pdev
, 0x07, &
wd©a
, 1);

196 
wd©a
 = 0x10; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x08, &wdata, 1);

197 
wd©a
 = 0x68; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x09, &wdata, 1);

198 
wd©a
 = 0x0F; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0A, &wdata, 1);

200 
wd©a
 = 0xBF; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0B, &wdata, 1);

201 
wd©a
 = 0x04; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0C, &wdata, 1);

202 
wd©a
 = 0x08; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0D, &wdata, 1);

203 
wd©a
 = 
SET_VCSEL
;

204 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0E, &
wd©a
, 1);

205 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0F, &wdata, 1);

206 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x10, &wdata, 1);

207 
wd©a
 = 0x70; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x11, &wdata, 1);

208 
wd©a
 = 
SET_VCSEL
;

209 
	`gp2≠_i2c_wrôe
(
pdev
, 0x12, &
wd©a
, 1);

210 
wd©a
 = 0x05; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x13, &wdata, 1);

211 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x14, &wdata, 1);

212 
wd©a
 = 0x02; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x15, &wdata, 1);

213 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x16, &wdata, 1);

214 
wd©a
 = 0x11; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x17, &wdata, 1);

215 
wd©a
 = 0xBF; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x18, &wdata, 1);

216 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x19, &wdata, 1);

217 
wd©a
 = 0x70; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1A, &wdata, 1);

218 
wd©a
 = 0x01; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1B, &wdata, 1);

219 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1C, &wdata, 1);

220 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1D, &wdata, 1);

221 
wd©a
 = 0x07; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1E, &wdata, 1);

223 #ifde‡
__KERNEL__


224 
wd©a
 = 0x04; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x46, &wdata, 1);

227 
	`gp2≠04vt_£t_vs1
(
pdev
);

228 
	}
}

230 
	$gp2≠04vt_£t_vs1
(
gp2≠04vt_£ns‹
 *
pdev
)

232 
uöt8_t
 
rd©a
;

233 
uöt8_t
 
wd©a
;

234 
uöt8_t
 
mode
;

235 
uöt8_t
 
i
;

236 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

238 
mode
 = 
pd©a
->mode;

240 
i
 = 0; i < 3; i++) {

241 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_ON
);

243 
	`DELAY_FUNCTION
(10);

245 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_OFF
);

247 
	`DELAY_FUNCTION
(2);

249 
	`gp2≠04vt_ªad_öã∫Æ_ˇlibøti⁄
(
pdev
);

251 i‡(
pd©a
->
vs1
 != 0) {

256 
	`gp2≠_i2c_ªad
(
pdev
, 0x0C, &
rd©a
, (rdata));

257 
wd©a
 = (0x01 | (0xFE & 
rd©a
));

258 
	`gp2≠_i2c_wrôe
(
pdev
, 0x0C, &
wd©a
, 1);

259 
wd©a
 = (
uöt8_t
)
pd©a
->
vs1
;

260 
	`gp2≠_i2c_wrôe
(
pdev
, 0x10, &
wd©a
, 1);

262 
pd©a
->
mode
 = mode;

263 
	}
}

271 
	$gp2≠04vt_˛ór_ˇlibøti⁄_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

273 
pdev
->
d©a
.
£ns‹_°©us
 = 0;

274 
pdev
->
d©a
.
off£t_u£r
 = 0;

275 
pdev
->
d©a
.
off£t_0p1mm
 = 0;

276 
pdev
->
d©a
.
xèlk_u£r
 = 0;

277 
	`gp2≠04vt_öô_£ns‹
(
pdev
);

278 
	}
}

286 
	$gp2≠04vt_so·w¨e_ª£t
(
gp2≠04vt_£ns‹
 *
pdev
)

288 
uöt8_t
 
wd©a
;

290 
wd©a
 = 0x01;

291 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

292 
	}
}

300 
	$gp2≠04vt_íabÀ_£ns‹
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
íabÀ
)

302 
uöt8_t
 
wd©a
;

304 i‡(
íabÀ
) {

305 
wd©a
(
OP_RUN
 | 
OP_CONTINUOUS
);

307 
wd©a
(
OP_SHUTDOWN
);

310 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &
wd©a
, 1);

311 
	}
}

313 
	$gp2≠04vt_°¨t_øngög
(
gp2≠04vt_£ns‹
 *
pdev
)

315 
uöt8_t
 
wd©a
;

316 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

318 
pd©a
->
mode
 = 
MODE_RANGING
;

324 
wd©a
 = 0x02;

325 
	`gp2≠_i2c_wrôe
(
pdev
, 0x28, &
wd©a
, 1);

327 
	`gp2≠04vt_£t_vs1
(
pdev
);

329 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_ON
);

330 
	}
}

332 
	$gp2≠04vt_°›_øngög
(
gp2≠04vt_£ns‹
 *
pdev
)

334 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

336 
pd©a
->
mode
 = 
MODE_SENSOR_OFF
;

338 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_OFF
);

340 
	`gp2≠04vt_˛ór_Êag
(
pdev
);

342 
	`DELAY_FUNCTION
(2);

343 
	}
}

350 
	$gp2≠04vt_ªad_ønge_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

352 
uöt8_t
 
rd©a
[2];

353 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

355 
	`gp2≠_i2c_ªad
(
pdev
, 0x29, 
rd©a
, (rdata));

357 
pd©a
->
ønge
 = (
öt16_t
)(((
uöt16_t
)
rd©a
[1] << 8) |Ñdata[0]);

358 
	}
}

365 
	$gp2≠04vt_ªad_°©us_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

367 
uöt8_t
 
rd©a0
;

368 
uöt8_t
 
rd©a1
[2];

369 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

371 
	`gp2≠_i2c_ªad
(
pdev
, 0x28, &
rd©a0
, (rdata0));

372 
	`gp2≠_i2c_ªad
(
pdev
, 0x2B, 
rd©a1
, (rdata1));

374 
pd©a
->
öt_°©us
 = 
rd©a0
;

375 
pd©a
->
ønge_°©us
 = (((
uöt16_t
)
rd©a1
[1] & 0xF0) << 8) |Ñdata1[0];

376 
pd©a
->
c⁄fidí˚
 = 
rd©a1
[1] & 0x07;

377 
	}
}

379 
	$gp2≠04vt_ªad_ãm≥øtuª
(
gp2≠04vt_£ns‹
 *
pdev
)

381 
uöt8_t
 
rd©a
[2];

382 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

384 
	`gp2≠_i2c_ªad
(
pdev
, 0x3A, 
rd©a
, (rdata));

386 
pd©a
->
ãm≥øtuª
 = 
rd©a
[0];

387 
pd©a
->
ãmp_dëe˘
 = 
rd©a
[1];

388 
	}
}

390 
	$gp2≠04vt_ªad_sys_˛ock
(
gp2≠04vt_£ns‹
 *
pdev
)

392 
uöt8_t
 
rd©a
[4];

393 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

395 
	`gp2≠_i2c_ªad
(
pdev
, 0x3C, 
rd©a
, (rdata));

397 
pd©a
->
sys_˛ock
 = ((
uöt32_t
)
rd©a
[3] << 24) | ((uint32_t)rdata[2] << 16) | ((uint32_t)rdata[1] << 8) |Ñdata[0];

398 
	}
}

400 
uöt16_t
 
	$gp2≠04vt_ªad_checksum
(
gp2≠04vt_£ns‹
 *
pdev
)

402 
uöt8_t
 
rd©a
[2];

404 
	`gp2≠_i2c_ªad
(
pdev
, 0x24, 
rd©a
, (rdata));

406  ((
uöt16_t
)
rd©a
[1] << 8) |Ñdata[0];

407 
	}
}

409 
uöt8_t
 
	$gp2≠04vt_gë_fw_vîsi⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

411 
uöt8_t
 
wd©a
;

412 
uöt8_t
 
rd©a
;

413 
uöt8_t
 
fw_vîsi⁄
;

415 
wd©a
(
OP_RUN
 | 
OP_CONTINUOUS
);

416 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &
wd©a
, 1);

417 
	`DELAY_FUNCTION
(1);

419 
	`gp2≠_i2c_ªad
(
pdev
, 0x40, &
rd©a
, (rdata));

420 
fw_vîsi⁄
 = 
rd©a
;

422 
wd©a
(
OP_SHUTDOWN
);

423 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &
wd©a
, 1);

424 
	`DELAY_FUNCTION
(2);

426  
fw_vîsi⁄
;

427 
	}
}

429 
uöt8_t
 
	$gp2≠04vt_gë_devi˚_id
(
gp2≠04vt_£ns‹
 *
pdev
)

431 
uöt8_t
 
rd©a
;

432 
uöt8_t
 
devi˚_id
;

434 
	`gp2≠_i2c_ªad
(
pdev
, 0x44, &
rd©a
, (rdata));

436 
devi˚_id
 = 
rd©a
;

438  
devi˚_id
;

439 
	}
}

446 
	$gp2≠04vt_gë_ønge_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

448 
uöt8_t
 
rd©a
[7];

449 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

451 
	`gp2≠_i2c_ªad
(
pdev
, 0x28, 
rd©a
, (rdata));

453 
pd©a
->
öt_°©us
 = 
rd©a
[0];

454 
pd©a
->
ønge
 = (
öt16_t
)(((
uöt16_t
)
rd©a
[2] << 8) |Ñdata[1]);

455 
pd©a
->
ønge_°©us
 = (((
uöt16_t
)
rd©a
[4] & 0xF8) << 8) |Ñdata[3];

456 
pd©a
->
c⁄fidí˚
 = 
rd©a
[4] & 0x07;

457 
pd©a
->
xèlk
 = ((
uöt16_t
)
rd©a
[6] << 8) |Ñdata[5];

458 
	}
}

460 
	$gp2≠04vt_gë_ønge_d©a2
(
gp2≠04vt_£ns‹
 *
pdev
)

462 
uöt8_t
 
rd©a
[6];

463 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

465 
	`gp2≠_i2c_ªad
(
pdev
, 0x29, 
rd©a
, (rdata));

467 
pd©a
->
ønge
 = (
öt16_t
)(((
uöt16_t
)
rd©a
[1] << 8) |Ñdata[0]);

468 
pd©a
->
ønge_°©us
 = (((
uöt16_t
)
rd©a
[3] & 0xF0) << 8) |Ñdata[2];

469 
pd©a
->
c⁄fidí˚
 = 
rd©a
[3] & 0x07;

470 
pd©a
->
xèlk
 = ((
uöt16_t
)
rd©a
[5] << 8) |Ñdata[4];

471 
	}
}

478 
	$gp2≠04vt_gë_sig«l_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

480 
uöt8_t
 
rd©a
[10];

481 
öt32_t
 
sig«l
;

482 
öt32_t
 
sig«l_ªf
;

483 
öt32_t
 
amb
;

484 
öt32_t
 
amb_ªf
;

485 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

487 
	`gp2≠_i2c_ªad
(
pdev
, 0x2F, 
rd©a
, (rdata));

489 
sig«l
 = (
öt32_t
)(((
uöt32_t
)
rd©a
[2] << 16) | ((uint32_t)rdata[1] << 8) |Ñdata[0]);

490 i‡(
sig«l
 & 0x800000) {

491 
sig«l
 = signal - 0x1000000;

493 
sig«l_ªf
 = (
öt32_t
)(((
uöt32_t
)
rd©a
[5] << 16) | ((uint32_t)rdata[4] << 8) |Ñdata[3]);

494 i‡(
sig«l_ªf
 & 0x800000) {

495 
sig«l_ªf
 = signal_ref - 0x1000000;

497 
amb
 = (
öt32_t
)(((
uöt32_t
)
rd©a
[7] << 8) |Ñdata[6]);

498 i‡(
amb
 & 0x8000) {

499 
amb
 =ámb - 0x10000;

501 
amb_ªf
 = (
öt32_t
)(((
uöt32_t
)
rd©a
[9] << 8) |Ñdata[8]);

502 i‡(
amb_ªf
 & 0x8000) {

503 
amb_ªf
 =ámb_ref - 0x10000;

505 
pd©a
->
sig«l
 = signal;

506 
pd©a
->
sig«l_ªf
 = signal_ref;

507 
pd©a
->
amb
 =ámb;

508 
pd©a
->
amb_ªf
 =ámb_ref;

509 
	}
}

516 
uöt8_t
 
	$gp2≠04vt_ªad_Êag
(
gp2≠04vt_£ns‹
 *
pdev
)

518 
uöt8_t
 
rd©a
;

520 
	`gp2≠_i2c_ªad
(
pdev
, 0x28, &
rd©a
, (rdata));

522  (
rd©a
 & 0x10) >> 4;

523 
	}
}

530 
	$gp2≠04vt_˛ór_Êag
(
gp2≠04vt_£ns‹
 *
pdev
)

532 
uöt8_t
 
wd©a
;

534 
wd©a
 = 0xE7;

535 
	`gp2≠_i2c_wrôe
(
pdev
, 0x28, &
wd©a
, 1);

536 
	}
}

538 
	$gp2≠04vt_≥rf‹m_off£t_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

540 
uöt8_t
 
wd©a
;

541 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

543 
pd©a
->
mode
 = 
MODE_OFFSET_CALIBRATION
;

545 
	`gp2≠04vt_öô_£ns‹
(
pdev
);

548 
wd©a
 = 0x02;

549 
	`gp2≠_i2c_wrôe
(
pdev
, 0x28, &
wd©a
, 1);

551 
wd©a
 = 
PIN_MEASUREMENT_END
 | 
INTTYPE_LEVEL
;

552 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

554 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_ON
);

555 
	}
}

557 
	$gp2≠04vt_≥rf‹m_xèlk_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

559 
uöt8_t
 
wd©a
;

560 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

562 
pd©a
->
mode
 = 
MODE_XTALK_CALIBRATION
;

564 
	`gp2≠04vt_öô_£ns‹
(
pdev
);

567 
wd©a
 = 0x02;

568 
	`gp2≠_i2c_wrôe
(
pdev
, 0x28, &
wd©a
, 1);

570 
wd©a
 = 
PIN_MEASUREMENT_END
 | 
INTTYPE_LEVEL
;

571 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

573 
	`gp2≠04vt_íabÀ_£ns‹
(
pdev
, 
SENSOR_ON
);

574 
	}
}

576 
	$gp2≠04vt_gë_off£t_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

578 
uöt8_t
 
wd©a
;

579 
uöt8_t
 
rd©a
[4];

580 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

582 
	`gp2≠04vt_°›_øngög
(
pdev
);

583 
	`gp2≠04vt_˛ór_Êag
(
pdev
);

584 
wd©a
 = 
SET_INTERRUPT
;

585 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

587 
pd©a
->
£ns‹_°©us
 = 0x01;

589 
wd©a
 = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

590 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

592 
wd©a
 = 0x40; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

593 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

594 
	`DELAY_FUNCTION
(1);

596 
	`gp2≠_i2c_ªad
(
pdev
, 0x23, 
rd©a
, (rdata));

598 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

599 
wd©a
 = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

600 
	`DELAY_FUNCTION
(2);

602 
pd©a
->
off£t_u£r
 = (
öt32_t
)(((
uöt32_t
)
rd©a
[3] << 24) | ((uint32_t)rdata[2] << 16) | ((uint32_t)rdata[1] << 8) |Ñdata[0]);

603 
pd©a
->
off£t_0p1mm
 =Öd©a->
off£t_u£r
 * 15 / 10;

604 
	}
}

606 
	$gp2≠04vt_gë_xèlk_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

608 
uöt8_t
 
wd©a
;

609 
uöt8_t
 
rd©a
[4];

610 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

612 
	`gp2≠04vt_°›_øngög
(
pdev
);

613 
	`gp2≠04vt_˛ór_Êag
(
pdev
);

614 
wd©a
 = 
SET_INTERRUPT
;

615 
	`gp2≠_i2c_wrôe
(
pdev
, 0x01, &
wd©a
, 1);

617 
pd©a
->
£ns‹_°©us
 = 0x03;

619 
wd©a
 = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

620 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

622 
wd©a
 = 0x38; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

623 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

624 
	`DELAY_FUNCTION
(1);

626 
	`gp2≠_i2c_ªad
(
pdev
, 0x23, 
rd©a
, (rdata));

628 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

629 
wd©a
 = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

630 
	`DELAY_FUNCTION
(2);

632 
pd©a
->
xèlk_u£r
 = ((
uöt32_t
)
rd©a
[3] << 24) | ((uint32_t)rdata[2] << 16) | ((uint32_t)rdata[1] << 8) |Ñdata[0];

633 
	}
}

635 
	$gp2≠04vt_£t_off£t_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

637 
uöt8_t
 
wd©a
[4] = {0, 0, 0, 0};

638 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

640 
wd©a
[0] = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

641 
wd©a
[0] = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

642 
wd©a
[0] = 0x40; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

643 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

644 
	`DELAY_FUNCTION
(1);

646 
wd©a
[0] = (
uöt8_t
)–
pd©a
->
off£t_u£r
 & 0x000000FF);

647 
wd©a
[1] = (
uöt8_t
)((
pd©a
->
off£t_u£r
 & 0x0000FF00) >> 8);

648 
wd©a
[2] = (
uöt8_t
)((
pd©a
->
off£t_u£r
 & 0x00FF0000) >> 16);

649 
wd©a
[3] = (
uöt8_t
)((
pd©a
->
off£t_u£r
 & 0xFF000000) >> 24);

651 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 4);

653 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

654 
wd©a
[0] = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

655 
	`DELAY_FUNCTION
(2);

656 
	}
}

658 
	$gp2≠04vt_£t_xèlk_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

660 
uöt8_t
 
wd©a
[4] = {0, 0, 0, 0};

661 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

663 
wd©a
[0] = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

664 
wd©a
[0] = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

665 
wd©a
[0] = 0x38; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

666 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

667 
	`DELAY_FUNCTION
(1);

669 
wd©a
[0] = (
uöt8_t
)–
pd©a
->
xèlk_u£r
 & 0x000000FF);

670 
wd©a
[1] = (
uöt8_t
)((
pd©a
->
xèlk_u£r
 & 0x0000FF00) >> 8);

671 
wd©a
[2] = (
uöt8_t
)((
pd©a
->
xèlk_u£r
 & 0x00FF0000) >> 16);

672 
wd©a
[3] = (
uöt8_t
)((
pd©a
->
xèlk_u£r
 & 0xFF000000) >> 24);

674 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 4);

676 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

677 
wd©a
[0] = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

678 
	`DELAY_FUNCTION
(2);

679 
	}
}

681 
	$gp2≠04vt_ªad_öã∫Æ_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

683 
uöt8_t
 
rd©a
;

684 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

686 
	`gp2≠_i2c_ªad
(
pdev
, 0x42, &
rd©a
, (rdata));

688 
pd©a
->
vs1
 = 
rd©a
;

689 
	}
}

697 
	$gp2≠04vt_£t_mu…ùÀ_£ns‹s
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
dy«mic_addr
)

699 
uöt8_t
 
wd©a
;

701 
pdev
->
¶ave_addr
 = 0x00;

702 
wd©a
 = 0x40; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

703 
wd©a
 = 
dy«mic_addr
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x05, &wdata, 1);

704 
pdev
->
¶ave_addr
 = 
dy«mic_addr
;

705 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

707 
	`gp2≠04vt_wrôe_fúmw¨e
(
pdev
);

709 
pdev
->
d©a
.
£ns‹_°©us
 = 
NOT_CALIBRATED
;

710 
pdev
->
d©a
.
off£t_u£r
 = 0;

711 
pdev
->
d©a
.
xèlk_u£r
 = 0;

713 
pdev
->
d©a
.
mode
 = 
MODE_SENSOR_OFF
;

714 
	`gp2≠04vt_öô_£ns‹
(
pdev
);

716 
	}
}

724 
	$gp2≠04vt_£t_mu…ùÀ_£ns‹s_˚
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
mode
)

726 
uöt8_t
 
wd©a
;

727 
uöt8_t
 
dy«mic_addr
;

729 
dy«mic_addr
 = 
pdev
->
¶ave_addr
;

730 
pdev
->
¶ave_addr
 = 0x29;

731 i‡(
mode
) {

732 
wd©a
 = 0x41; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

734 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

736 
pdev
->
¶ave_addr
 = 
dy«mic_addr
;

737 
	}
}

745 
	$gp2≠04vt_£t_mu…ùÀ_£ns‹s_dc
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
mode
)

747 
uöt8_t
 
wd©a
;

748 
uöt8_t
 
dy«mic_addr
;

750 
dy«mic_addr
 = 
pdev
->
¶ave_addr
;

751 
pdev
->
¶ave_addr
 = 0x29;

752 i‡(
mode
) {

753 
wd©a
 = 0x82; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

755 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

757 
pdev
->
¶ave_addr
 = 
dy«mic_addr
;

758 
	}
}

766 
	$gp2≠04vt_£t_gpio1
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
ouçut
)

768 
uöt8_t
 
wd©a
;

769 i‡(
ouçut
) {

770 
wd©a
 = 0x92; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

772 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x04, &wdata, 1);

774 
	}
}

782 
	$gp2≠04vt_£t_dy«mic_addªss
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
dy«mic_addr
)

784 
uöt8_t
 
wd©a
;

786 
wd©a
 = 
dy«mic_addr
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x05, &wdata, 1);

787 
pdev
->
¶ave_addr
 = 
dy«mic_addr
;

788 
	}
}

790 
	$gp2≠04vt_ªad_cup_d©a
(
gp2≠04vt_£ns‹
 *
pdev
)

792 
uöt8_t
 
rd©a
[120];

793 
uöt8_t
 
wd©a
;

795 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

797 
	`DELAY_FUNCTION
(1);

798 
wd©a
 = 
RAM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

799 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

800 
	`DELAY_FUNCTION
(1);

803 
wd©a
 = 0x08; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

804 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

806 
	`gp2≠_i2c_ªad
(
pdev
, 0x23, 
rd©a
, 1);

807 
pd©a
->
maxbö
 = 
rd©a
[0];

810 
wd©a
 = 0x1C; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

811 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

813 
	`gp2≠_i2c_ªad
(
pdev
, 0x23, 
rd©a
, 1);

814 
pd©a
->
maxbö_ªf
 = 
rd©a
[0];

817 
wd©a
 = 0x14; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &wdata, 1);

818 
wd©a
 = 0x03; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

820 
	`gp2≠_i2c_ªad
(
pdev
, 0x23, 
rd©a
, 4);

822 
pd©a
->
ønge_¥e
 = (
öt32_t
)(((
uöt32_t
)
rd©a
[3] << 24) | ((uint32_t)rdata[2] << 16) | ((uint32_t)rdata[1] << 8) |Ñdata[0]);

824 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

825 
wd©a
 = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

826 
	`DELAY_FUNCTION
(2);

828 
wd©a
 = 
HIST_RET
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

829 
wd©a
 = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

830 
	`DELAY_FUNCTION
(1);

833 
wd©a
 = (
pd©a
->
maxbö_ªf
 - 3) * 2;

834 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &
wd©a
, 1);

835 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

837 
	`gp2≠_i2c_ªad
(
pdev
, 0x23, 
rd©a
, 2);

838 
pd©a
->
hi°_ªt_a
 = ((
uöt16_t
)
rd©a
[1] << 8) |Ñdata[0];

841 
wd©a
 = 
pd©a
->
maxbö
 * 2;

842 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, &
wd©a
, 1);

843 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, &wdata, 1);

845 
	`gp2≠_i2c_ªad
(
pdev
, 0x23, 
rd©a
, 2);

846 
pd©a
->
hi°_ªt_maxbö
 = ((
uöt16_t
)
rd©a
[1] << 8) |Ñdata[0];

848 
wd©a
 = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, &wdata, 1);

849 
wd©a
 = 
NO_ACCESS
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, &wdata, 1);

850 
	`DELAY_FUNCTION
(2);

851 
	}
}

853 
	#NO_CUP
 0

	)

854 
	#CUP_RANGE
 1

	)

855 
	#CUP
 2

	)

856 
	#DIRT_ERROR
 3

	)

858 
	$gp2≠04vt_check_cup_edge
(
gp2≠04vt_£ns‹
 *
pdev
)

860 
öt32_t
 
øtio
;

861 
uöt8_t
 
ªsu…
;

862 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

864 i‡(
pd©a
->
hi°_ªt_maxbö
 != 0) {

865 
øtio
 = ((
öt32_t
)
pd©a
->
hi°_ªt_a
 * 1000Ë/ (öt32_tÌd©a->
hi°_ªt_maxbö
;

867 
øtio
 = 0;

870 i‡(
pd©a
->
ønge
 == 22222) {

871 
ªsu…
 = 
NO_CUP
;

872 } i‡(
øtio
 <= 150) {

873 
ªsu…
 = 
NO_CUP
;

874 } i‡(
pd©a
->
xèlk
 > 
SET_MAXCOUNT_XTALK
) {

875 
ªsu…
 = 
DIRT_ERROR
;

876 } i‡((
pd©a
->
ønge_¥e
 > 0) && (pdata->range_pre < 500)) {

877 
ªsu…
 = 
CUP_RANGE
;

879 
ªsu…
 = 
CUP
;

882 
pd©a
->
øtio
 =Ñatio;

883 
pd©a
->
cup_dëe˘i⁄
 = 
ªsu…
;

885 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap04vt_api.h

5 #i‚de‡
__GP2AP04VT_API_H__


6 
	#__GP2AP04VT_API_H__


	)

8 #ifde‡
__KERNEL__


9 
	~<löux/ty≥s.h
>

10 
	~<löux/dñay.h
>

11 
	~<löux/of_gpio.h
>

12 
	~<löux/miscdevi˚.h
>

15 #i‚de‡
__KERNEL__


16 
	~"¥j_ty≥.h
"

19 
	#API_REVISION
 "gp2≠04vt_≠i_v100"

	)

22 
	#RL78


	)

24 #ifde‡
ARDUINO_UNO


25 
	#DELAY_FUNCTION
(
vÆue
Ë
	`dñay
(vÆue)

	)

28 #ifde‡
STM32


29 
HAL_Dñay
(
uöt32_t
);

30 
	#DELAY_FUNCTION
(
≥riod
Ë
	`HAL_Dñay
’îiod)

	)

33 #ifde‡
RL78


34 
	~"utû.h
"

35 
Dñay_MS
(
U16
 
ms
);

36 
	#DELAY_FUNCTION
(
≥riod
Ë
	`Dñay_MS
’îiod)

	)

39 #ifde‡
__KERNEL__


40 
	#DELAY_FUNCTION
(
≥riod
Ë
	`mdñay
’îiod)

	)

43 
	#DEVICE_ID
 0x3F

	)

45 
	#MODE_SENSOR_OFF
 0

	)

46 
	#MODE_RANGING
 1

	)

47 
	#MODE_OFFSET_CALIBRATION
 3

	)

48 
	#MODE_XTALK_CALIBRATION
 4

	)

50 
	#NO_ACCESS
 0x00

	)

51 
	#ROM
 0x01

	)

52 
	#RAM
 0x02

	)

53 
	#HIST_RET
 0x04

	)

55 
	#INIT_NO_ERROR
 0x00

	)

56 
	#INIT_ERROR
 0x01

	)

58 
	#NOT_CALIBRATED
 0x00

	)

59 
	#USER_OFFSET_CALIBRATION_DONE
 0x01

	)

60 
	#USER_XTALK_CALIBRATION_DONE
 0x02

	)

61 
	#USER_CALIBRATION_DONE
 0x03

	)

62 
	#USER_OFFSET_CALIBRATION_FAILED
 0xFF

	)

63 
	#USER_XTALK_CALIBRATION_FAILED
 0xFE

	)

65 
	#OP_SHUTDOWN
 0x00

	)

66 
	#OP_RUN
 0x80

	)

67 
	#OP_ONCE
 0x00

	)

68 
	#OP_CONTINUOUS
 0x40

	)

70 
	#SENSOR_ON
 1

	)

71 
	#SENSOR_OFF
 0

	)

73 
	#DYNAMIC_ADDRESS_SETTING_MODE
 1

	)

74 
	#NORMAL_MODE
 0

	)

78 
	#INT_DISENABLE
 0x00

	)

79 
	#INT_ENABLE
 0x20

	)

80 
	#PIN_PROX
 0x00

	)

81 
	#PIN_MEASUREMENT_END
 0x04

	)

82 
	#PIN_ERROR
 0x08

	)

83 
	#PIN_WINDOW
 0x0C

	)

84 
	#PIN_NO_ERROR_MEASUREMENT_END
 0x10

	)

85 
	#INTTYPE_LEVEL
 0x00

	)

86 
	#INTTYPE_PULSE
 0x02

	)

87 
	#SET_CONV1_100HZ
 13

	)

88 
	#SET_CONV1_60HZ
 26

	)

89 
	#SET_CONV1_60HZ_LP
 13

	)

90 
	#SET_CONV1_30HZ
 57

	)

91 
	#SET_CONV1_30HZ_LP
 13

	)

92 
	#SET_CONV2_100HZ
 0

	)

93 
	#SET_CONV2_60HZ
 0

	)

94 
	#SET_CONV2_60HZ_LP
 0

	)

95 
	#SET_CONV2_30HZ
 0

	)

96 
	#SET_CONV2_30HZ_LP
 0

	)

97 
	#SET_INTERVAL_100HZ
 0

	)

98 
	#SET_INTERVAL_60HZ
 6

	)

99 
	#SET_INTERVAL_60HZ_LP
 19

	)

100 
	#SET_INTERVAL_30HZ
 14

	)

101 
	#SET_INTERVAL_30HZ_LP
 58

	)

102 
	#VCSEL_30MA
 0x0A

	)

105 
	#SET_VCSEL
 
VCSEL_30MA


	)

107 
	#SET_CONV1
 67

	)

108 
	#SET_CONV2
 
SET_CONV2_100HZ


	)

110 
	#SET_INTERVAL
 3

	)

111 
	#SET_INTERRUPT
 
PIN_MEASUREMENT_END
 | 
INT_ENABLE
 | 
INTTYPE_LEVEL


	)

113 
	#SET_TH_PROX
 30

114 
	#SET_TH_RANGE_L
 20

115 
	#SET_TH_RANGE_H
 100

116 
	#SET_TH_HYS
 5

117 

	)

118 
	#OFFSET_CALIBRAION_DISTANCE_MM
 20

120 

	)

121 
	#SET_SPAD_SL
 0x07

	)

122 
	#SET_DIS_SPAD_AUTO
 0x01

	)

123 
	#SET_TH_XTALK_AMB
 500

	)

124 
	#SET_MAXCOUNT_XTALK
 300

	)

125 
	#SET_TH_HXTALK
 250

	)

126 
	#SET_TH_LOWSIG
 2000

	)

127 
	#SET_TH_LOWSN
 40

	)

128 
	#SET_TH_HAMB
 4095

	)

129 
	#SET_TH_HSIG
 (
uöt32_t
)0xFFFFFF

	)

130 
	#SET_TH_CONFI_LV
 0

	)

131 
	#SET_PARAM_CONFI1
 400

	)

132 
	#SET_PARAM_CONFI2
 1280

	)

133 
	#SET_TH_SQ_3SIGMA
 25

	)

134 
	#SET_EN_RAWRANGE
 0

	)

136 
	#BIN_NUMBER
 128

	)

141 
	sgp2≠04vt_d©a
 {

142 
uöt8_t
 
	mmode
;

143 
uöt8_t
 
	m£ns‹_°©us
;

146 
uöt8_t
 
	möt_°©us
;

147 
öt16_t
 
	mønge
;

148 
uöt16_t
 
	mønge_°©us
;

149 
uöt8_t
 
	mc⁄fidí˚
;

150 
uöt16_t
 
	mxèlk
;

151 
öt32_t
 
	mønge_¥e
;

154 
öt32_t
 
	msig«l
;

155 
öt32_t
 
	mamb
;

156 
öt32_t
 
	msig«l_ªf
;

157 
öt32_t
 
	mamb_ªf
;

158 
uöt8_t
 
	mãm≥øtuª
;

159 
uöt8_t
 
	mãmp_dëe˘
;

160 
uöt32_t
 
	msys_˛ock
;

161 
uöt8_t
 
	m•ad_¶
;

163 
öt32_t
 
	møtio
;

164 
uöt8_t
 
	mcup_dëe˘i⁄
;

167 
uöt8_t
 
	mmaxbö
;

168 
uöt8_t
 
	mmaxbö_ªf
;

169 
öt16_t
 
	mhi°_ªt_a
;

170 
öt16_t
 
	mhi°_ªt_maxbö
;

171 
uöt32_t
 
	mv•ad
;

172 
uöt32_t
 
	mvs1
;

173 
uöt32_t
 
	mibüs
;

176 
öt32_t
 
	moff£t_0p1mm
;

177 
öt32_t
 
	moff£t_u£r
;

178 
uöt32_t
 
	mxèlk_u£r
;

183 
	sgp2≠04vt_£ns‹
 {

184 
uöt8_t
 
	m¶ave_addr
;

186 #ifde‡
__KERNEL__


187 
muãx
 
	mmuãx
;

188 
i2c_˛õ¡
 *
	m˛õ¡
;

189 
miscdevi˚
 
	mgp2≠04vt_misc
;

190 
öput_dev
 *
	mønge_öput_dev
;

191 
dñayed_w‹k
 
	mw‹k_queue_timî
;

192 
w‹k_°ru˘
 
	mw‹k_queue_ext_öt
;

193 
uöt8_t
 
	mønge_íabÀd
;

194 
	mønge_dñay
;

195 
	mønge_úq
;

197 
	mgp2≠04vt_›íed
;

199 
of_gpio_Êags
 
	múq_gpio_Êags
;

203 
gp2≠04vt_d©a
 
	md©a
;

206 #ifde‡
__KERNEL__


207 
gp2≠_i2c_wrôe
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

208 
gp2≠_i2c_ªad
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

211 #i‚de‡
__KERNEL__


212 
gp2≠_i2c_wrôe
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

213 
gp2≠_i2c_ªad
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

216 
gp2≠04vt_öô_∑ømas
(
gp2≠04vt_£ns‹
 *);

217 
gp2≠04vt_öô_£ns‹
(
gp2≠04vt_£ns‹
 *);

218 
gp2≠04vt_˛ór_ˇlibøti⁄_d©a
(
gp2≠04vt_£ns‹
 *);

219 
gp2≠04vt_£t_vs1
(
gp2≠04vt_£ns‹
 *);

220 
gp2≠04vt_so·w¨e_ª£t
(
gp2≠04vt_£ns‹
 *);

221 
gp2≠04vt_íabÀ_£ns‹
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

222 
gp2≠04vt_°¨t_øngög
(
gp2≠04vt_£ns‹
 *);

223 
gp2≠04vt_°›_øngög
(
gp2≠04vt_£ns‹
 *);

224 
gp2≠04vt_ªad_ønge_d©a
(
gp2≠04vt_£ns‹
 *);

225 
gp2≠04vt_ªad_°©us_d©a
(
gp2≠04vt_£ns‹
 *);

226 
gp2≠04vt_ªad_ãm≥øtuª
(
gp2≠04vt_£ns‹
 *);

227 
gp2≠04vt_ªad_sys_˛ock
(
gp2≠04vt_£ns‹
 *);

228 
uöt16_t
 
gp2≠04vt_ªad_checksum
(
gp2≠04vt_£ns‹
 *);

229 
uöt8_t
 
gp2≠04vt_gë_devi˚_id
(
gp2≠04vt_£ns‹
 *);

230 
gp2≠04vt_gë_ønge_d©a
(
gp2≠04vt_£ns‹
 *);

231 
gp2≠04vt_gë_sig«l_d©a
(
gp2≠04vt_£ns‹
 *);

232 
uöt8_t
 
gp2≠04vt_ªad_Êag
(
gp2≠04vt_£ns‹
 *);

233 
gp2≠04vt_˛ór_Êag
(
gp2≠04vt_£ns‹
 *);

234 
gp2≠04vt_≥rf‹m_off£t_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

235 
gp2≠04vt_≥rf‹m_xèlk_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

236 
gp2≠04vt_gë_off£t_d©a
(
gp2≠04vt_£ns‹
 *);

237 
gp2≠04vt_gë_xèlk_d©a
(
gp2≠04vt_£ns‹
 *);

238 
gp2≠04vt_off£t_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

239 
gp2≠04vt_xèlk_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

240 
gp2≠04vt_ˇlcuœã_off£t
(
gp2≠04vt_d©a
 *);

241 
gp2≠04vt_ˇlcuœã_xèlk
(
gp2≠04vt_d©a
 *);

242 
gp2≠04vt_£t_off£t_d©a
(
gp2≠04vt_£ns‹
 *);

243 
gp2≠04vt_£t_xèlk_d©a
(
gp2≠04vt_£ns‹
 *);

244 
gp2≠04vt_ªad_öã∫Æ_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *);

245 
gp2≠04vt_£t_mu…ùÀ_£ns‹s
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

246 
gp2≠04vt_£t_mu…ùÀ_£ns‹s_˚
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

247 
gp2≠04vt_£t_mu…ùÀ_£ns‹s_dc
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

248 
gp2≠04vt_£t_gpio1
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

249 
gp2≠04vt_£t_dy«mic_addªss
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
);

250 
gp2≠04vt_ªad_cup_d©a
(
gp2≠04vt_£ns‹
 *);

251 
gp2≠04vt_check_cup_edge
(
gp2≠04vt_£ns‹
 *);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap04vt_firmware.c

1 
	~"gp2≠04vt_fúmw¨e.h
"

4 c⁄° 
uöt8_t
 
	ggp2≠04vt_fúmw¨e
[] =

646 
	$gp2≠04vt_wrôe_fúmw¨e
(
gp2≠04vt_£ns‹
 *
pdev
)

648 
uöt16_t
 
size
;

649 
uöt16_t
 
∑ge
 = 0;

650 
uöt8_t
 
wd©a
[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

651 
uöt8_t
 
i
;

653 
size
 = (
gp2≠04vt_fúmw¨e
);

657 
wd©a
[0] = 
ROM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

658 
wd©a
[0] = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

659 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

660 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

661 
	`DELAY_FUNCTION
(1);

663 
size
 >= 16)

665 
i
 = 0; i < 16; i++) {

666 
wd©a
[
i
] = 
gp2≠04vt_fúmw¨e
[
∑ge
 * 16 + i];

669 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 16);

671 
size
 -= 16;

672 
∑ge
++;

675 if(
size
 > 0)

677 
i
 = 0; i < 
size
; i++) {

678 
wd©a
[
i
] = 
gp2≠04vt_fúmw¨e
[
∑ge
 * 16 + i];

681 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 
size
);

684 
	`gp2≠04vt_ªad_checksum
(
pdev
);

686 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

687 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

688 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

689 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

690 
	`DELAY_FUNCTION
(2);

691 
	}
}

693 
	$gp2≠04vt_wrôe_fúmw¨e_löux
(
gp2≠04vt_£ns‹
 *
pdev
, *
fw_d©a
, 
size
)

695 
uöt16_t
 
∑ge
 = 0;

696 
uöt8_t
 
wd©a
[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

697 
uöt8_t
 
i
;

701 
wd©a
[0] = 
ROM
; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

702 
wd©a
[0] = 0x80; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

703 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

704 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

705 
	`DELAY_FUNCTION
(1);

707 
size
 >= 16)

709 
i
 = 0; i < 16; i++) {

710 
wd©a
[
i
] = 
fw_d©a
[
∑ge
 * 16 + i];

713 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 16);

715 
size
 -= 16;

716 
∑ge
++;

719 if(
size
 > 0)

721 
i
 = 0; i < 
size
; i++) {

722 
wd©a
[
i
] = 
fw_d©a
[
∑ge
 * 16 + i];

725 
	`gp2≠_i2c_wrôe
(
pdev
, 0x22, 
wd©a
, 
size
);

728 
	`gp2≠04vt_ªad_checksum
(
pdev
);

730 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x00, wdata, 1);

731 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x1F, wdata, 1);

732 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x20, wdata, 1);

733 
wd©a
[0] = 0x00; 
	`gp2≠_i2c_wrôe
(
pdev
, 0x21, wdata, 1);

734 
	`DELAY_FUNCTION
(2);

735 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap04vt_firmware.h

1 #i‚de‡
_GP2AP04VT_FIRMWARE_H_


2 
	#_GP2AP04VT_FIRMWARE_H_


	)

4 
	~"gp2≠04vt_≠i.h
"

6 
gp2≠04vt_wrôe_fúmw¨e
(
gp2≠04vt_£ns‹
 *);

7 
gp2≠04vt_wrôe_fúmw¨e_löux
(
gp2≠04vt_£ns‹
 *, *, );

9 #i‚de‡
__KERNEL__


10 
	#FIRMWARE_CHECKSUM
 0xE431

	)

13 #ifde‡
__KERNEL__


14 
	#FIRMWARE_CHECKSUM
 0x896F

	)

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap_i2c.c

6 
	~"hÆ_i2c.h
"

8 
	~<gp2≠_i2c.h
>

9 
	~<°dlib.h
>

10 
	~<°rög.h
>

12 
	~"gp2≠04vt_≠i.h
"

13 
	~"hÆ_ì¥om.h
"

14 
	~"r_cg_£rül.h
"

17 
	#WRITE_DELAY
 1500

	)

18 
	#READ_DELAY
 1000

	)

21 
	s_tof_


24 
U8
 
	mWrôeProc
;

25 
U8
 
	mRódProc
;

27 
U32
 
	mRódFaû
;

28 
U32
 
	mRódOk
;

30 
U32
 
	mWrôeFaû
;

31 
U32
 
	mWrôeOk
;

32 } 
	tTOF_T
;

34 
TOF_T
 
	gtof
;

37 
	$HAL_TOF_Inô
()

39 
	`mem£t
–&
tof
, 0, –
TOF_T
 ));

40 
	}
}

42 
	$HAL_TOF_SëWrôeProc
–
U8
 
_¥oc
 )

44 
tof
.
WrôeProc
 = 
_¥oc
;

45 
	}
}

47 
U8
 
	$HAL_TOF_GëWrôeProc
( )

49  
tof
.
WrôeProc
;

50 
	}
}

52 
BOOL_T
 
	$HAL_TOF_WrôeProcCom∂ëe
( )

54 
U16
 
waô
 = 10000;

58 if–
waô
 > 0 )

59 
waô
--;

61  
FALSE
;

63  !–
	`HAL_TOF_GëWrôeProc
(Ë=
TOF_PROC_DONE
 ) );

65  
TRUE
;

66 
	}
}

68 
	$HAL_TOF_SëRódProc
–
U8
 
_¥oc
 )

70 
tof
.
RódProc
 = 
_¥oc
;

71 
	}
}

73 
U8
 
	$HAL_TOF_GëRódProc
( )

75  
tof
.
RódProc
;

76 
	}
}

78 
BOOL_T
 
	$HAL_TOF_RódProcCom∂ëe
( )

80 
U16
 
waô
 = 10000;

84 if–
waô
 > 0 )

85 
waô
--;

87  
FALSE
;

89  !–
	`HAL_TOF_GëRódProc
(Ë=
TOF_PROC_DONE
 ) );

91  
TRUE
;

92 
	}
}

94 
	$Cou¡RódEº‹
()

96 
tof
.
RódFaû
++;

97 
	}
}

99 
	$Cou¡WrôeEº‹
()

101 
tof
.
WrôeFaû
++;

102 
	}
}

104 
	$i2ˇ0_St›C⁄dôi⁄
()

106 
	`R_IICA0_St›C⁄dôi⁄
();

107 
	}
}

116 
	$gp2≠_i2c_wrôe
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
w‹d_addªss
, uöt8_à*
wd©a
, uöt8_à
Àn
)

118 
uöt16_t
 
ªt
 = 0;

119 
uöt8_t
 
buf
[20];

122 
buf
[0] = 
w‹d_addªss
;

123 
	`mem˝y
(
buf
 + 1, 
wd©a
, 
Àn
);

125 
	`HAL_TOF_SëWrôeProc
–
TOF_PROC_START
 );

126 
ªt
 = 
	`i2ˇ0_ma°î_£nd
(
pdev
->
¶ave_addr
 << 1, 
buf
, 
Àn
 + 1, 200);

127 i‡(
ªt
 != 0) {

128 
	`Cou¡WrôeEº‹
();

129 
	`i2ˇ0_St›C⁄dôi⁄
();

133 if–!
	`HAL_TOF_WrôeProcCom∂ëe
() )

135 
	`Cou¡WrôeEº‹
();

136 
	`i2ˇ0_St›C⁄dôi⁄
();

140 
	`i2ˇ0_St›C⁄dôi⁄
();

142 
	`Dñay_US
–
WRITE_DELAY
 );

143 
tof
.
WrôeOk
++;

146 
	}
}

155 
	$gp2≠_i2c_ªad
(
gp2≠04vt_£ns‹
 *
pdev
, 
uöt8_t
 
w‹d_addªss
, uöt8_à*
rd©a
, uöt8_à
Àn
)

157 
uöt16_t
 
ªt
 = 0;

160 
	`HAL_TOF_SëWrôeProc
–
TOF_PROC_START
 );

161 
ªt
 = 
	`i2ˇ0_ma°î_£nd
((
pdev
->
¶ave_addr
 << 1), &
w‹d_addªss
, 1, 200);

162 i‡(
MD_OK
 != 0)

164 
	`Cou¡RódEº‹
();

165 
	`i2ˇ0_St›C⁄dôi⁄
();

166 *
rd©a
 = 0xFF;

170 if–!
	`HAL_TOF_WrôeProcCom∂ëe
() )

172 
	`Cou¡RódEº‹
();

173 
	`i2ˇ0_St›C⁄dôi⁄
();

177 
	`HAL_TOF_SëRódProc
–
TOF_PROC_START
 );

179 
ªt
 = 
	`i2ˇ0_ma°î_ªcv
((
pdev
->
¶ave_addr
 << 1), 
rd©a
, 
Àn
, 200);

180 i‡(
ªt
 != 0)

182 *
rd©a
 = 0xFF;

183 
	`Cou¡RódEº‹
();

184 
	`i2ˇ0_St›C⁄dôi⁄
();

188 if–!
	`HAL_TOF_RódProcCom∂ëe
() )

190 
	`Cou¡RódEº‹
();

191 
	`i2ˇ0_St›C⁄dôi⁄
();

195 
	`i2ˇ0_St›C⁄dôi⁄
();

196 
	`Dñay_US
–
READ_DELAY
 );

197 
tof
.
RódOk
++;

199 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap_i2c.h

5 #i‚de‡
GP2AP_I2C_H_


6 
	#GP2AP_I2C_H_


	)

10 
	~"¥j_ty≥.h
"

11 
	~"gp2≠04vt_≠i.h
"

14 
	#TIMEI2C1
 200

	)

15 
	#TIMEI2C2
 1

	)

16 
	#CLOCKDEFI2C
 400

	)

17 
	#CLOCKMAXI2C
 1000

	)

18 
	#CLOCKMINI2C
 10

	)

20 
	#TOF_PROC_START
 0

	)

21 
	#TOF_PROC_DONE
 1

	)

25 
HAL_TOF_Inô
();

32 
HAL_TOF_SëWrôeProc
–
U8
 
_¥oc
 );

39 
U8
 
HAL_TOF_GëWrôeProc
( );

46 
HAL_TOF_SëRódProc
–
U8
 
_¥oc
 );

54 
U8
 
HAL_TOF_GëRódProc
( );

57 
gp2≠_i2c_ªad
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

58 
gp2≠_i2c_ªad_§am
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

59 
gp2≠_i2c_wrôe
(
gp2≠04vt_£ns‹
 *, 
uöt8_t
, uint8_t *, uint8_t);

60 
£tI2CClock
(
uöt32_t
);

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\tof.c

1 #¥agm®
öãºu±
 
INTP3
 
r_ötc3_öãºu±


3 
	~"hw.h
"

4 
	~"tof.h
"

5 
	~"gp2≠04vt_≠i.h
"

6 
	~"gp2≠04vt_fúmw¨e.h
"

7 
	~"r_cg_ötc.h
"

11 
gp2≠04vt_£ns‹
 
	gdev
[ 
MAX_TOF_ID
 ];

13 
	#ERROR_NO_DEVICE
 0x0001

	)

14 
	#ERROR_FIRMWARE_CHECKSUM
 0x0002

	)

15 
	#ERROR_CALIBRATION_OFFSET
 0x0004

	)

16 
	#ERROR_CALIBRATION_CROSSTALK
 0x0008

	)

17 
U16
 
	gtof_îr‹
[ 
MAX_TOF_ID
 ] = {0,};

19 
U8
 
	gtof_ªcv
[ 
MAX_TOF_ID
 ] = {0,};

20 
U32
 
	gtof_ªcv_i§_˙t
[ 
MAX_TOF_ID
 ] = {0,};

21 
U32
 
	gtof_ªcv_ªad_˙t
[ 
MAX_TOF_ID
 ] = {0,};

24 
	$gp2≠04vt_£t_îr‹
–
U8
 
id
, 
U16
 
îr‹
 )

26 
tof_îr‹
[ 
MAX_TOF_ID
 ] |
îr‹
;

27 
	}
}

30 
	$InôToF
()

32 
	`TURN_ON_TOF_1
();

34 
dev
[
TOF_ID_1
].
¶ave_addr
 = 0x29;

36 
	`gp2≠04vt_wrôe_fúmw¨e
(&
dev
[
TOF_ID_1
]);

39 
dev
[
TOF_ID_1
].
d©a
.
£ns‹_°©us
 = 
NOT_CALIBRATED
;

40 
dev
[
TOF_ID_1
].
d©a
.
off£t_u£r
 = 0;

41 
dev
[
TOF_ID_1
].
d©a
.
xèlk_u£r
 = 0;

43 
dev
[
TOF_ID_1
].
d©a
.
mode
 = 
MODE_SENSOR_OFF
;

45 
	`gp2≠04vt_öô_£ns‹
(&
dev
[
TOF_ID_1
]);

54 
	`R_INTC3_Sèπ
();

55 
	}
}

59 
	$DoCÆibøti⁄_ID
(
U8
 
id
)

61 
gp2≠04vt_£ns‹
 *
pdev
 = &
dev
[
id
];

62 
gp2≠04vt_d©a
 *
pd©a
 = &
dev
[
id
].
d©a
;

64 i‡(
pd©a
->
mode
 =
MODE_OFFSET_CALIBRATION
)

66 
	`gp2≠04vt_ªad_Êag
(
pdev
) == 0)

69 
	`Dñay_MS
(90);

72 
	`gp2≠04vt_gë_off£t_d©a
(
pdev
);

74 i‡(
pd©a
->
off£t_u£r
 == 22222)

76 
	`gp2≠04vt_£t_îr‹
–
id
, 
ERROR_CALIBRATION_OFFSET
 );

80 i‡(
pd©a
->
mode
 =
MODE_XTALK_CALIBRATION
)

82 
	`gp2≠04vt_ªad_Êag
(
pdev
) == 0)

85 
	`Dñay_MS
(99);

88 
	`gp2≠04vt_gë_xèlk_d©a
(
pdev
);

90 i‡(
pd©a
->
xèlk_u£r
 >= 200)

92 
	`gp2≠04vt_£t_îr‹
–
id
, 
ERROR_CALIBRATION_CROSSTALK
 );

95 
	}
}

98 
	$DoCÆibøti⁄
()

100 
	`DoCÆibøti⁄_ID
–
TOF_ID_1
 );

101 
	}
}

104 
	$SèπR™ge
(
U8
 
id
)

108 
	`gp2≠04vt_°¨t_øngög
–&
dev
[
id
] );

109 
	`gp2≠04vt_ªad_Êag
(&
dev
[
id
]) == 0) {

110 
	`Dñay_MS
( 5 );

113 
	`gp2≠04vt_°›_øngög
(&
dev
[ 
id
 ]);

114 
	`gp2≠04vt_gë_ønge_d©a
(&
dev
[ 
id
 ]);

115 
	`gp2≠04vt_˛ór_Êag
(&
dev
[ 
id
 ]);

119 
	`gp2≠04vt_íabÀ_£ns‹
(&
dev
[ 
id
 ], 
SENSOR_OFF
);

121 
	`gp2≠04vt_gë_ønge_d©a
(&
dev
[ 
id
 ]);

122 
	`gp2≠04vt_ªad_cup_d©a
(&
dev
[ 
id
 ]);

123 
	`gp2≠04vt_check_cup_edge
(&
dev
[ 
id
 ]);

125 
	`gp2≠04vt_˛ór_Êag
(&
dev
[ 
id
 ]);

126 
	`gp2≠04vt_íabÀ_£ns‹
(&
dev
[ 
id
 ], 
SENSOR_ON
);

127 
	}
}

129 
U8
 
	$CheckSèπR™ge
(
U8
 
id
 )

131 if(
	`gp2≠04vt_ªad_Êag
(&
dev
[
id
]) == 0) {

133  
FALSE
;

136  
TRUE
;

137 
	}
}

139 
	$St›R™ge
(
U8
 
id
)

141 
	`gp2≠04vt_°›_øngög
–&
dev
[
id
] );

142 
	}
}

144 
I16
 
	$GëR™ge
(
U8
 
id
)

146  
dev
[ 
id
 ].
d©a
.
ønge
;

147 
	}
}

149 
U8
 
	$xèlk_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

151 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

153 
	`gp2≠04vt_≥rf‹m_xèlk_ˇlibøti⁄
(
pdev
);

155 
	`gp2≠04vt_ªad_Êag
(
pdev
) == 0) {

156 
	`Dñay_MS
(33);

159 
	`gp2≠04vt_gë_xèlk_d©a
(
pdev
);

161 i‡(
pd©a
->
xèlk_u£r
 < 200) {

162  
TRUE
;

172  
FALSE
;

175 
	`¥ötf
("£ns‹_°©us: 0x%X\r\n", 
pd©a
->
£ns‹_°©us
);

176 
	`¥ötf
("xèlk_u£r: %ld\r\n", 
pd©a
->
xèlk_u£r
);

178 
	}
}

180 
U8
 
	$off£t_ˇlibøti⁄
(
gp2≠04vt_£ns‹
 *
pdev
)

182 
gp2≠04vt_d©a
 *
pd©a
 = &
pdev
->
d©a
;

184 
	`gp2≠04vt_≥rf‹m_off£t_ˇlibøti⁄
(
pdev
);

186 
	`gp2≠04vt_ªad_Êag
(
pdev
) == 0) {

187 
	`Dñay_MS
(33);

190 
	`gp2≠04vt_gë_off£t_d©a
(
pdev
);

192 i‡(
pd©a
->
off£t_u£r
 != 22222) {

193  
TRUE
;

196  
FALSE
;

201 
	`¥ötf
("Off£àˇlibøti⁄ di°™˚[mm]: %d \r\n", 
OFFSET_CALIBRAION_DISTANCE_MM
);

202 
	`¥ötf
("£ns‹_°©us: 0x%X \r\n", 
pd©a
->
£ns‹_°©us
);

203 
	`¥ötf
("off£t[0.1mm]: %ld\r\n", 
pd©a
->
off£t_0p1mm
);

204 
	`¥ötf
("off£t_u£r[bö]: %ld\r\n", 
pd©a
->
off£t_u£r
);

206 
	}
}

208 
U8
 
	gdbg_off£t
 = 0;

209 
U8
 
	gdbg_xèlk
 = 0;

210 
U8
 
	gdbg_Êo‹
 = 0;

211 
U8
 
	goff£t_°©us
[ 
MAX_TOF_ID
 ];

212 
U8
 
	gxèlk_°©us
[ 
MAX_TOF_ID
 ];

214 
U8
 
	$GëSètusOff£tCÆibøti⁄
()

216 if–
off£t_°©us
[ 0 ] =
FALSE
 )

218  
FALSE
;

221  
TRUE
;

222 
	}
}

224 
U8
 
	$GëSètusXèlkCÆibøti⁄
()

226 if–
xèlk_°©us
[ 0 ] =
FALSE
 )

228  
FALSE
;

231  
TRUE
;

232 
	}
}

234 
	$Pro˚ssToF
()

236 
U8
 
i
;

238  
i
 = 0; i < 
MAX_TOF_ID
 ; i++ )

240 if–
tof_ªcv
[
i
] =
TRUE
 )

242 
tof_ªcv
[
i
] = 
FALSE
;

243 
tof_ªcv_ªad_˙t
[
i
]++;

247 if–
dbg_off£t
 )

249 
dbg_off£t
 = 0;

251 
off£t_°©us
[ 0 ] = 
	`off£t_ˇlibøti⁄
–&
dev
[ 
TOF_ID_1
 ]);

254 if–
dbg_xèlk
 )

256 
dbg_xèlk
 = 0;

258 
xèlk_°©us
[ 0 ] = 
	`xèlk_ˇlibøti⁄
–&
dev
[ 
TOF_ID_1
 ]);

264 if–
dbg_Êo‹
 )

266 
dbg_Êo‹
 = 0;

268 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_1
 ]);

269 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_2
 ]);

270 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_3
 ]);

271 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_4
 ]);

272 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_5
 ]);

273 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_6
 ]);

274 
	`gp2≠04vt_£t_Êo‹_di°™˚
–&
dev
[ 
TOF_ID_7
 ]);

278 
	}
}

281 
__öãºu±
 
	$r_ötc3_öãºu±
()

283 
tof_ªcv
[ 
TOF_ID_1
 ] = 
TRUE
;

284 
tof_ªcv_i§_˙t
[ 
TOF_ID_1
 ]++;

285 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\tof.h

1 #i‚de‡
__TOF__


2 
	#__TOF__


	)

4 
	~"¥j_ty≥.h
"

7 
	#TOF_ID_1
 0

	)

8 
	#MAX_TOF_ID
 1

	)

10 
InôToF
();

12 
DoCÆibøti⁄
();

14 
SèπR™ge
(
U8
 
id
);

16 
U8
 
CheckSèπR™ge
(U8 
id
 );

18 
St›R™ge
(
U8
 
id
);

20 
I16
 
GëR™ge
(
U8
 
id
);

22 
U8
 
GëSètusOff£tCÆibøti⁄
();

24 
U8
 
GëSètusXèlkCÆibøti⁄
();

26 
Pro˚ssToF
();

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_eeprom.c

3 
	~"hw.h
"

4 
	~"r_cg_£rül.h
"

5 
	~"hÆ_i2c.h
"

6 
	~"hÆ_ì¥om.h
"

7 
	~"utû.h
"

10 
	#EEP_OP_WR
 0x00

	)

11 
	#EEP_OP_RD
 0x01

	)

13 
	#DEFAULT_DELAY
 35

	)

14 
	#DEFAULT_RETRY_COUNT
 3

	)

16 
	s_πc_i¶12026_


19 
U8
 
	mWrôeProc
;

20 
U8
 
	mRódProc
;

22 
U32
 
	mRódFaû
;

23 
U32
 
	mRódOk
;

25 
U32
 
	mWrôeFaû
;

26 
U32
 
	mWrôeOk
;

27 } 
	tRTC_T
;

29 
RTC_T
 
	gπc
;

40 
	$HAL_RTC_Inô
()

42 
	`mem£t
–&
πc
, 0, –
RTC_T
 ));

43 
	}
}

50 
	$HAL_RTC_SëWrôeProc
–
U8
 
_¥oc
 )

52 
πc
.
WrôeProc
 = 
_¥oc
;

53 
	}
}

60 
U8
 
	$HAL_RTC_GëWrôeProc
( )

62  
πc
.
WrôeProc
;

63 
	}
}

70 
BOOL_T
 
	$HAL_RTC_WrôeProcCom∂ëe
( )

72 
U16
 
waô
 = 10000;

76 if–
waô
 > 0 )

77 
waô
--;

79  
FALSE
;

81  !–
	`HAL_RTC_GëWrôeProc
(Ë=
EEP_PROC_DONE
 ) );

83  
TRUE
;

84 
	}
}

91 
	$HAL_RTC_SëRódProc
–
U8
 
_¥oc
 )

93 
πc
.
RódProc
 = 
_¥oc
;

94 
	}
}

101 
U8
 
	$HAL_RTC_GëRódProc
( )

103  
πc
.
RódProc
;

104 
	}
}

111 
BOOL_T
 
	$HAL_RTC_RódProcCom∂ëe
( )

113 
U16
 
waô
 = 10000;

117 if–
waô
 > 0 )

118 
waô
--;

120  
FALSE
;

122  !–
	`HAL_RTC_GëRódProc
(Ë=
EEP_PROC_DONE
 ) );

124  
TRUE
;

125 
	}
}

127 
	$Cou¡RódEº‹
()

129 
πc
.
RódFaû
++;

130 
	}
}

132 
	$Cou¡WrôeEº‹
()

134 
πc
.
WrôeFaû
++;

135 
	}
}

137 
	$i2ˇ0_St›C⁄dôi⁄
()

139 
	`R_IICA0_St›C⁄dôi⁄
();

141 
	}
}

148 
BOOL_T
 
	$ByãWrôe
–
U8
 
_dev
, 
U16
 
_addr
 , U8 
_d©a
 )

150 
U8
 
buf
[ 3 ];

152 
buf
[ 0 ] = 
	`GET_HIGH_BYTE
(
_addr
);

153 
buf
[ 1 ] = 
	`GET_LOW_BYTE
(
_addr
);

154 
buf
[ 2 ] = 
_d©a
;

157 
	`HAL_RTC_SëWrôeProc
–
EEP_PROC_START
 );

159 if–
	`i2ˇ0_ma°î_£nd
–
_dev
 | 
EEP_OP_WR
 , &
buf
[1] , 2 , 200 ) !
MD_OK
 )

161 
	`Cou¡WrôeEº‹
();

163 
	`i2ˇ0_St›C⁄dôi⁄
();

164  
FALSE
;

167 if–!
	`HAL_RTC_WrôeProcCom∂ëe
() )

169 
	`Cou¡WrôeEº‹
();

170 
	`i2ˇ0_St›C⁄dôi⁄
();

171  
FALSE
;

174 
	`i2ˇ0_St›C⁄dôi⁄
();

175 
	`Dñay_MS
–
DEFAULT_DELAY
 );

178 
πc
.
WrôeOk
++;

179  
TRUE
;

180 
	}
}

182 
BOOL_T
 
	$HAL_RTC_ByãWrôe
–
U8
 
_dev
, 
U16
 
_addr
 , U8 
_d©a
 )

184 
U8
 
mu8RëryCou¡
 = 
DEFAULT_RETRY_COUNT
;

190 if–
mu8RëryCou¡
 == 0 )

192  
FALSE
;

194 
mu8RëryCou¡
--;

196 
	`RESET_WDT
();

199  
	`ByãWrôe
–
_dev
, 
_addr
, 
_d©a
 ) !
TRUE
 );

201 
	`RESET_WDT
();

202  
TRUE
;

203 
	}
}

211 
BOOL_T
 
	$PageWrôe
–
U8
 
_dev
, 
U16
 
_addr
 , U8 *
_d©a
, U8 
_Àn
 )

213 
U8
 
buf
 [ 
EEP_PAGE_SIZE
 + 2 ];

214 
U8
 
rbuf
[ 
EEP_PAGE_SIZE
 ];

216 
buf
[ 0 ] = 
	`GET_HIGH_BYTE
(
_addr
);

217 
buf
[ 1 ] = 
	`GET_LOW_BYTE
(
_addr
);

219 
	`mem˝y
–&
buf
[ 2 ], &
_d©a
[ 0 ], 
_Àn
 );

221 
	`HAL_RTC_SëWrôeProc
–
EEP_PROC_START
 );

225 if–
	`i2ˇ0_ma°î_£nd
–
_dev
 | 
EEP_OP_WR
 , &
buf
[ 1 ] , 
_Àn
 + 1 , 200 ) !
MD_OK
 )

227 
	`Cou¡WrôeEº‹
();

228 
	`i2ˇ0_St›C⁄dôi⁄
();

229  
FALSE
;

232 if–!
	`HAL_RTC_WrôeProcCom∂ëe
() )

234 
	`Cou¡WrôeEº‹
();

235 
	`i2ˇ0_St›C⁄dôi⁄
();

236  
FALSE
;

239 
	`i2ˇ0_St›C⁄dôi⁄
();

240 
	`Dñay_MS
–
DEFAULT_DELAY
 );

244 if–!
	`HAL_RTC_SeqRód
–
_dev
, 
_addr
, &
rbuf
[ 0 ], 
_Àn
 ) )

246 
	`Cou¡WrôeEº‹
();

247 
	`i2ˇ0_St›C⁄dôi⁄
();

248  
FALSE
;

252 if–
	`memcmp
–&
buf
[ 2 ], &
rbuf
[ 0 ], 
_Àn
 ) != 0 )

254 
	`Cou¡WrôeEº‹
();

255 
	`i2ˇ0_St›C⁄dôi⁄
();

256  
FALSE
;

259 
	`i2ˇ0_St›C⁄dôi⁄
();

260 
	`Dñay_MS
–
DEFAULT_DELAY
 );

262 
πc
.
WrôeOk
++;

263  
TRUE
;

264 
	}
}

266 
BOOL_T
 
	$HAL_RTC_PageWrôe
–
U8
 
_dev
, 
U16
 
_addr
 , U8 *
_d©a
, U8 
_Àn
 )

268 
U8
 
mu8RëryCou¡
 = 
DEFAULT_RETRY_COUNT
;

273 if–
mu8RëryCou¡
 == 0 )

275  
FALSE
;

277 
mu8RëryCou¡
--;

279 
	`RESET_WDT
();

282  
	`PageWrôe
–
_dev
, 
_addr
, 
_d©a
, 
_Àn
 ) !
TRUE
 );

284 
	`RESET_WDT
();

285  
TRUE
;

286 
	}
}

295 
BOOL_T
 
	$CuºítAddrRód
–
U8
 
_dev
, U8 *
_d©a
 )

297 
	`HAL_RTC_SëRódProc
–
EEP_PROC_START
 );

299 if–
	`i2ˇ0_ma°î_ªcv
–
_dev
 | 
EEP_OP_RD
 , 
_d©a
 , 1 , 10 ) !
MD_OK
 )

301 
	`Cou¡RódEº‹
();

302 
	`i2ˇ0_St›C⁄dôi⁄
();

303  
FALSE
;

306 if–!
	`HAL_RTC_RódProcCom∂ëe
() )

308 
	`Cou¡RódEº‹
();

309 
	`i2ˇ0_St›C⁄dôi⁄
();

310  
FALSE
;

313 
	`i2ˇ0_St›C⁄dôi⁄
();

314 
	`Dñay_MS
–
DEFAULT_DELAY
 );

315 
πc
.
RódOk
++;

316  
TRUE
;

317 
	}
}

319 
BOOL_T
 
	$HAL_RTC_CuºítAddrRód
–
U8
 
_dev
, U8 *
_d©a
 )

321 
U8
 
mu8RëryCou¡
 = 
DEFAULT_RETRY_COUNT
;

327 if–
mu8RëryCou¡
 == 0 )

329  
FALSE
;

331 
mu8RëryCou¡
--;

333 
	`RESET_WDT
();

336  
	`CuºítAddrRód
–
_dev
, 
_d©a
 ) !
TRUE
 );

338 
	`RESET_WDT
();

339  
TRUE
;

340 
	}
}

346 
BOOL_T
 
	$ByãRód
–
U8
 
_dev
, 
U16
 
_addr
 , U8 *
_d©a
 )

348 
U8
 
buf
[2] = {0};

351 
buf
[0] = 
	`GET_HIGH_BYTE
–
_addr
 );

352 
buf
[1] = 
	`GET_LOW_BYTE
–
_addr
 );

354 
	`HAL_RTC_SëWrôeProc
–
EEP_PROC_START
 );

357 if–
	`i2ˇ0_ma°î_£nd
–
_dev
 | 
EEP_OP_WR
 , &
buf
[1] , 1 , 200 ) !
MD_OK
 )

359 
	`Cou¡RódEº‹
();

360 
	`i2ˇ0_St›C⁄dôi⁄
();

361  
FALSE
;

364 if–!
	`HAL_RTC_WrôeProcCom∂ëe
() )

366 
	`Cou¡RódEº‹
();

367 
	`i2ˇ0_St›C⁄dôi⁄
();

368  
FALSE
;

371 
	`HAL_RTC_SëRódProc
–
EEP_PROC_START
 );

374 if–
	`i2ˇ0_ma°î_ªcv
–
_dev
 | 
EEP_OP_RD
 , 
_d©a
 , 1 , 200 ) !
MD_OK
 )

376 
	`Cou¡RódEº‹
();

377 
	`i2ˇ0_St›C⁄dôi⁄
();

378  
FALSE
;

382 if–!
	`HAL_RTC_RódProcCom∂ëe
() )

384 
	`Cou¡RódEº‹
();

385 
	`i2ˇ0_St›C⁄dôi⁄
();

386  
FALSE
;

389 
	`i2ˇ0_St›C⁄dôi⁄
();

390 
	`Dñay_MS
–
DEFAULT_DELAY
 );

391 
πc
.
RódOk
++;

392  
TRUE
;

393 
	}
}

395 
BOOL_T
 
	$HAL_RTC_ByãRód
–
U8
 
_dev
, 
U16
 
_addr
 , U8 *
_d©a
 )

397 
U8
 
mu8RëryCou¡
 = 
DEFAULT_RETRY_COUNT
;

402 if–
mu8RëryCou¡
 == 0 )

404  
FALSE
;

406 
mu8RëryCou¡
--;

408 
	`RESET_WDT
();

411  
	`ByãRód
–
_dev
, 
_addr
 , 
_d©a
 ) !
TRUE
 );

413 
	`RESET_WDT
();

414  
TRUE
;

415 
	}
}

422 
BOOL_T
 
	$SeqRód
–
U8
 
_dev
, 
U16
 
_addr
 , U8 * 
_d©a
, U8 
_Àn
 )

424 
U8
 
buf
[2] = {0};

427 
buf
[0] = 
	`GET_HIGH_BYTE
–
_addr
 );

428 
buf
[1] = 
	`GET_LOW_BYTE
–
_addr
 );

429 
	`HAL_RTC_SëWrôeProc
–
EEP_PROC_START
 );

433 if–
	`i2ˇ0_ma°î_£nd
–
_dev
 | 
EEP_OP_WR
 , &
buf
[1] , 1 , 200 ) !
MD_OK
 )

435 
	`Cou¡RódEº‹
();

436 
	`i2ˇ0_St›C⁄dôi⁄
();

437  
FALSE
;

441 if–!
	`HAL_RTC_WrôeProcCom∂ëe
() )

443 
	`Cou¡RódEº‹
();

444 
	`i2ˇ0_St›C⁄dôi⁄
();

445  
FALSE
;

448 
	`HAL_RTC_SëRódProc
–
EEP_PROC_START
 );

451 if–
	`i2ˇ0_ma°î_ªcv
–
_dev
 | 
EEP_OP_RD
 , 
_d©a
 , 
_Àn
 , 200 ) !
MD_OK
 )

453 
	`Cou¡RódEº‹
();

454 
	`i2ˇ0_St›C⁄dôi⁄
();

455  
FALSE
;

458 if–!
	`HAL_RTC_RódProcCom∂ëe
() )

460 
	`Cou¡RódEº‹
();

461 
	`i2ˇ0_St›C⁄dôi⁄
();

462  
FALSE
;

466 
	`i2ˇ0_St›C⁄dôi⁄
();

467 
	`Dñay_MS
–
DEFAULT_DELAY
 );

468 
πc
.
RódOk
++;

469  
TRUE
;

470 
	}
}

472 
BOOL_T
 
	$HAL_RTC_SeqRód
–
U8
 
_dev
, 
U16
 
_addr
 , U8 * 
_d©a
, U8 
_Àn
 )

474 
U8
 
mu8RëryCou¡
 = 
DEFAULT_RETRY_COUNT
;

479 if–
mu8RëryCou¡
 == 0 )

481  
FALSE
;

483 
mu8RëryCou¡
--;

485 
	`RESET_WDT
();

488  
	`SeqRód
–
_dev
, 
_addr
 , 
_d©a
, 
_Àn
 ) !
TRUE
 );

490 
	`RESET_WDT
();

491  
TRUE
;

492 
	}
}

499 
BOOL_T
 
	$HAL_RTC_EEPROM_AŒEø£
( )

501 
U8
 
buf
[ 
EEP_PAGE_SIZE
 + 2 ];

502 
U16
 
i
;

503 
U16
 
addr
;

505 
	`mem£t
–&
buf
[ 2 ], 0x00, 
EEP_PAGE_SIZE
 );

507  
i
 = 0; i < 
EEP_PAGE_NUM
; i++ )

509 
addr
 = (
i
 * 
EEP_PAGE_SIZE
);

510 
buf
[ 0 ] = 
	`GET_HIGH_BYTE
–
addr
 );

511 
buf
[ 1 ] = 
	`GET_LOW_BYTE
–
addr
 );

513 
	`HAL_RTC_SëWrôeProc
–
EEP_PROC_START
 );

516 if–
	`i2ˇ0_ma°î_£nd
–
DEV_ADDR_EEP
 | 
EEP_OP_WR
 , &
buf
[ 1 ] , 
EEP_PAGE_SIZE
 + 1 , 200 ) !
MD_OK
 )

518 
	`Cou¡WrôeEº‹
();

519 
	`i2ˇ0_St›C⁄dôi⁄
();

520  
FALSE
;

523 if–!
	`HAL_RTC_WrôeProcCom∂ëe
() )

525 
	`Cou¡WrôeEº‹
();

526 
	`i2ˇ0_St›C⁄dôi⁄
();

527  
FALSE
;

530 
	`i2ˇ0_St›C⁄dôi⁄
();

531 
	`Dñay_MS
–
DEFAULT_DELAY
 );

534 
	`i2ˇ0_St›C⁄dôi⁄
();

535 
	`Dñay_MS
–
DEFAULT_DELAY
 );

536 
πc
.
WrôeOk
++;

537  
TRUE
;

538 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_eeprom.h

3 #i‚de‡
__HAL_EEPROM_H__


4 
	#__HAL_EEPROM_H__


	)

7 
	~"¥j_ty≥.h
"

10 
	#DEV_ADDR_EEP
 0xA0

	)

12 
	#EEP_MAX_SIZE
 256

	)

13 
	#EEP_PAGE_SIZE
 8

	)

14 
	#EEP_PAGE_NUM
 32

	)

17 
	#EEP_PROC_START
 0

	)

18 
	#EEP_PROC_DONE
 1

	)

22 
HAL_RTC_Inô
();

29 
HAL_RTC_SëWrôeProc
–
U8
 
_¥oc
 );

36 
U8
 
HAL_RTC_GëWrôeProc
( );

43 
HAL_RTC_SëRódProc
–
U8
 
_¥oc
 );

50 
U8
 
HAL_RTC_GëRódProc
( );

57 
BOOL_T
 
HAL_RTC_ByãWrôe
–
U8
 
_dev
, 
U16
 
_addr
 , U8 
_d©a
 );

64 
BOOL_T
 
HAL_RTC_PageWrôe
–
U8
 
_dev
, 
U16
 
_addr
 , U8 *
_d©a
, U8 
_Àn
 );

71 
BOOL_T
 
HAL_RTC_CuºítAddrRód
–
U8
 
_dev
, U8 *
_d©a
 );

78 
BOOL_T
 
HAL_RTC_ByãRód
–
U8
 
_dev
, 
U16
 
_addr
 , U8 *
_d©a
 );

85 
BOOL_T
 
HAL_RTC_SeqRód
–
U8
 
_dev
, 
U16
 
_addr
 , U8 * 
_d©a
, U8 
_Àn
 );

92 
BOOL_T
 
HAL_RTC_EEPROM_AŒEø£
( );

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_i2c.c

3 #¥agm®
öãºu±
 
INTIICA0
 
r_i2ˇ0_öãºu±


6 
	#TEST_EEP_NO_STOP
 1

	)

8 
	~"hÆ_i2c.h
"

9 
	~"r_cg_£rül.h
"

11 
	~"gp2≠_i2c.h
"

18 vﬁ©ûê
uöt8_t
 
	gi2ˇ0_m°©us
 = 0;

19 vﬁ©ûê
uöt8_t
 *
	gi2ˇ0_rx_pbuf
 = 0;

20 vﬁ©ûê
uöt16_t
 
	gi2ˇ0_rx_Àn
 = 0;

21 vﬁ©ûê
uöt16_t
 
	gi2ˇ0_rx_˙t
 = 0;

23 vﬁ©ûê
uöt8_t
 *
	gi2ˇ0_tx_pbuf
 = 0;

24 vﬁ©ûê
uöt16_t
 
	gi2ˇ0_tx_˙t
 = 0;

27 vﬁ©ûê
uöt8_t
 
	gi2ˇ1_m°©us
 = 0;

28 vﬁ©ûê
uöt8_t
 *
	gi2ˇ1_rx_pbuf
 = 0;

29 vﬁ©ûê
uöt16_t
 
	gi2ˇ1_rx_Àn
 = 0;

30 vﬁ©ûê
uöt16_t
 
	gi2ˇ1_rx_˙t
 = 0;

32 vﬁ©ûê
uöt8_t
 *
	gi2ˇ1_tx_pbuf
 = 0;

33 vﬁ©ûê
uöt16_t
 
	gi2ˇ1_tx_˙t
 = 0;

42 
MD_STATUS
 
	$i2ˇ0_ma°î_£nd
–
uöt8_t
 
_addr
, uöt8_à* 
_tx_buf
, 
uöt16_t
 
_tx_num
, uöt8_à
_waô
 )

44 
MD_STATUS
 
°©us
 = 
MD_OK
;

46 
IICAMK0
 = 1U;

49 if–1U =
IICBSY0
 )

51 
IICAMK0
 = 0U;

52 
°©us
 = 
MD_ERROR1
;

55 if––1U =
SPT0
 ) || ( 1U =
STT0
 ) )

57 
IICAMK0
 = 0U;

58 
°©us
 = 
MD_ERROR2
;

62 
STT0
 = 1U;

63 
IICAMK0
 = 0U;

66  
_waô
-- )

71 if–0U =
STD0
 )

73 
°©us
 = 
MD_ERROR3
;

77 
i2ˇ0_tx_˙t
 = 
_tx_num
;

78 
i2ˇ0_tx_pbuf
 = 
_tx_buf
;

79 
i2ˇ0_m°©us
 = 
_00_IICA_MASTER_FLAG_CLEAR
;

80 
_addr
 &(
uöt8_t
)~0x01U;

81 
IICA0
 = 
_addr
;

84  ( 
°©us
 );

85 
	}
}

92 
MD_STATUS
 
	$i2ˇ0_ma°î_ªcv
–
uöt8_t
 
_addr
, uöt8_à* 
_rx_buf
, 
uöt16_t
 
_rx_num
, uöt8_à
_waô
 )

94 
MD_STATUS
 
°©us
 = 
MD_OK
;

97 #i‡!
TEST_EEP_NO_STOP


98 
IICAMK0
 = 1U;

101 if–1U =
IICBSY0
 )

103 
IICAMK0
 = 0U;

104 
°©us
 = 
MD_ERROR1
;

107 if––1U =
SPT0
 ) || ( 1U =
STT0
 ) )

109 
IICAMK0
 = 0U;

110 
°©us
 = 
MD_ERROR2
;

115 
STT0
 = 1U;

116 
IICAMK0
 = 0U;

119  
_waô
-- )

124 if–0U =
STD0
 )

126 
°©us
 = 
MD_ERROR3
;

130 
i2ˇ0_rx_˙t
 = 0U;

131 
i2ˇ0_rx_Àn
 = 
_rx_num
;

132 
i2ˇ0_rx_pbuf
 = 
_rx_buf
;

133 
i2ˇ0_m°©us
 = 
_00_IICA_MASTER_FLAG_CLEAR
;

134 
_addr
 |= 0x01U;

135 
IICA0
 = 
_addr
;

138  ( 
°©us
 );

139 
	}
}

142 
i2ˇ0_ˇŒback_ma°î_îr‹
(
MD_STATUS
 
Êag
);

143 
i2ˇ0_ˇŒback_ma°î_ª˚ivìnd
();

144 
i2ˇ0_ˇŒback_ma°î_£ndíd
();

151 
	$i2ˇ0_ma°î_h™dÀr
( )

154 if––0U =
IICBSY0
 ) && ( 
i2ˇ0_tx_˙t
 != 0U ) )

156 
	`i2ˇ0_ˇŒback_ma°î_îr‹
–
MD_SPT
 );

161 if––
i2ˇ0_m°©us
 & 
_80_IICA_ADDRESS_COMPLETE
 ) == 0U )

163 if–1U =
ACKD0
 )

165 
i2ˇ0_m°©us
 |
_80_IICA_ADDRESS_COMPLETE
;

167 if–1U =
TRC0
 )

169 
WTIM0
 = 1U;

171 if–
i2ˇ0_tx_˙t
 > 0U )

173 
IICA0
 = *
i2ˇ0_tx_pbuf
;

174 
i2ˇ0_tx_pbuf
++;

175 
i2ˇ0_tx_˙t
--;

179 
	`i2ˇ0_ˇŒback_ma°î_£ndíd
();

184 
ACKE0
 = 1U;

185 
WTIM0
 = 0U;

186 
WREL0
 = 1U;

191 
	`i2ˇ0_ˇŒback_ma°î_îr‹
–
MD_NACK
 );

197 if–1U =
TRC0
 )

199 if––0U =
ACKD0
 ) && ( 
i2ˇ0_tx_˙t
 != 0U ) )

201 
	`i2ˇ0_ˇŒback_ma°î_îr‹
–
MD_NACK
 );

206 if–
i2ˇ0_tx_˙t
 > 0U )

208 
IICA0
 = *
i2ˇ0_tx_pbuf
;

209 
i2ˇ0_tx_pbuf
++;

210 
i2ˇ0_tx_˙t
--;

214 
	`i2ˇ0_ˇŒback_ma°î_£ndíd
();

221 if–
i2ˇ0_rx_˙t
 < 
i2ˇ0_rx_Àn
 )

223 *
i2ˇ0_rx_pbuf
 = 
IICA0
;

224 
i2ˇ0_rx_pbuf
++;

225 
i2ˇ0_rx_˙t
++;

227 if–
i2ˇ0_rx_˙t
 =
i2ˇ0_rx_Àn
 )

229 
ACKE0
 = 0U;

230 
WREL0
 = 1U;

231 
WTIM0
 = 1U;

235 
WREL0
 = 1U;

240 
	`i2ˇ0_ˇŒback_ma°î_ª˚ivìnd
();

245 
	}
}

252 
	$i2ˇ0_ˇŒback_ma°î_îr‹
–
MD_STATUS
 
Êag
 )

257 
	}
}

264 
	$i2ˇ0_ˇŒback_ma°î_ª˚ivìnd
( )

266 #i‡!
TEST_EEP_NO_STOP


267 
SPT0
 = 1U;

270 
	`HAL_TOF_SëRódProc
–
TOF_PROC_DONE
 );

271 
	}
}

278 
	$i2ˇ0_ˇŒback_ma°î_£ndíd
( )

280 #i‡!
TEST_EEP_NO_STOP


281 
SPT0
 = 1U;

284 
	`HAL_TOF_SëWrôeProc
–
TOF_PROC_DONE
 );

285 
	}
}

287 
__öãºu±
 
	$r_i2ˇ0_öãºu±
()

289 i‡((
IICS0
 & 
_80_IICA_STATUS_MASTER
) == 0x80U)

291 
	`i2ˇ0_ma°î_h™dÀr
();

293 
	}
}

303 
MD_STATUS
 
	$i2ˇ1_ma°î_£nd
–
uöt8_t
 
_addr
, uöt8_à* 
_tx_buf
, 
uöt16_t
 
_tx_num
, uöt8_à
_waô
 )

305 
MD_STATUS
 
°©us
 = 
MD_OK
;

308 
IICAMK1
 = 1U;

311 if–1U =
IICBSY1
 )

313 
IICAMK1
 = 0U;

314 
°©us
 = 
MD_ERROR1
;

317 if––1U =
SPT1
 ) || ( 1U =
STT1
 ) )

319 
IICAMK1
 = 0U;

320 
°©us
 = 
MD_ERROR2
;

324 
STT1
 = 1U;

325 
IICAMK1
 = 0U;

328  
_waô
-- )

333 if–0U =
STD1
 )

335 
°©us
 = 
MD_ERROR3
;

339 
i2ˇ1_tx_˙t
 = 
_tx_num
;

340 
i2ˇ1_tx_pbuf
 = 
_tx_buf
;

341 
i2ˇ1_m°©us
 = 
_00_IICA_MASTER_FLAG_CLEAR
;

342 
_addr
 &(
uöt8_t
)~0x01U;

343 
IICA1
 = 
_addr
;

346  ( 
°©us
 );

347 
	}
}

354 
MD_STATUS
 
	$i2ˇ1_ma°î_ªcv
–
uöt8_t
 
_addr
, uöt8_à* 
_rx_buf
, 
uöt16_t
 
_rx_num
, uöt8_à
_waô
 )

356 
MD_STATUS
 
°©us
 = 
MD_OK
;

358 
IICAMK1
 = 1U;

361 if–1U =
IICBSY1
 )

363 
IICAMK1
 = 0U;

364 
°©us
 = 
MD_ERROR1
;

367 if––1U =
SPT1
 ) || ( 1U =
STT1
 ) )

369 
IICAMK1
 = 0U;

370 
°©us
 = 
MD_ERROR2
;

374 
STT1
 = 1U;

375 
IICAMK1
 = 0U;

378  
_waô
-- )

383 if–0U =
STD1
 )

385 
°©us
 = 
MD_ERROR3
;

389 
i2ˇ1_rx_˙t
 = 0U;

390 
i2ˇ1_rx_Àn
 = 
_rx_num
;

391 
i2ˇ1_rx_pbuf
 = 
_rx_buf
;

392 
i2ˇ1_m°©us
 = 
_00_IICA_MASTER_FLAG_CLEAR
;

393 
_addr
 |= 0x01U;

394 
IICA1
 = 
_addr
;

397  ( 
°©us
 );

398 
	}
}

401 
i2ˇ1_ˇŒback_ma°î_îr‹
(
MD_STATUS
 
Êag
);

402 
i2ˇ1_ˇŒback_ma°î_ª˚ivìnd
();

403 
i2ˇ1_ˇŒback_ma°î_£ndíd
();

410 
	$i2ˇ1_ma°î_h™dÀr
( )

413 if––0U =
IICBSY1
 ) && ( 
i2ˇ1_tx_˙t
 != 0U ) )

415 
	`i2ˇ1_ˇŒback_ma°î_îr‹
–
MD_SPT
 );

420 if––
i2ˇ1_m°©us
 & 
_80_IICA_ADDRESS_COMPLETE
 ) == 0U )

422 if–1U =
ACKD1
 )

424 
i2ˇ1_m°©us
 |
_80_IICA_ADDRESS_COMPLETE
;

426 if–1U =
TRC1
 )

428 
WTIM1
 = 1U;

430 if–
i2ˇ1_tx_˙t
 > 0U )

432 
IICA1
 = *
i2ˇ1_tx_pbuf
;

433 
i2ˇ1_tx_pbuf
++;

434 
i2ˇ1_tx_˙t
--;

438 
	`i2ˇ1_ˇŒback_ma°î_£ndíd
();

443 
ACKE1
 = 1U;

444 
WTIM1
 = 0U;

445 
WREL1
 = 1U;

450 
	`i2ˇ1_ˇŒback_ma°î_îr‹
–
MD_NACK
 );

456 if–1U =
TRC1
 )

458 if––0U =
ACKD1
 ) && ( 
i2ˇ1_tx_˙t
 != 0U ) )

460 
	`i2ˇ1_ˇŒback_ma°î_îr‹
–
MD_NACK
 );

464 if–
i2ˇ1_tx_˙t
 > 0U )

466 
IICA1
 = *
i2ˇ1_tx_pbuf
;

467 
i2ˇ1_tx_pbuf
++;

468 
i2ˇ1_tx_˙t
--;

472 
	`i2ˇ1_ˇŒback_ma°î_£ndíd
();

479 if–
i2ˇ1_rx_˙t
 < 
i2ˇ1_rx_Àn
 )

481 *
i2ˇ1_rx_pbuf
 = 
IICA1
;

482 
i2ˇ1_rx_pbuf
++;

483 
i2ˇ1_rx_˙t
++;

485 if–
i2ˇ1_rx_˙t
 =
i2ˇ1_rx_Àn
 )

487 
ACKE1
 = 0U;

488 
WREL1
 = 1U;

489 
WTIM1
 = 1U;

493 
WREL1
 = 1U;

498 
	`i2ˇ1_ˇŒback_ma°î_ª˚ivìnd
();

503 
	}
}

510 
	$i2ˇ1_ˇŒback_ma°î_îr‹
–
MD_STATUS
 
Êag
 )

515 
	}
}

522 
	$i2ˇ1_ˇŒback_ma°î_ª˚ivìnd
( )

524 
SPT1
 = 1U;

528 
	}
}

535 
	$i2ˇ1_ˇŒback_ma°î_£ndíd
( )

537 
SPT1
 = 1U;

541 
	}
}

543 
__öãºu±
 
	$r_i2ˇ1_öãºu±
()

545 i‡((
IICS1
 & 
_80_IICA_STATUS_MASTER
) == 0x80U)

547 
	`i2ˇ1_ma°î_h™dÀr
();

549 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_i2c.h

2 #i‚de‡
__HAL_I2C_H__


3 
	#__HAL_I2C_H__


	)

6 
	~"r_cg_ma¸odrivî.h
"

7 
	~"¥j_ty≥.h
"

20 
MD_STATUS
 
i2ˇ0_ma°î_£nd
–
uöt8_t
 
_addr
, uöt8_à* 
_tx_buf
, 
uöt16_t
 
_tx_num
, uöt8_à
_waô
 );

27 
MD_STATUS
 
i2ˇ0_ma°î_ªcv
–
uöt8_t
 
_addr
, uöt8_à* 
_rx_buf
, 
uöt16_t
 
_rx_num
, uöt8_à
_waô
 );

35 
MD_STATUS
 
i2ˇ1_ma°î_£nd
–
uöt8_t
 
_addr
, uöt8_à* 
_tx_buf
, 
uöt16_t
 
_tx_num
, uöt8_à
_waô
 );

42 
MD_STATUS
 
i2ˇ1_ma°î_ªcv
–
uöt8_t
 
_addr
, uöt8_à* 
_rx_buf
, 
uöt16_t
 
_rx_num
, uöt8_à
_waô
 );

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_serial.c

1 
	#CONFIG_UART_0
 0

	)

2 
	#CONFIG_UART_1
 1

	)

3 
	#CONFIG_UART_2
 0

	)

4 
	#CONFIG_UART_3
 0

	)

7 #i‡
CONFIG_UART_0


8 #¥agm®
öãºu±
 
INTST0
 
r_u¨t0_öãºu±_£nd


9 #¥agm®
öãºu±
 
INTSR0
 
r_u¨t0_öãºu±_ª˚ive


13 #i‡
CONFIG_UART_1


14 #¥agm®
öãºu±
 
INTST1
 
r_u¨t1_öãºu±_£nd


15 #¥agm®
öãºu±
 
INTSR1
 
r_u¨t1_öãºu±_ª˚ive


19 #i‡
CONFIG_UART_2


20 #¥agm®
öãºu±
 
INTST2
 
r_u¨t2_öãºu±_£nd


21 #¥agm®
öãºu±
 
INTSR2
 
r_u¨t2_öãºu±_ª˚ive


25 #i‡
CONFIG_UART_3


26 #¥agm®
öãºu±
 
INTST3
 
r_u¨t3_öãºu±_£nd


27 #¥agm®
öãºu±
 
INTSR3
 
r_u¨t3_öãºu±_ª˚ive


31 
	~"hw.h
"

32 
	~"hÆ_£rül.h
"

33 
	~<°rög.h
>

34 
	~"timî.h
"

58 
	#UART0_RX_TIME_STAMP
 100

	)

59 
	#UART1_RX_TIME_STAMP
 10

	)

60 
	#UART2_RX_TIME_STAMP
 10

	)

61 
	#UART3_RX_TIME_STAMP
 10

	)

64 #i‡
CONFIG_UART_0


65 
U8
 
	gªcv_0_buf
[ 
MAX_COMM_0_RX_BUF_SZ
 ];

66 
U8
 
	g£nd_0_buf
[ 
MAX_COMM_0_TX_BUF_SZ
 ];

68 
U8
 
	gªcv_0_buf
[ 1 ];

69 
U8
 
	g£nd_0_buf
[ 1 ];

72 #i‡
CONFIG_UART_1


73 
U8
 
	gªcv_1_buf
[ 
MAX_COMM_1_RX_BUF_SZ
 ];

74 
U8
 
	g£nd_1_buf
[ 
MAX_COMM_1_TX_BUF_SZ
 ];

76 
U8
 
	gªcv_1_buf
[ 1 ];

77 
U8
 
	g£nd_1_buf
[ 1 ];

80 #i‡
CONFIG_UART_2


81 
U8
 
	gªcv_2_buf
[ 
MAX_COMM_2_RX_BUF_SZ
 ];

82 
U8
 
	g£nd_2_buf
[ 
MAX_COMM_2_TX_BUF_SZ
 ];

84 
U8
 
	gªcv_2_buf
[ 1 ];

85 
U8
 
	g£nd_2_buf
[ 1 ];

88 #i‡
CONFIG_UART_3


89 
U8
 
	gªcv_3_buf
[ 
MAX_COMM_3_RX_BUF_SZ
 ];

90 
U8
 
	g£nd_3_buf
[ 
MAX_COMM_3_TX_BUF_SZ
 ];

92 
U8
 
	gªcv_3_buf
[ 1 ];

93 
U8
 
	g£nd_3_buf
[ 1 ];

96 
	s_comm_


98 
I16
 
	mªcv_Àn
;

99 
I16
 
	m£nd_Àn
;

100 
I16
 
	mtx_Àn
;

101 } 
	tcomm_t
;

102 
comm_t
 
	gcomm
[ 
MAX_COMM_ID
 ];

105 
	$HAL_InôCommId
–
U8
 
u¨t_id
 )

107 if–
u¨t_id
 =
COMM_ID_UART_0
 )

109 #i‡
CONFIG_UART_0


110 
	`MEMSET
–(
__FAR
 *)&
ªcv_0_buf
[0], 0, 
MAX_COMM_0_RX_BUF_SZ
 );

111 
	`MEMSET
–(
__FAR
 *)&
£nd_0_buf
[0], 0, 
MAX_COMM_0_TX_BUF_SZ
 );

114 if–
u¨t_id
 =
COMM_ID_UART_1
 )

116 #i‡
CONFIG_UART_1


117 
	`MEMSET
–(
__FAR
 *)&
ªcv_1_buf
[0], 0, 
MAX_COMM_1_RX_BUF_SZ
 );

118 
	`MEMSET
–(
__FAR
 *)&
£nd_1_buf
[0], 0, 
MAX_COMM_1_TX_BUF_SZ
 );

121 if–
u¨t_id
 =
COMM_ID_UART_2
)

123 #i‡
CONFIG_UART_2


124 
	`MEMSET
–(
__FAR
 *)&
ªcv_2_buf
[0], 0, 
MAX_COMM_2_RX_BUF_SZ
 );

125 
	`MEMSET
–(
__FAR
 *)&
£nd_2_buf
[0], 0, 
MAX_COMM_2_TX_BUF_SZ
 );

130 #i‡
CONFIG_UART_3


131 
	`MEMSET
–(
__FAR
 *)&
ªcv_3_buf
[0], 0, 
MAX_COMM_3_RX_BUF_SZ
 );

132 
	`MEMSET
–(
__FAR
 *)&
£nd_3_buf
[0], 0, 
MAX_COMM_3_TX_BUF_SZ
 );

136 
	`MEMSET
–(
__FAR
 *)&
comm
[ 
u¨t_id
 ], 0, –
comm_t
 ) );

137 
	}
}

139 
	$HAL_InôComm
( )

141 #i‡
CONFIG_UART_0


142 
	`HAL_InôCommId
–
COMM_ID_UART_0
 );

143 
	`R_UART0_Sèπ
();

146 #i‡
CONFIG_UART_1


147 
	`HAL_InôCommId
–
COMM_ID_UART_1
 );

148 
	`R_UART1_Sèπ
();

151 #i‡
CONFIG_UART_2


152 
	`HAL_InôCommId
–
COMM_ID_UART_2
 );

153 
	`R_UART2_Sèπ
();

156 #i‡
CONFIG_UART_3


157 
	`HAL_InôCommId
–
COMM_ID_UART_3
 );

158 
	`R_UART3_Sèπ
();

161 
	}
}

163 
I16
 
	$HAL_GëMaxRecvBuf„rLígth
(
U8
 
u¨t_id
)

165 if–
u¨t_id
 == 0 )

167  
MAX_COMM_0_RX_BUF_SZ
;

169 if–
u¨t_id
 == 1 )

171  
MAX_COMM_1_RX_BUF_SZ
;

173 if–
u¨t_id
 == 2 )

175  
MAX_COMM_2_RX_BUF_SZ
;

178  
MAX_COMM_3_RX_BUF_SZ
;

179 
	}
}

181 
U8
 
	$HAL_IsFuŒRecvBuf„r
–
U8
 
u¨t_id
 )

183 if–
comm
[ 
u¨t_id
 ].
ªcv_Àn
 >
	`HAL_GëMaxRecvBuf„rLígth
( uart_id ) )

185  
TRUE
;

188  
FALSE
;

189 
	}
}

191 
U8
 
	$HAL_IsEm±yRecvBuf„r
–
U8
 
u¨t_id
 )

193 if–
comm
[ 
u¨t_id
 ].
ªcv_Àn
 > 0 )

195  
FALSE
;

198  
TRUE
;

200 
	}
}

202 
I16
 
	$HAL_GëMaxSídBuf„rLígth
(
U8
 
u¨t_id
)

204 if–
u¨t_id
 == 0 )

206  
MAX_COMM_0_TX_BUF_SZ
;

208 if–
u¨t_id
 == 1 )

210  
MAX_COMM_1_TX_BUF_SZ
;

212 if–
u¨t_id
 == 2 )

214  
MAX_COMM_2_TX_BUF_SZ
;

217  
MAX_COMM_3_TX_BUF_SZ
;

218 
	}
}

220 
U8
 
	$HAL_IsFuŒSídBuf„r
–
U8
 
u¨t_id
 )

222 if–
comm
[ 
u¨t_id
 ].
£nd_Àn
 >
	`HAL_GëMaxSídBuf„rLígth
( uart_id ) )

224  
TRUE
;

227  
FALSE
;

228 
	}
}

230 
	$HAL_InôRecvLígth
(
U8
 
u¨t_id
 )

232 
comm
[ 
u¨t_id
 ].
ªcv_Àn
 = 0;

233 
	}
}

235 
I16
 
	$HAL_GëRecvLígth
–
U8
 
u¨t_id
 )

237  
comm
[ 
u¨t_id
 ].
ªcv_Àn
;

238 
	}
}

240 
I16
 
	$HAL_GëSídLígth
–
U8
 
u¨t_id
 )

242  
comm
[ 
u¨t_id
].
£nd_Àn
;

243 
	}
}

246 
	$HAL_SëRecvBuf„r
(
U8
 
u¨t_id
, U8 
_byã
 )

248 
comm_t
 *
p_comm
;

250 
p_comm
 = &
comm
[ 
u¨t_id
 ];

251 if–
u¨t_id
 =
COMM_ID_UART_0
 )

253 
ªcv_0_buf
[ 
p_comm
->
ªcv_Àn
 ] = 
_byã
;

255 if–
u¨t_id
 =
COMM_ID_UART_1
 )

257 
ªcv_1_buf
[ 
p_comm
->
ªcv_Àn
 ] = 
_byã
;

259 if–
u¨t_id
 =
COMM_ID_UART_2
)

261 
ªcv_2_buf
[ 
p_comm
->
ªcv_Àn
 ] = 
_byã
;

265 
ªcv_3_buf
[ 
p_comm
->
ªcv_Àn
 ] = 
_byã
;

267 
p_comm
->
ªcv_Àn
++;

269 
	}
}

271 
U8
 
	$HAL_GëRecvBuf„r
–
U8
 
u¨t_id
, 
U16
 
ödex
 )

273 if–
u¨t_id
 =
COMM_ID_UART_0
 )

275  
ªcv_0_buf
[ 
ödex
 ];

277 if–
u¨t_id
 =
COMM_ID_UART_1
 )

279  
ªcv_1_buf
[ 
ödex
 ];

281 if–
u¨t_id
 =
COMM_ID_UART_2
)

283  
ªcv_2_buf
[ 
ödex
 ];

287  
ªcv_3_buf
[ 
ödex
 ];

289 
	}
}

292 
	$HAL_SëSídBuf„r
–
U8
 
u¨t_id
, U8 
_byã
 )

294 
comm_t
 *
p_comm
;

296 if–
	`HAL_IsFuŒSídBuf„r
–
u¨t_id
 ) =
FALSE
 )

298 
p_comm
 = &
comm
[ 
u¨t_id
 ];

299 if–
u¨t_id
 =
COMM_ID_UART_0
 )

301 
£nd_0_buf
[ 
p_comm
->
£nd_Àn
 ] = 
_byã
;

303 if–
u¨t_id
 =
COMM_ID_UART_1
 )

305 
£nd_1_buf
[ 
p_comm
->
£nd_Àn
 ] = 
_byã
;

307 if–
u¨t_id
 =
COMM_ID_UART_2
)

309 
£nd_2_buf
[ 
p_comm
->
£nd_Àn
 ] = 
_byã
;

313 
£nd_3_buf
[ 
p_comm
->
£nd_Àn
 ] = 
_byã
;

315 
p_comm
->
£nd_Àn
++;

317 
	}
}

319 
U8
 
	$HAL_GëSídBuf„r
–
U8
 
u¨t_id
, 
U16
 
ödex
 )

321 if–
u¨t_id
 =
COMM_ID_UART_0
 )

323  
£nd_0_buf
[
ödex
];

325 if–
u¨t_id
 =
COMM_ID_UART_1
 )

327  
£nd_1_buf
[
ödex
];

329 if–
u¨t_id
 =
COMM_ID_UART_2
)

331  
£nd_2_buf
[
ödex
];

335  
£nd_3_buf
[
ödex
];

337 
	}
}

340 
	$HAL_SídByã
–
U8
 
u¨t_id
 )

342 
U8
 
ch
;

343 
comm_t
 *
p_comm
;

346 
p_comm
 = &
comm
[ 
u¨t_id
 ];

347 if–
u¨t_id
 =
COMM_ID_UART_0
 )

349 
ch
 = 
£nd_0_buf
[
p_comm
->
tx_Àn
];

351 if–
u¨t_id
 =
COMM_ID_UART_1
 )

353 
ch
 = 
£nd_1_buf
[
p_comm
->
tx_Àn
];

355 if–
u¨t_id
 =
COMM_ID_UART_2
)

357 
ch
 = 
£nd_2_buf
[
p_comm
->
tx_Àn
];

361 
ch
 = 
£nd_3_buf
[
p_comm
->
tx_Àn
];

364 
p_comm
->
tx_Àn
++;

366 if–
u¨t_id
 =
COMM_ID_UART_0
 )

368 #i‡
CONFIG_UART_0


369 
TXD0
 = 
ch
;

372 if–
u¨t_id
 =
COMM_ID_UART_1
 )

374 #i‡
CONFIG_UART_1


375 
TXD1
 = 
ch
;

378 if–
u¨t_id
 =
COMM_ID_UART_2
 )

380 #i‡
CONFIG_UART_2


381 
TXD2
 = 
ch
;

384 if–
u¨t_id
 =
COMM_ID_UART_3
 )

386 #i‡
CONFIG_UART_3


387 
TXD3
 = 
ch
;

390 
	}
}

392 
U8
 
	$IsCom∂ëeTx
–
U8
 
u¨t_id
 )

394 if–
comm
[
u¨t_id
].
tx_Àn
 < comm[ u¨t_id ].
£nd_Àn
 )

396  
FALSE
;

399  
TRUE
;

401 
	}
}

406 #i‡
CONFIG_UART_0


407 
__öãºu±
 
	$r_u¨t0_öãºu±_ª˚ive
()

409 vﬁ©ûê
U8
 
îr_ty≥
;

410 vﬁ©ûê
U8
 
rx_d©a
;

413 
îr_ty≥
 = (
uöt8_t
)(
SSR01
 & 0x0007U);

414 
SIR01
 = (
uöt16_t
)
îr_ty≥
;

416 
rx_d©a
 = 
RXD0
;

418 if–
îr_ty≥
 == 0 )

420 if–
	`HAL_IsFuŒRecvBuf„r
–
COMM_ID_UART_0
 ) =
FALSE
 )

422 
	`HAL_SëRecvBuf„r
–
COMM_ID_UART_0
, 
rx_d©a
 );

426 
	`HAL_InôCommId
–
COMM_ID_UART_0
 );

429 
	`SèπTimî
–
TIMER_ID_COMM_COMP_RX
, 
UART0_RX_TIME_STAMP
 );

431 
	}
}

433 
__öãºu±
 
	$r_u¨t0_öãºu±_£nd
()

435 if–
	`IsCom∂ëeTx
–
COMM_ID_UART_0
 ) =
FALSE
 )

437 
	`HAL_SídByã
–
COMM_ID_UART_0
 );

441 
	`HAL_InôCommId
–
COMM_ID_UART_0
 );

443 
	}
}

447 #i‡
CONFIG_UART_1


448 
__öãºu±
 
	$r_u¨t1_öãºu±_ª˚ive
()

451 vﬁ©ûê
U8
 
rx_d©a
;

452 vﬁ©ûê
U8
 
îr_ty≥
;

454 
îr_ty≥
 = (
U8
)(
SSR03
 & 0x0007U);

455 
SIR03
 = (
U16
)
îr_ty≥
;

457 
rx_d©a
 = 
RXD1
;

459 if–
îr_ty≥
 == 0 )

461 if–
	`HAL_IsFuŒRecvBuf„r
–
COMM_ID_UART_1
 ) =
FALSE
 )

463 
	`HAL_SëRecvBuf„r
–
COMM_ID_UART_1
, 
rx_d©a
 );

467 
	`HAL_InôCommId
–
COMM_ID_UART_1
 );

471 
	`SèπTimî
–
TIMER_ID_COMM_UART_1_RX
, 
UART1_RX_TIME_STAMP
 );

473 
	}
}

475 
__öãºu±
 
	$r_u¨t1_öãºu±_£nd
()

478 if–
	`IsCom∂ëeTx
–
COMM_ID_UART_1
 ) =
FALSE
 )

480 
	`HAL_SídByã
–
COMM_ID_UART_1
 );

484 
	`HAL_InôCommId
–
COMM_ID_UART_1
 );

487 
	}
}

491 #i‡
CONFIG_UART_2


492 
U16
 
	gthe_rx_îr_cou¡
 = 0;

493 
__öãºu±
 
	$r_u¨t2_öãºu±_ª˚ive
()

495 vﬁ©ûê
U8
 
îr_ty≥
;

496 vﬁ©ûê
U8
 
rx_d©a
;

498 
îr_ty≥
 = (
uöt8_t
)(
SSR11
 & 0x0007U);

499 
SIR11
 = (
uöt16_t
)
îr_ty≥
;

501 
rx_d©a
 = 
RXD2
;

503 
	`EI
();

504 if–
îr_ty≥
 == 0 )

506 if–
	`HAL_IsFuŒRecvBuf„r
–
COMM_ID_UART_2
 ) =
FALSE
 )

508 
	`HAL_SëRecvBuf„r
–
COMM_ID_UART_2
, 
rx_d©a
 );

512 
	`HAL_InôCommId
–
COMM_ID_UART_2
 );

515 
	`SèπTimî
–
TIMER_ID_COMM_FRONT_RX
, 
UART2_RX_TIME_STAMP
 );

519 
the_rx_îr_cou¡
++;

521 
	}
}

523 
__öãºu±
 
	$r_u¨t2_öãºu±_£nd
()

525 
	`EI
();

526 if–
	`IsCom∂ëeTx
–
COMM_ID_UART_2
 ) =
FALSE
 )

528 
	`HAL_SídByã
–
COMM_ID_UART_2
 );

532 
	`HAL_InôCommId
–
COMM_ID_UART_2
 );

534 
	}
}

539 #i‡
CONFIG_UART_3


540 
U16
 
	gthe_i§_îr_cou¡
 = 0;

541 
__öãºu±
 
	$r_u¨t3_öãºu±_ª˚ive
()

543 vﬁ©ûê
U8
 
îr_ty≥
;

544 vﬁ©ûê
U8
 
rx_d©a
;

546 
îr_ty≥
 = (
uöt8_t
)(
SSR13
 & 0x0007U);

547 
SIR13
 = (
uöt16_t
)
îr_ty≥
;

549 
rx_d©a
 = 
RXD3
;

551 if–
îr_ty≥
 == 0 )

553 if–
	`HAL_IsFuŒRecvBuf„r
–
COMM_ID_UART_3
 ) =
FALSE
 )

555 
	`HAL_SëRecvBuf„r
–
COMM_ID_UART_3
, 
rx_d©a
 );

559 
	`HAL_InôCommId
–
COMM_ID_UART_3
 );

562 
	`SèπTimî
–
TIMER_ID_COMM_EOL_RX
, 
UART3_RX_TIME_STAMP
 );

566 
the_i§_îr_cou¡
++;

568 
	}
}

571 
__öãºu±
 
	$r_u¨t3_öãºu±_£nd
()

573 if–
	`IsCom∂ëeTx
–
COMM_ID_UART_3
 ) =
FALSE
 )

575 
	`HAL_SídByã
–
COMM_ID_UART_3
 );

579 
	`HAL_InôCommId
–
COMM_ID_UART_3
 );

581 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_serial.h

1 #i‚de‡
__HAL_SERIAL_H__


2 
	#__HAL_SERIAL_H__


	)

4 
	~"¥j_ty≥.h
"

7 
	#COMM_ID_UART_0
 0

	)

8 
	#COMM_ID_UART_1
 1

	)

9 
	#COMM_ID_UART_2
 2

	)

10 
	#COMM_ID_UART_3
 3

	)

11 
	#MAX_COMM_ID
 4

	)

14 
	#MAX_COMM_0_RX_BUF_SZ
 30

	)

15 
	#MAX_COMM_0_TX_BUF_SZ
 30

	)

17 
	#MAX_COMM_1_RX_BUF_SZ
 40

	)

18 
	#MAX_COMM_1_TX_BUF_SZ
 40

	)

20 
	#MAX_COMM_2_RX_BUF_SZ
 128

	)

21 
	#MAX_COMM_2_TX_BUF_SZ
 128

	)

23 
	#MAX_COMM_3_RX_BUF_SZ
 255

	)

24 
	#MAX_COMM_3_TX_BUF_SZ
 255

	)

26 
	#MAX_COMM_RX_BUF_SZ
 255

	)

27 
	#MAX_COMM_TX_BUF_SZ
 255

	)

31 
HAL_InôCommId
–
U8
 
u¨t_id
 );

32 
HAL_InôComm
( );

34 
U8
 
HAL_IsFuŒRecvBuf„r
–U8 
u¨t_id
 );

35 
U8
 
HAL_IsEm±yRecvBuf„r
–U8 
u¨t_id
 );

36 
U8
 
HAL_IsFuŒSídBuf„r
–U8 
u¨t_id
 );

38 
HAL_InôRecvLígth
(
U8
 
u¨t_id
 );

39 
I16
 
HAL_GëRecvLígth
–
U8
 
u¨t_id
 );

40 
I16
 
HAL_GëSídLígth
–
U8
 
u¨t_id
 );

42 
HAL_SëRecvBuf„r
(
U8
 
u¨t_id
, U8 
_byã
 );

43 
U8
 
HAL_GëRecvBuf„r
–U8 
u¨t_id
, 
U16
 
ödex
 );

45 
HAL_SëSídBuf„r
–
U8
 
u¨t_id
, U8 
_byã
 );

46 
U8
 
HAL_GëSídBuf„r
–U8 
u¨t_id
, 
U16
 
ödex
 );

48 
HAL_SídByã
–
U8
 
u¨t_id
 );

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hw.h

1 #i‚de‡
__HW__H__


2 
	#__HW__H__


	)

4 
	~"mcu.h
"

5 
	~"r_cg_cgc.h
"

6 
	~"r_cg_p‹t.h
"

7 
	~"r_cg_wdt.h
"

8 
	~"r_cg_timî.h
"

10 
	~"r_cg_£rül.h
"

11 
	~"r_cg_ötc.h
"

12 
	~"r_cg_ma¸odrivî.h
"

26 
	#RESET_WDT
(Ë
	`R_WDT_Re°¨t
()

	)

28 
	#TOF_GPIO_OUT_1
 
P7
.0

	)

29 
	#TURN_ON_TOF_1
(Ëdo{ 
TOF_GPIO_OUT_1
 = 1; }0)

	)

30 
	#TURN_OFF_TOF_1
(Ëdo{ 
TOF_GPIO_OUT_1
 = 0; }0)

	)

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\mcu.h

1 #i‚de‡
__MCU_H__


2 
	#__MCU_H__


	)

4 
	~"r_cg_ma¸odrivî.h
"

6 
	~"¥j_ty≥.h
"

8 
	~"c⁄fig.h
"

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\main.c

1 
	~"hw.h
"

2 
	~"mcu.h
"

4 
	~"hw.h
"

5 
	~"timî.h
"

6 
	~"utû.h
"

7 
	~"ì¥om.h
"

8 
	~"tof.h
"

9 
	~"∑r£r.h
"

10 
	~"¥o˚ss_sys_evít.h
"

13 
	$InôSèπTimîs
( )

15 
	`InôTimî
();

17 
	`SèπTimî
–
TIMER_ID_1MS
, 1);

18 
	`SèπTimî
–
TIMER_ID_10MS
, 10);

19 
	`SèπTimî
–
TIMER_ID_100MS
, 100);

20 
	`SèπTimî
–
TIMER_ID_TOF
, 
	`SEC
(5));

21 
	}
}

24 
	$maö
( )

26 
	`Dñay_MS
( 500 );

28 
	`R_WDT_Re°¨t
();

30 
	`InôSy°em
();

31 
	`InôSèπTimîs
();

32 
	`EI
();

35 
	`R_WDT_Re°¨t
();

39 
	`InôToF
();

43 
	`R_WDT_Re°¨t
();

45 
	`Pro˚ssEvítH™dÀr
();

48 
	`RecvPackëH™dÀr
();

49 
	`SídPackëH™dÀr
();

51 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\prj_type.h

1 #i‚de‡
__PRJ_TYPE_H__


2 
	#__PRJ_TYPE_H__


	)

4 
	~"c⁄fig.h
"

5 
	~<°dio.h
>

6 
	~<°rög.h
>

8 #i‚de‡
__TYPEDEF_COWAY__


9 
	#__TYPEDEF_COWAY__


	)

10 
	tU8
;

11 sig√d 
	tI8
;

12 
	tU16
;

13 sig√d 
	tI16
;

14 
	tU32
;

15 sig√d 
	tI32
;

16 
	tF32
;

17 
	tBOOL_T
;

18 
	tTIME_T
;

20 
	tTEMP_T
;

21 
	tRPS_T
;

24 
	tuöt8_t
;

25 sig√d 
	töt8_t
;

26 
	tuöt16_t
;

27 sig√d 
	töt16_t
;

28 
	tuöt32_t
;

29 sig√d 
	töt32_t
;

33 
	#__DEBUG__
 1

	)

35 #i‡
__DEBUG__


36 
	#LOCAL


	)

38 
	#LOCAL
 

	)

41 #ifde‡
NULL


42 #unde‡
NULL


45 
	#NULL
 ((*)0)

	)

47 #ifde‡
TRUE


48 #unde‡
TRUE


51 
	#TRUE
 1

	)

53 #ifde‡
FALSE


54 #unde‡
FALSE


57 
	#FALSE
 0

	)

60 #ifde‡
ON


61 #unde‡
ON


64 
	#ON
 1

	)

66 #ifde‡
OFF


67 #unde‡
OFF


70 
	#OFF
 0

	)

72 
	#HIGH
 1

	)

73 
	#LOW
 0

	)

77 #i‡(
CONFIG_FOTA_LIB
 == 0)

78 
	#__FAR


	)

79 
	#SPRINTF
 
•rötf


	)

80 
	#MEMSET
 
mem£t


	)

81 
	#MEMCPY
 
mem˝y


	)

82 
	#ATOI
 
©oi


	)

84 
	#__FAR
 
__Ár


	)

85 
	#SPRINTF
 
•rötf_f


	)

86 
	#MEMSET
 
mem£t_f


	)

87 
	#MEMCPY
 
mem˝y_f


	)

88 
	#ATOI
 
©oi_f


	)

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\process_sys_event.c

1 
	~<°dio.h
>

2 
	~<°rög.h
>

4 
	~"¥j_ty≥.h
"

5 
	~"timî.h
"

6 
	~"hÆ_£rül.h
"

7 
	~"tof.h
"

8 
	~"∑r£r.h
"

9 
	~"∑r£r_tof.h
"

10 
	~"¥o˚ss_sys_evít.h
"

13 (*
	tA˘i⁄_T
)();

14 
	s_sys_evít_


16 
U8
 
timîId
;

17 
A˘i⁄_T
 
pFun
;

18 
A˘i⁄_T
 
pFun_FCT
;

19 
A˘i⁄_T
 
pFun_EOL
;

20 } 
	tSysEvít_T
;

23 
	`Evt_1ms_H™dÀr
( );

24 
	`Evt_10ms_H™dÀr
( );

25 
	`Evt_100ms_H™dÀr
( );

26 
	`Evt_tof_H™dÀr
( );

28 c⁄° 
SysEvít_T
 
SysEvítLi°
[] =

31 { 
TIMER_ID_1MS
, 
Evt_1ms_H™dÀr
, 
NULL
, NULL },

32 { 
TIMER_ID_10MS
, 
Evt_10ms_H™dÀr
, 
NULL
, NULL },

33 { 
TIMER_ID_100MS
, 
Evt_100ms_H™dÀr
, 
NULL
, NULL },

34 { 
TIMER_ID_TOF
, 
Evt_tof_H™dÀr
, 
NULL
, NULL },

35 
	}
};

36 
	#SZ_LIST
 ( –
SysEvítLi°
 ) / –
SysEvít_T
 ) )

	)

38 
	$Pro˚ssEvítH™dÀr
( )

40 
U8
 
i
;

41 
A˘i⁄_T
 
fun
;

43  
i
 = 0; i < 
SZ_LIST
 ; i++ )

45 if–
	`IsExpúedTimî
–
SysEvítLi°
[ 
i
 ].
timîId
 ) =
TIMER_EXPIRE
 )

48 
	`DißbÀTimî
–
SysEvítLi°
[ 
i
 ].
timîId
 );

64 
fun
 = 
SysEvítLi°
[ 
i
 ].
pFun
;

68 if–
fun
 !
NULL
 )

70 
	`fun
();

74 
	}
}

76 
	$Evt_1ms_H™dÀr
( )

78 
	`SèπTimî
–
TIMER_ID_1MS
, 1);

81 
	}
}

84 
	$Evt_10ms_H™dÀr
( )

86 
	`SèπTimî
–
TIMER_ID_10MS
, 10);

88 
	`Pro˚ssToF
();

89 
	}
}

92 
	$Evt_100ms_H™dÀr
()

94 
	`SèπTimî
–
TIMER_ID_100MS
, 100);

96 
	}
}

99 
U8
 
	gthe_ønge_id
 = 0;

100 
U32
 
	gdbg_dñay
 = 0;

101 
U8
 
	gdbg_°¨t
 = 0;

102 
	$Evt_tof_H™dÀr
( )

104 if–
dbg_°¨t
 )

107 
	`SèπR™ge
–
the_ønge_id
++ );

109 if–
the_ønge_id
 >
MAX_TOF_ID
 )

111 
the_ønge_id
 = 0;

115 
	`SèπTimî
–
TIMER_ID_TOF
, 
dbg_dñay
 );

116 
	}
}

119 
	$TimîI§CÆlback
()

122 
	}
}

124 
	$InôSy°em
()

127 
	`HAL_InôComm
();

129 
	`Regi°îTimîISR
–
TimîI§CÆlback
 );

130 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\process_sys_event.h

1 #i‚de‡
__PROCESS_SYS_EVENT_H__


2 
	#__PROCESS_SYS_EVENT_H__


	)

4 
InôSy°em
();

6 
Pro˚ssEvítH™dÀr
();

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\timer\timer.c

1 #¥agm®
öãºu±
 
INTTM00
 
Ba£TimîI¡îru±


3 
	~"hw.h
"

4 
	~"timî.h
"

6 
	~<°rög.h
>

12 
	#HZ
 (1UL)

	)

14 
	s_timî_


16 
U8
 
	míabÀ
;

17 
U8
 
	mty≥
;

18 
U32
 
	mtime_out
;

19 } 
	ttimî_öfo_t
;

21 
LOCAL
 
timî_öfo_t
 
	gtimî_öfo
[ 
MAX_TIMER_ID_NUM
 ];

23 (*
pFunU£rISR
)(Ë
NULL
 ;

26 
	$InôTimî
( )

28 
	`MEMSET
–(
__FAR
 *)
timî_öfo
, 0, (Åimer_info) );

30 
	`R_TAU0_Ch™√l0_Sèπ
();

31 
	}
}

34 
	$SèπTimî
–
U8
 
id
, 
U32
 
time_out
 )

36 
	`INTS_BYTE_BASE_TIMER
();

38 
	`ENTER_CRITICAL_SECTION_TIMER
();

40 
timî_öfo
[ 
id
 ].
íabÀ
 = 1;

41 
timî_öfo
[ 
id
 ].
time_out
 =Åime_ouà/ 
HZ
;

42 #i‡(
HZ
 != 1UL)

43 if–(
time_out
 % 
HZ
Ë>(
U32
)5 )

45 
timî_öfo
[ 
id
 ].
time_out
++;

49 
	`EXIT_CRITICAL_SECTION_TIMER
();

51 
	}
}

53 
	$DißbÀTimî
–
U8
 
id
 )

55 
timî_öfo
[ 
id
 ].
íabÀ
 = 0;

56 
timî_öfo
[ 
id
 ].
time_out
 = (
U32
)-1;

57 
	}
}

59 
	$St›Timî
–
U8
 
id
 )

61 
	`DißbÀTimî
–
id
 );

62 
	}
}

65 
U8
 
	$IsExpúedTimî
–
U8
 
id
 )

67 
U32
 
time_out
;

68 
	`INTS_BYTE_BASE_TIMER
();

71 
	`ENTER_CRITICAL_SECTION_TIMER
();

72 
time_out
 = 
timî_öfo
[ 
id
 ].time_out;

73 
	`EXIT_CRITICAL_SECTION_TIMER
();

75 if–
timî_öfo
[ 
id
 ].
íabÀ
 == 0 )

77  
TIMER_DISABLE
;

80 if–
time_out
 > 0 )

82  
TIMER_NOT_EXPIRE
;

85  
TIMER_EXPIRE
;

86 
	}
}

89 
	$Upd©eTimî
( )

91 
U8
 
i
;

93  
i
 = 0 ; i < 
MAX_TIMER_ID_NUM
 ; i++ )

95 if–
timî_öfo
[ 
i
 ].
íabÀ
 == 0 )

100 if–
timî_öfo
[ 
i
 ].
time_out
 > 0 )

102 
timî_öfo
[ 
i
 ].
time_out
--;

105 
	}
}

109 
Regi°îTimîISR
–(*
pU£rISR
)() )

111 
pFunU£rISR
 = 
pU£rISR
;

112 
	}
}

116 
	$Ba£TimîI¡îru±
()

118 
	`Upd©eTimî
();

121 if–
pFunU£rISR
 !
NULL
 )

123 
	`pFunU£rISR
();

125 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\timer\timer.h

1 #i‚de‡
__TIMER_H__


2 
	#__TIMER_H__


	)

4 
	~"timî_id.h
"

6 
	#DELAY_MS
(
x
)

	)

7 
	#SEC
–
x
 ) ( ( x ) * 1000UL )

	)

10 
	#INTS_BYTE_BASE_TIMER
(Ë
_öts_timî_byã


	)

11 
	#MASK_BASE_TIMER
 
TMMK00


	)

12 
	#DISABLE_INT_MASK_BASE_TIMER
(Ëdÿ{ 
MASK_BASE_TIMER
 = 1; }0)

	)

13 
	#ENABLE_INT_MASK_BASE_TIMER
(Ëdÿ{ 
MASK_BASE_TIMER
 = 0; }0)

	)

15 
	#ENTER_CRITICAL_SECTION_TIMER
() \

17 
_öts_timî_byã
 = 
MASK_BASE_TIMER
; \

18 
	`DISABLE_INT_MASK_BASE_TIMER
(); \

19 }0)

	)

21 
	#EXIT_CRITICAL_SECTION_TIMER
() \

23 
MASK_BASE_TIMER
 = 
_öts_timî_byã
; \

24 } 0)

	)

27 
InôTimî
( );

29 
SèπTimî
–
U8
 
id
, 
U32
 
time_out
 );

31 
DißbÀTimî
–
U8
 
id
 );

33 
St›Timî
–
U8
 
id
 );

35 
	#TIMER_EXPIRE
 0

	)

36 
	#TIMER_NOT_EXPIRE
 1

	)

37 
	#TIMER_DISABLE
 2

	)

38 
U8
 
IsExpúedTimî
–U8 
id
 );

42 
Regi°îTimîISR
–(*
pU£rISR
)() );

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\timer\timer_id.h

1 #i‚de‡
__TIMER_ID_H__


2 
	#__TIMER_ID_H__


	)

7 
	mTIMER_ID_COMM_UART_1_RX
,

8 
	mTIMER_ID_COMM_UART_1_TX
,

10 
	mTIMER_ID_TOF
,

11 
	mTIMER_ID_1MS
,

12 
	mTIMER_ID_10MS
,

13 
	mTIMER_ID_100MS
,

14 
	mTIMER_ID_1SEC
,

16 
	mMAX_TIMER_ID_NUM


19 
	#TIMER_ID_ADC_INTERVAL
 10UL

	)

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\util.c

1 
	~"mcu.h
"

2 
	~"utû.h
"

3 
	~"hw.h
"

5 
I16
 
	$GëMö
–
I16
 
x
, I16 
y
 )

7 if–
x
 > 
y
 )

9  
y
;

12  
x
;

13 
	}
}

15 
I16
 
	$GëMax
–
I16
 
x
, I16 
y
 )

17 if–
x
 > 
y
 )

19  
x
;

22  
y
;

23 
	}
}

26 
U8
 
	$Hex2Dec
(
U8
 
mu8Hex
)

28 
U8
 
mu8Dec
;

30 
mu8Dec
 = (
mu8Hex
 & 0x0F);

31 
mu8Dec
 +((
mu8Hex
 & 0xF0) >> 4) * 10;;

33  
mu8Dec
;

34 
	}
}

37 
U8
 
	$Dec2Hex
(
U8
 
mu8Dec
)

39 
U8
 
mu8Hex
;

41 
mu8Hex
 = 
mu8Dec
 % 10;

42 
mu8Hex
 +(
mu8Dec
 / 10) * 16;

44  
mu8Hex
;

45 
	}
}

47 
U8
 
	$C⁄vAsc2Byã
(
U8
 
mu8Uµî
, U8 
mu8Lowî
 )

49 
U8
 
mu8Temp
 = 0;

50 
U8
 
mu8VÆ
 = 0;

54 if–
mu8Uµî
 > '9' )

56 
mu8Temp
 = 
mu8Uµî
 - '7';

60 
mu8Temp
 = 
mu8Uµî
 - '0';

62 
mu8VÆ
 = 
mu8Temp
 * 16;

65 if–
mu8Lowî
 > '9' )

67 
mu8Temp
 = 
mu8Lowî
 - '7';

71 
mu8Temp
 = 
mu8Lowî
 - '0';

73 
mu8VÆ
 +
mu8Temp
;

76  
mu8VÆ
;

77 
	}
}

79 
	$Dñay_US
–
U16
 
us
 )

81 
	`R_WDT_Re°¨t
();

83  
us
-- )

85 
	`NOP
(); NOP(); NOP(); NOP(); NOP(); NOP(); NOP(); NOP(); NOP();

86 
	`NOP
(); NOP(); NOP(); NOP(); NOP(); NOP(); NOP(); NOP(); NOP();

87 
	`NOP
(); NOP(); NOP(); NOP(); NOP(); NOP(); NOP(); NOP(); NOP();

89 
	}
}

91 
U16
 
	$ByãOrdîC⁄v
–
U16
 
_§c
 )

93 
U16
 
h_to_l
 = 
_§c
 >> 8;

94 
U16
 
l_to_h
 = ( 
_§c
 & 0x00FF ) << 8;

96  ( 
l_to_h
 | 
h_to_l
 );

97 
	}
}

99 
	$Dñay_MS
–
U16
 
ms
 )

101 
U16
 
i
;

102 
U8
 
j
;

104  
i
 = 0 ; i < 
ms
 ; i++ )

106  
j
 = 0; j < 4 ; j++ )

108 
	`Dñay_US
( 230 );

111 
	}
}

113 
	$Re£t
()

119 
	}
}

121 
U8
 
	$CheckLimôVÆue
(
U8
 
mu8VÆ
, U8 
mu8Mö
, U8 
mu8Max
, U8 
mu8Inô
)

123 if–
mu8VÆ
 < 
mu8Mö
 || mu8VÆ > 
mu8Max
 )

125  
mu8Inô
;

128  
mu8VÆ
;

129 
	}
}

	@D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\util.h

1 #i‚de‡
__UTIL_H__


2 
	#__UTIL_H__


	)

4 
	~"¥j_ty≥.h
"

6 
	#GET_HIGH_BYTE
(
vÆ
Ë(
U8
)(((vÆ)&0xFF00Ë>> 8)

	)

7 
	#GET_LOW_BYTE
(
vÆ
Ë(
U8
)((vÆ)&0x00FF)

	)

8 
	#GET_UINT_WORD
(
lb
, 
hb
Ë((((
U16
)hb)<<8)|lb)

	)

10 
	#GET_32_BYTE_8
(
vÆ
Ë(
U8
)(((vÆ)&0x000000FF))

	)

11 
	#GET_32_BYTE_16
(
vÆ
Ë(
U8
)(((vÆ)&0x0000FF00)>>8)

	)

12 
	#GET_32_BYTE_24
(
vÆ
Ë(
U8
)(((vÆ)&0x00FF0000)>>16)

	)

13 
	#GET_32_BYTE_32
(
vÆ
Ë(
U8
)(((vÆ)&0xFF000000)>>24)

	)

14 
	#GET_UINT_WORD_32
(
b32
, 
b24
, 
b16
, 
b8
) \

16 –((
U32
)
b32
)<<24 ) |\

17 –((
U32
)
b24
)<<16 ) |\

18 –((
U32
)
b16
)<<8 ) |\

19 –(
U32
)
b8
) \

20 )

	)

22 
	#SET_BIT_BYTE
(
vÆ
,
bô
Ëdo{ vÆ |(
U8
)(bô); }0)

	)

23 
	#CLEAR_BIT_BYTE
(
vÆ
,
bô
Ëdo{ vÆ &(
U8
)(~bô); }0)

	)

25 
	#SET_BIT_WORD
(
vÆ
,
bô
Ëdo{ vÆ |(
U16
)(bô); }0)

	)

26 
	#CLEAR_BIT_WORD
(
vÆ
,
bô
Ëdo{ vÆ &(
U16
)(~bô); }0)

	)

28 
	#DOWN_COUNT
(
vÆ
) \

30 if–
vÆ
 != 0 ) { val--; } \

31 }0)

	)

33 
	#DOWN_COUNT_RELOAD
(
vÆ
,
ªlﬂd
) \

35 if–
vÆ
 != 0 ){ val--;}\

36 { 
vÆ
=
ªlﬂd
;} \

37 }0)

	)

39 
I16
 
GëMö
–I16 
x
, I16 );

40 
I16
 
GëMax
–I16 
x
, I16 
y
 );

42 
U8
 
Hex2Dec
(U8 
mu8Hex
);

43 
U8
 
Dec2Hex
(U8 
mu8Dec
);

45 
U8
 
C⁄vAsc2Byã
(U8 
mu8Uµî
, U8 
mu8Lowî
 );

46 
U16
 
ByãOrdîC⁄v
–U16 
_§c
 );

48 
Dñay_US
–
U16
 
us
 );

49 
Dñay_MS
–
U16
 
ms
 );

51 
Re£t
();

56 
U8
 
CheckLimôVÆue
(U8 
mu8VÆ
, U8 
mu8Mö
, U8 
mu8Max
, U8 
mu8Inô
);

	@config.h

1 #i‚de‡
__CONFIG_H__


2 
	#__CONFIG_H__


	)

9 
	#CONFIG_TEST
 0

10 
	#CONFIG_MMI
 0

11 
	#CONFIG_TEST_LED
 0

12 
	#CONFIG_TEST_SAVING
 0

13 
	#CONFIG_TEST_TEMP_READ
 0

14 
	#CONFIG_TEST_FILTER
 0

15 

	)

17 
	#CONFIG_TEST_FLOW_METER
 1

	)

20 
	#CONFIG_ERR_ALL
 1

	)

23 
	#DEBUG_COMM
 1

	)

26 
	#VERSION
 1

	)

	@prj_type.h

1 #i‚de‡
__PRJ_TYPE_H__


2 
	#__PRJ_TYPE_H__


	)

4 
	~"c⁄fig.h
"

5 
	~<°dio.h
>

6 
	~<°rög.h
>

8 #i‚de‡
__TYPEDEF_COWAY__


9 
	#__TYPEDEF_COWAY__


	)

10 
	tU8
;

11 sig√d 
	tI8
;

12 
	tU16
;

13 sig√d 
	tI16
;

14 
	tU32
;

15 sig√d 
	tI32
;

16 
	tF32
;

17 
	tBOOL_T
;

18 
	tTIME_T
;

20 
	tTEMP_T
;

21 
	tRPS_T
;

24 
	tuöt8_t
;

25 sig√d 
	töt8_t
;

26 
	tuöt16_t
;

27 sig√d 
	töt16_t
;

28 
	tuöt32_t
;

29 sig√d 
	töt32_t
;

33 
	#__DEBUG__
 1

	)

35 #i‡
__DEBUG__


36 
	#LOCAL


	)

38 
	#LOCAL
 

	)

41 #ifde‡
NULL


42 #unde‡
NULL


45 
	#NULL
 ((*)0)

	)

47 #ifde‡
TRUE


48 #unde‡
TRUE


51 
	#TRUE
 1

	)

53 #ifde‡
FALSE


54 #unde‡
FALSE


57 
	#FALSE
 0

	)

60 #ifde‡
ON


61 #unde‡
ON


64 
	#ON
 1

	)

66 #ifde‡
OFF


67 #unde‡
OFF


70 
	#OFF
 0

	)

72 
	#HIGH
 1

	)

73 
	#LOW
 0

	)

77 #i‡(
CONFIG_FOTA_LIB
 == 0)

78 
	#__FAR


	)

79 
	#SPRINTF
 
•rötf


	)

80 
	#MEMSET
 
mem£t


	)

81 
	#MEMCPY
 
mem˝y


	)

82 
	#ATOI
 
©oi


	)

84 
	#__FAR
 
__Ár


	)

85 
	#SPRINTF
 
•rötf_f


	)

86 
	#MEMSET
 
mem£t_f


	)

87 
	#MEMCPY
 
mem˝y_f


	)

88 
	#ATOI
 
©oi_f


	)

	@process_sys_event.h

1 #i‚de‡
__PROCESS_SYS_EVENT_H__


2 
	#__PROCESS_SYS_EVENT_H__


	)

4 
InôSy°em
();

6 
Pro˚ssEvítH™dÀr
();

	@util.h

1 #i‚de‡
__UTIL_H__


2 
	#__UTIL_H__


	)

4 
	~"¥j_ty≥.h
"

6 
	#GET_HIGH_BYTE
(
vÆ
Ë(
U8
)(((vÆ)&0xFF00Ë>> 8)

	)

7 
	#GET_LOW_BYTE
(
vÆ
Ë(
U8
)((vÆ)&0x00FF)

	)

8 
	#GET_UINT_WORD
(
lb
, 
hb
Ë((((
U16
)hb)<<8)|lb)

	)

10 
	#GET_32_BYTE_8
(
vÆ
Ë(
U8
)(((vÆ)&0x000000FF))

	)

11 
	#GET_32_BYTE_16
(
vÆ
Ë(
U8
)(((vÆ)&0x0000FF00)>>8)

	)

12 
	#GET_32_BYTE_24
(
vÆ
Ë(
U8
)(((vÆ)&0x00FF0000)>>16)

	)

13 
	#GET_32_BYTE_32
(
vÆ
Ë(
U8
)(((vÆ)&0xFF000000)>>24)

	)

14 
	#GET_UINT_WORD_32
(
b32
, 
b24
, 
b16
, 
b8
) \

16 –((
U32
)
b32
)<<24 ) |\

17 –((
U32
)
b24
)<<16 ) |\

18 –((
U32
)
b16
)<<8 ) |\

19 –(
U32
)
b8
) \

20 )

	)

22 
	#SET_BIT_BYTE
(
vÆ
,
bô
Ëdo{ vÆ |(
U8
)(bô); }0)

	)

23 
	#CLEAR_BIT_BYTE
(
vÆ
,
bô
Ëdo{ vÆ &(
U8
)(~bô); }0)

	)

25 
	#SET_BIT_WORD
(
vÆ
,
bô
Ëdo{ vÆ |(
U16
)(bô); }0)

	)

26 
	#CLEAR_BIT_WORD
(
vÆ
,
bô
Ëdo{ vÆ &(
U16
)(~bô); }0)

	)

28 
	#DOWN_COUNT
(
vÆ
) \

30 if–
vÆ
 != 0 ) { val--; } \

31 }0)

	)

33 
	#DOWN_COUNT_RELOAD
(
vÆ
,
ªlﬂd
) \

35 if–
vÆ
 != 0 ){ val--;}\

36 { 
vÆ
=
ªlﬂd
;} \

37 }0)

	)

39 
I16
 
GëMö
–I16 
x
, I16 );

40 
I16
 
GëMax
–I16 
x
, I16 
y
 );

42 
U8
 
Hex2Dec
(U8 
mu8Hex
);

43 
U8
 
Dec2Hex
(U8 
mu8Dec
);

45 
U8
 
C⁄vAsc2Byã
(U8 
mu8Uµî
, U8 
mu8Lowî
 );

46 
U16
 
ByãOrdîC⁄v
–U16 
_§c
 );

48 
Dñay_US
–
U16
 
us
 );

49 
Dñay_MS
–
U16
 
ms
 );

51 
Re£t
();

56 
U8
 
CheckLimôVÆue
(U8 
mu8VÆ
, U8 
mu8Mö
, U8 
mu8Max
, U8 
mu8Inô
);

	@
1
.
0
70
6288
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\comm.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\comm.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\crc16.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\crc16.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_debug.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_debug.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_eol.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_eol.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_tof.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\comm\parser_tof.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\config.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\eeprom\eeprom.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\eeprom\eeprom.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_room_level.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_room_level.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp_cold_water.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp_cold_water.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp_hot_water.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\err_temp_hot_water.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\error.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\error.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\process_error.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\error\process_error.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\fct.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\fct.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\key_fct_handler.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\key_fct_handler.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\process_fct.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\fct\process_fct.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap04vt_api.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap04vt_api.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap04vt_firmware.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap04vt_firmware.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap_i2c.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\gp2ap_i2c.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\tof.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt\tof.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap04vt_api.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap04vt_api.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap04vt_firmware.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap04vt_firmware.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap_i2c.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\gp2ap_i2c.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\tof.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\gp2ap04vt_cup_detect\tof.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_eeprom.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_eeprom.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_i2c.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_i2c.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_serial.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hal_serial.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\hw.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\hal\mcu.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\main.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\prj_type.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\process_sys_event.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\process_sys_event.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\timer\timer.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\timer\timer.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\timer\timer_id.h
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\util.c
D:\Work\project_svn\2024\TECH_PILLOW_PACK\Program\MainMulti_V100_7\Source\util.h
config.h
prj_type.h
process_sys_event.h
util.h
